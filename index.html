<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Immobilier Pro+ - Expert IA 2024</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --border-radius: 15px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            cursor: pointer;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .metric-card p {
            color: #666;
            font-weight: 500;
        }

        .ville-stats {
            background: var(--light-color);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .ville-stats h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .ville-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .ville-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .ville-item strong {
            display: block;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .ville-item span {
            color: #666;
            font-size: 0.8rem;
        }

        .analysis-section {
            margin-top: 30px;
        }

        .ai-score {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--border-radius);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 6px solid;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            font-weight: bold;
        }

        .recommendations {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recommendation-item {
            padding: 15px;
            border-radius: 10px;
            line-height: 1.6;
            border-left: 5px solid;
        }

        .recommendation-item.success {
            background: #d4edda;
            color: #155724;
            border-color: var(--success-color);
        }

        .recommendation-item.warning {
            background: #fff3cd;
            color: #856404;
            border-color: var(--warning-color);
        }

        .recommendation-item.error {
            background: #f8d7da;
            color: #721c24;
            border-color: var(--danger-color);
        }

        .recommendation-item.info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: var(--info-color);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark-color);
            text-align: center;
            font-size: 1.2rem;
        }

        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .scenario-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .error { border-color: var(--danger-color) !important; background-color: #fff5f5; }
        .warning { border-color: var(--warning-color) !important; background-color: #fffdf0; }
        .success { border-color: var(--success-color) !important; background-color: #f0fff4; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .scenarios-grid {
                grid-template-columns: 1fr;
            }
            
            .ville-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .ai-score {
                flex-direction: column;
                text-align: center;
            }
        }

        .hidden {
            display: none;
        }

        .animated {
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-home"></i> Simulateur Immobilier Pro+</h1>
            <p>Analyse avanc√©e avec IA - Expert en investissement immobilier 2024</p>
        </div>

        <div class="main-content">
            <!-- Formulaire -->
            <div class="card">
                <h2><i class="fas fa-calculator"></i> Configuration</h2>
                
                <div class="form-group">
                    <label for="ville" class="tooltip" data-tooltip="Choix de la ville pour donn√©es locales pr√©cises">
                        <i class="fas fa-map-marker-alt"></i> Ville *
                    </label>
                    <select id="ville" required onchange="afficherRecapVille()">
                        <option value="">Choisir une ville</option>
                        <option value="caen">Caen</option>
                        <option value="cherbourg">Cherbourg-en-Cotentin</option>
                        <option value="herouville">H√©rouville-Saint-Clair</option>
                        <option value="lisieux">Lisieux</option>
                        <option value="falaise">Falaise</option>
                        <option value="carentan">Carentan-les-Marais</option>
                        <option value="vire">Vire-Normandie</option>
                        <option value="bayeux">Bayeux</option>
                        <option value="coutances">Coutances</option>
                        <option value="granville">Granville</option>
                    </select>
                </div>

                <!-- R√©cap ville -->
                <div id="villeRecap" class="hidden"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prix" class="tooltip" data-tooltip="Prix de vente hors frais">
                            <i class="fas fa-euro-sign"></i> Prix d'achat (‚Ç¨)
                        </label>
                        <input type="number" id="prix" placeholder="200000" min="0" oninput="calculerFraisNotaireAuto()">
                    </div>
                    
                    <div class="form-group">
                        <label for="typeAchat" class="tooltip" data-tooltip="Type d'achat pour calcul frais de notaire">
                            <i class="fas fa-building"></i> Type d'achat
                        </label>
                        <select id="typeAchat" onchange="calculerFraisNotaireAuto()">
                            <option value="ancien">Ancien (7-8%)</option>
                            <option value="neuf">Neuf (2-3%)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fraisNotaire" class="tooltip" data-tooltip="Frais de notaire calcul√©s automatiquement">
                            <i class="fas fa-scale-balanced"></i> Frais de notaire (‚Ç¨)
                        </label>
                        <input type="number" id="fraisNotaire" placeholder="16000" min="0" readonly>
                        <small id="fraisNotaireInfo" style="color: #666;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="fraisAgence" class="tooltip" data-tooltip="Frais d'agence (5-8% du prix)">
                            <i class="fas fa-handshake"></i> Frais d'agence (‚Ç¨)
                        </label>
                        <input type="number" id="fraisAgence" placeholder="12000" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="surface" class="tooltip" data-tooltip="Surface habitable en m¬≤">
                            <i class="fas fa-ruler"></i> Surface (m¬≤)
                        </label>
                        <input type="number" id="surface" placeholder="80" min="1" oninput="estimerLoyerAuto()">
                    </div>
                    
                    <div class="form-group">
                        <label for="travaux" class="tooltip" data-tooltip="Budget travaux de r√©novation">
                            <i class="fas fa-hammer"></i> Travaux (‚Ç¨)
                        </label>
                        <input type="number" id="travaux" placeholder="15000" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="mobilier" class="tooltip" data-tooltip="Co√ªt d'ameublement (meubl√©)">
                            <i class="fas fa-couch"></i> Mobilier (‚Ç¨)
                        </label>
                        <input type="number" id="mobilier" placeholder="8000" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="apport" class="tooltip" data-tooltip="Votre apport personnel">
                            <i class="fas fa-piggy-bank"></i> Apport (‚Ç¨)
                        </label>
                        <input type="number" id="apport" placeholder="50000" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="typeLocation" class="tooltip" data-tooltip="Type de location pour estimation loyer">
                        <i class="fas fa-key"></i> Type de location
                    </label>
                    <select id="typeLocation" onchange="estimerLoyerAuto()">
                        <option value="vide">Location vide</option>
                        <option value="meublee">Location meubl√©e (+15%)</option>
                        <option value="colocation">Colocation (+25%)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="loyerMensuel" class="tooltip" data-tooltip="Loyer mensuel hors charges">
                        <i class="fas fa-money-bill-wave"></i> Loyer mensuel (‚Ç¨)
                    </label>
                    <input type="number" id="loyerMensuel" placeholder="850" min="0">
                    <div id="suggestionLoyer"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tauxInteret" class="tooltip" data-tooltip="Taux d'int√©r√™t du cr√©dit immobilier">
                            <i class="fas fa-percentage"></i> Taux d'int√©r√™t (%)
                        </label>
                        <input type="number" id="tauxInteret" placeholder="4.2" step="0.1" min="0" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="dureeEmprunt" class="tooltip" data-tooltip="Dur√©e du pr√™t en ann√©es">
                            <i class="fas fa-calendar-alt"></i> Dur√©e (ann√©es)
                        </label>
                        <input type="number" id="dureeEmprunt" placeholder="20" min="5" max="30">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="charges" class="tooltip" data-tooltip="Charges mensuelles (copropri√©t√©, taxe fonci√®re...)">
                            <i class="fas fa-receipt"></i> Charges mensuelles (‚Ç¨)
                        </label>
                        <input type="number" id="charges" placeholder="150" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="vacanceLocative" class="tooltip" data-tooltip="Pourcentage de vacance locative estim√©">
                            <i class="fas fa-calendar-times"></i> Vacance locative (%)
                        </label>
                        <input type="number" id="vacanceLocative" placeholder="5" min="0" max="50" step="0.5">
                    </div>
                </div>

                <button type="button" class="btn" onclick="calculer()" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-calculator"></i> Calculer la rentabilit√©
                </button>
            </div>

            <!-- R√©sultats -->
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> R√©sultats</h2>
                <div id="resultats" class="hidden">
                    <div id="metriques"></div>
                    <div id="analyseIA"></div>
                </div>
                <div id="messageVide" style="text-align: center; color: #666; padding: 40px;">
                    <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                    <p>Remplissez le formulaire et cliquez sur "Calculer" pour voir les r√©sultats</p>
                </div>
            </div>
        </div>

        <!-- Graphiques et analyses -->
        <div id="analysesAvancees" class="hidden">
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">üìà √âvolution du patrimoine</div>
                    <canvas id="chartPatrimoine"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">üí∞ Cash-flow mensuel</div>
                    <canvas id="chartCashflow"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">üéØ R√©partition des rendements</div>
                    <canvas id="chartRendements"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">üîÆ Projection 10 ans</div>
                    <canvas id="chartProjection"></canvas>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-crystal-ball"></i> Projections patrimoniales</h2>
                <div class="scenarios-grid">
                    <div class="scenario-card">
                        <h4 style="color: var(--success-color); margin-bottom: 15px;">üòä Optimiste</h4>
                        <div id="scenarioOptimiste"></div>
                    </div>
                    <div class="scenario-card">
                        <h4 style="color: var(--info-color); margin-bottom: 15px;">üòê R√©aliste</h4>
                        <div id="scenarioRealiste"></div>
                    </div>
                    <div class="scenario-card">
                        <h4 style="color: var(--danger-color); margin-bottom: 15px;">üò∞ Pessimiste</h4>
                        <div id="scenarioPessimiste"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-download"></i> Export & Outils</h2>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="exporterPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-secondary" onclick="sauvegarderLocalement()">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button class="btn btn-secondary" onclick="chargerDonneesSauvegardees()">
                        <i class="fas fa-upload"></i> Charger
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de donn√©es enrichie des villes normandes
        const villesData = {
            caen: {
                nom: "Caen",
                prixM2Moyen: 2850,
                prixM2Min: 2200,
                prixM2Max: 4200,
                loyerM2Moyen: 13.5,
                loyerM2Min: 11,
                loyerM2Max: 18,
                population: 105000,
                evolutionPrix: 3.2,
                tauxVacance: 4.5,
                rendementMoyen: 5.2,
                marche: "Tr√®s dynamique - Universit√© + Pr√©fecture",
                transport: "Tramway, trains r√©gionaux",
                attractivite: "Tr√®s forte",
                croissanceDemographique: 1.1,
                coeffMeublee: 1.15,
                coeffColocation: 1.25
            },
            cherbourg: {
                nom: "Cherbourg-en-Cotentin",
                prixM2Moyen: 2394,
                prixM2Min: 1646,
                prixM2Max: 3924,
                loyerM2Moyen: 15.9,
                loyerM2Min: 12.8,
                loyerM2Max: 19.1,
                population: 79000,
                evolutionPrix: 2.5,
                tauxVacance: 4,
                rendementMoyen: 6.8,
                marche: "Stable - Port militaire",
                transport: "Trains, ferry Angleterre/Irlande",
                attractivite: "Mod√©r√©e",
                croissanceDemographique: 0.3,
                coeffMeublee: 1.25,
                coeffColocation: 1.40
            },
            herouville: {
                nom: "H√©rouville-Saint-Clair",
                prixM2Moyen: 2399,
                prixM2Min: 1543,
                prixM2Max: 3327,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                population: 21000,
                evolutionPrix: 2.8,
                tauxVacance: 3,
                rendementMoyen: 5.8,
                marche: "En d√©veloppement - Proche Caen",
                transport: "Bus vers Caen, projet tramway",
                attractivite: "Forte",
                croissanceDemographique: 1.5,
                coeffMeublee: 1.30,
                coeffColocation: 1.45
            },
            lisieux: {
                nom: "Lisieux",
                prixM2Moyen: 1906,
                prixM2Min: 1310,
                prixM2Max: 2803,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                population: 20800,
                evolutionPrix: 2.1,
                tauxVacance: 5,
                rendementMoyen: 6.2,
                marche: "Stable - Tourisme religieux",
                transport: "Trains Paris/Caen",
                attractivite: "Mod√©r√©e",
                croissanceDemographique: 0.1,
                coeffMeublee: 1.28,
                coeffColocation: 1.40
            },
            falaise: {
                nom: "Falaise",
                prixM2Moyen: 1790,
                prixM2Min: 1155,
                prixM2Max: 2406,
                loyerM2Moyen: 11.0,
                loyerM2Min: 8.8,
                loyerM2Max: 13.2,
                population: 8500,
                evolutionPrix: 1.5,
                tauxVacance: 6,
                rendementMoyen: 6.5,
                marche: "Calme - Ville historique",
                transport: "Bus vers Caen",
                attractivite: "Faible",
                croissanceDemographique: -0.2,
                coeffMeublee: 1.22,
                coeffColocation: 1.35
            },
            carentan: {
                nom: "Carentan-les-Marais",
                prixM2Moyen: 1629,
                prixM2Min: 1069,
                prixM2Max: 2329,
                loyerM2Moyen: 11.7,
                loyerM2Min: 9.3,
                loyerM2Max: 14.0,
                population: 6100,
                evolutionPrix: 1.8,
                tauxVacance: 7,
                rendementMoyen: 7.1,
                marche: "Tourisme - D√©barquement",
                transport: "Trains r√©gionaux",
                attractivite: "Saisonni√®re",
                croissanceDemographique: 0.5,
                coeffMeublee: 1.20,
                coeffColocation: 1.32
            },
            vire: {
                nom: "Vire-Normandie",
                prixM2Moyen: 1464,
                prixM2Min: 977,
                prixM2Max: 1948,
                loyerM2Moyen: 10.5,
                loyerM2Min: 8.4,
                loyerM2Max: 12.6,
                population: 17500,
                evolutionPrix: 1.2,
                tauxVacance: 8,
                rendementMoyen: 7.3,
                marche: "Rural - Prix attractifs",
                transport: "Bus, voiture n√©cessaire",
                attractivite: "Faible",
                croissanceDemographique: -0.1,
                coeffMeublee: 1.18,
                coeffColocation: 1.28
            },
            bayeux: {
                nom: "Bayeux",
                prixM2Moyen: 2100,
                prixM2Min: 1500,
                prixM2Max: 3200,
                loyerM2Moyen: 12.5,
                loyerM2Min: 10,
                loyerM2Max: 16,
                population: 13000,
                evolutionPrix: 2.3,
                tauxVacance: 5.5,
                rendementMoyen: 6.0,
                marche: "Touristique - Tapisserie + D-Day",
                transport: "Trains vers Caen",
                <div style="font-size: 0.85rem; line-height: 1.8; color: #555;">
                    ‚Ä¢ Prix: +${(croissancePrix * 100).toFixed(1)}%/an<br>
                    ‚Ä¢ Loyers: +2.5%/an<br>
                    ‚Ä¢ Vacance: 5%<br>
                    ‚Ä¢ <strong>Patrimoine final: ${realiste.patrimoineFinal.toLocaleString()}‚Ç¨</strong>
                </div>
            `;
            
            document.getElementById('scenarioPessimiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--warning-color);">
                        +${pessimiste.gainTotal.toLocaleString()}‚Ç¨
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8; color: #555;">
                    ‚Ä¢ Prix: +${(Math.max(0, croissancePrix - 0.015) * 100).toFixed(1)}%/an<br>
                    ‚Ä¢ Loyers: +1.5%/an<br>
                    ‚Ä¢ Vacance: 8%<br>
                    ‚Ä¢ <strong>Patrimoine final: ${pessimiste.patrimoineFinal.toLocaleString()}‚Ç¨</strong>
                </div>
            `;
        }

        function calculerScenario(resultats, croissancePrix, croissanceLoyer, tauxVacance) {
            const annees = 10;
            let patrimoine = resultats.coutTotal;
            let loyersAnnuels = resultats.loyersAnnuels;
            let cashflowTotal = 0;
            
            for (let annee = 1; annee <= annees; annee++) {
                patrimoine *= (1 + croissancePrix);
                loyersAnnuels *= (1 + croissanceLoyer);
                
                const loyersReels = loyersAnnuels * (1 - tauxVacance);
                const cashflowAnnuel = loyersReels - resultats.chargesAnnuelles - (resultats.mensualite * 12);
                cashflowTotal += cashflowAnnuel;
            }
            
            const gainTotal = (patrimoine - resultats.coutTotal) + cashflowTotal;
            
            return {
                patrimoineFinal: Math.round(patrimoine),
                gainTotal: Math.round(gainTotal),
                cashflowTotal: Math.round(cashflowTotal)
            };
        }

        function genererGraphiques(resultats) {
            // D√©truire les graphiques existants
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // 1. Graphique de rentabilit√© compar√©e
            const ctx1 = document.getElementById('chartRentabilite').getContext('2d');
            const donneesVille = villesData[resultats.ville];
            
            charts.rentabilite = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Votre projet', 'Moyenne locale', 'Livret A', 'Assurance vie'],
                    datasets: [{
                        label: 'Rendement (%)',
                        data: [
                            resultats.rentabiliteBrute,
                            donneesVille.rendementMoyen,
                            3.0,
                            2.8
                        ],
                        backgroundColor: [
                            'var(--primary-color)',
                            'var(--info-color)',
                            'var(--warning-color)',
                            'var(--secondary-color)'
                        ],
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Comparaison des rendements'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // 2. Graphique d'√©volution du patrimoine
            const ctx2 = document.getElementById('chartEvolution').getContext('2d');
            const evolutionData = genererDonneesEvolution(resultats);
            
            charts.evolution = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: evolutionData.labels,
                    datasets: [{
                        label: 'Valeur du bien',
                        data: evolutionData.valeurBien,
                        borderColor: 'var(--success-color)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Capital restant d√ª',
                        data: evolutionData.capitalRestant,
                        borderColor: 'var(--danger-color)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Patrimoine net',
                        data: evolutionData.patrimoineNet,
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '√âvolution du patrimoine sur 25 ans'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // 3. Graphique cash-flow cumul√©
            const ctx3 = document.getElementById('chartCashflow').getContext('2d');
            
            charts.cashflow = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: evolutionData.labels.slice(0, 10), // 10 premi√®res ann√©es
                    datasets: [{
                        label: 'Cash-flow annuel',
                        data: evolutionData.cashflowAnnuel.slice(0, 10),
                        backgroundColor: resultats.cashflowAnnuel >= 0 ? 'var(--success-color)' : 'var(--danger-color)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cash-flow annuel (10 premi√®res ann√©es)'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });

            // 4. Graphique r√©partition de l'investissement
            const ctx4 = document.getElementById('chartRepartition').getContext('2d');
            
            charts.repartition = new Chart(ctx4, {
                type: 'doughnut',
                data: {
                    labels: ['Prix d\'achat', 'Frais de notaire', 'Frais d\'agence', 'Travaux', 'Mobilier'],
                    datasets: [{
                        data: [
                            resultats.prix,
                            resultats.fraisNotaire,
                            resultats.fraisAgence,
                            resultats.travaux,
                            resultats.mobilier
                        ],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4ecdc4'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `R√©partition de l'investissement (${resultats.coutTotal.toLocaleString()}‚Ç¨)`
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function genererDonneesEvolution(resultats) {
            const annees = 25;
            const labels = [];
            const valeurBien = [];
            const capitalRestant = [];
            const patrimoineNet = [];
            const cashflowAnnuel = [];
            const donneesVille = villesData[resultats.ville];
            const croissancePrix = donneesVille.evolutionPrix / 100;
            
            // Calculs d'amortissement
            const tauxMensuel = resultats.tauxInteret / 100 / 12;
            const nbMensualites = resultats.dureeEmprunt * 12;
            let capitalActuel = resultats.montantEmprunte;
            
            for (let annee = 0; annee <= annees; annee++) {
                labels.push(annee === 0 ? 'Achat' : `An ${annee}`);
                
                // Valeur du bien avec appr√©ciation
                const valeur = resultats.prix * Math.pow(1 + croissancePrix, annee);
                valeurBien.push(Math.round(valeur));
                
                // Capital restant d√ª
                if (annee === 0) {
                    capitalRestant.push(resultats.montantEmprunte);
                } else if (annee <= resultats.dureeEmprunt) {
                    // Calcul du capital restant apr√®s n ann√©es
                    const mensualitesEcoulees = annee * 12;
                    const facteur = Math.pow(1 + tauxMensuel, nbMensualites - mensualitesEcoulees);
                    capitalActuel = resultats.montantEmprunte * (facteur - 1) / (Math.pow(1 + tauxMensuel, nbMensualites) - 1);
                    capitalRestant.push(Math.round(Math.max(0, capitalActuel)));
                } else {
                    capitalRestant.push(0);
                }
                
                // Patrimoine net
                patrimoineNet.push(Math.round(valeur - capitalRestant[capitalRestant.length - 1]));
                
                // Cash-flow annuel (avec croissance des loyers)
                if (annee > 0) {
                    const loyersAnnee = resultats.loyersReels * Math.pow(1.025, annee); // +2.5%/an
                    const chargesAnnee = resultats.chargesAnnuelles * Math.pow(1.02, annee); // +2%/an
                    const creditAnnee = annee <= resultats.dureeEmprunt ? resultats.mensualite * 12 : 0;
                    cashflowAnnuel.push(Math.round(loyersAnnee - chargesAnnee - creditAnnee));
                }
            }
            
            return {
                labels,
                valeurBien,
                capitalRestant,
                patrimoineNet,
                cashflowAnnuel
            };
        }

        // Fonctions d'export et utilitaires
        function exporterPDF() {
            // V√©rifier si des r√©sultats existent
            if (document.getElementById('resultats').classList.contains('hidden')) {
                alert('‚ö†Ô∏è Veuillez d\'abord effectuer un calcul avant d\'exporter.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // R√©cup√©rer les donn√©es du formulaire
            const donnees = {
                ville: document.getElementById('ville').value,
                prix: parseFloat(document.getElementById('prix').value),
                surface: parseFloat(document.getElementById('surface').value),
                loyerMensuel: parseFloat(document.getElementById('loyerMensuel').value),
                apport: parseFloat(document.getElementById('apport').value)
            };
            
            const villeInfo = villesData[donnees.ville];
            const dateExport = new Date().toLocaleDateString('fr-FR');
            
            // En-t√™te
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('RAPPORT D\'ANALYSE IMMOBILI√àRE', 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`G√©n√©r√© le ${dateExport} - Simulateur Pro+`, 20, 40);
            
            // Informations du bien
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('üìç CARACT√âRISTIQUES DU BIEN', 20, 60);
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            let yPos = 75;
            
            const infoBien = [
                `Ville: ${villeInfo.nom}`,
                `Prix d'achat: ${donnees.prix.toLocaleString()} ‚Ç¨`,
                `Surface: ${donnees.surface} m¬≤`,
                `Prix au m¬≤: ${Math.round(donnees.prix/donnees.surface).toLocaleString()} ‚Ç¨`,
                `Loyer mensuel: ${donnees.loyerMensuel.toLocaleString()} ‚Ç¨`,
                `Apport personnel: ${donnees.apport.toLocaleString()} ‚Ç¨`
            ];
            
            infoBien.forEach(info => {
                doc.text(info, 20, yPos);
                yPos += 8;
            });
            
            // M√©triques principales
            yPos += 10;
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('üìä RENTABILIT√â', 20, yPos);
            
            yPos += 15;
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            // R√©cup√©rer les m√©triques affich√©es
            const rentabiliteBrute = document.querySelector('.metric-card h3').textContent;
            const cashflow = document.querySelectorAll('.metric-card h3')[3].textContent;
            
            const metrics = [
                `Rentabilit√© brute: ${rentabiliteBrute}`,
                `Cash-flow mensuel: ${cashflow}`,
                `Multiplicateur de loyers: Prix/Loyers annuels`,
                `Population locale: ${villeInfo.population.toLocaleString()} habitants`,
                `√âvolution des prix: +${villeInfo.evolutionPrix}%/an`,
                `Taux de vacance local: ${villeInfo.tauxVacance}%`
            ];
            
            metrics.forEach(metric => {
                doc.text(metric, 20, yPos);
                yPos += 8;
            });
            
            // Analyse du march√©
            yPos += 10;
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('üèòÔ∏è ANALYSE DU MARCH√â LOCAL', 20, yPos);
            
            yPos += 15;
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const analyseMarche = [
                `March√©: ${villeInfo.marche}`,
                `Transport: ${villeInfo.transport}`,
                `Attractivit√©: ${villeInfo.attractivite}`,
                `Prix m¬≤ moyen: ${villeInfo.prixM2Moyen} ‚Ç¨`,
                `Loyer m¬≤ moyen: ${villeInfo.loyerM2Moyen} ‚Ç¨`,
                `Rendement moyen local: ${villeInfo.rendementMoyen}%`
            ];
            
            analyseMarche.forEach(info => {
                doc.text(info, 20, yPos);
                yPos += 8;
            });
            
            // Recommandations
            yPos += 10;
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('üí° RECOMMANDATIONS', 20, yPos);
            
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const recommandations = [
                '‚Ä¢ V√©rifiez la conformit√© √©lectrique et gaz',
                '‚Ä¢ N√©gociez les frais d\'agence si possible',
                '‚Ä¢ √âtudiez le potentiel de colocation pour optimiser',
                '‚Ä¢ Constituez une r√©serve pour travaux impr√©vus',
                '‚Ä¢ Surveillez l\'√©volution du march√© locatif local',
                `‚Ä¢ Potentiel meubl√©: +${((villeInfo.coeffMeublee - 1) * 100).toFixed(0)}% de loyer`
            ];
            
            recommandations.forEach(rec => {
                doc.text(rec, 20, yPos);
                yPos += 7;
            });
            
            // Pied de page
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Simulateur Immobilier Pro+ - Estimation bas√©e sur les donn√©es de march√© 2024', 20, 280);
            doc.text('‚ö†Ô∏è Ce document est fourni √† titre informatif. Consultez un professionnel pour validation.', 20, 285);
            
            // Sauvegarde
            const nomFichier = `Analyse_${villeInfo.nom.replace(/\s+/g, '_')}_${dateExport.replace(/\//g, '-')}.pdf`;
            doc.save(nomFichier);
            
            // Notification de succ√®s
            afficherNotification('üìÑ Rapport PDF g√©n√©r√© avec succ√®s !', 'success');
        }

        function exporterExcel() {
            if (document.getElementById('resultats').classList.contains('hidden')) {
                alert('‚ö†Ô∏è Veuillez d\'abord effectuer un calcul avant d\'exporter.');
                return;
            }
            
            // Cr√©er les donn√©es CSV
            const donnees = {
                ville: document.getElementById('ville').value,
                prix: parseFloat(document.getElementById('prix').value),
                surface: parseFloat(document.getElementById('surface').value),
                loyerMensuel: parseFloat(document.getElementById('loyerMensuel').value),
                apport: parseFloat(document.getElementById('apport').value),
                travaux: parseFloat(document.getElementById('travaux').value) || 0,
                fraisNotaire: parseFloat(document.getElementById('fraisNotaire').value) || 0
            };
            
            const villeInfo = villesData[donnees.ville];
            const rentabilite = (donnees.loyerMensuel * 12 / donnees.prix * 100).toFixed(2);
            const prixM2 = Math.round(donnees.prix / donnees.surface);
            const loyerM2 = Math.round(donnees.loyerMensuel / donnees.surface);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ANALYSE IMMOBILIERE - " + new Date().toLocaleDateString('fr-FR') + "\n\n";
            
            csvContent += "CARACT√âRISTIQUES\n";
            csvContent += "Ville," + villeInfo.nom + "\n";
            csvContent += "Prix d'achat," + donnees.prix + "‚Ç¨\n";
            csvContent += "Surface," + donnees.surface + "m¬≤\n";
            csvContent += "Prix au m¬≤," + prixM2 + "‚Ç¨\n";
            csvContent += "Loyer mensuel," + donnees.loyerMensuel + "‚Ç¨\n";
            csvContent += "Loyer au m¬≤," + loyerM2 + "‚Ç¨\n";
            csvContent += "Apport personnel," + donnees.apport + "‚Ç¨\n";
            csvContent += "Travaux," + donnees.travaux + "‚Ç¨\n";
            csvContent += "Frais de notaire," + donnees.fraisNotaire + "‚Ç¨\n\n";
            
            csvContent += "RENTABILIT√â\n";
            csvContent += "Rentabilit√© brute," + rentabilite + "%\n";
            csvContent += "Multiplicateur," + (donnees.prix / (donnees.loyerMensuel * 12)).toFixed(1) + "\n\n";
            
            csvContent += "MARCH√â LOCAL\n";
            csvContent += "Prix m¬≤ moyen," + villeInfo.prixM2Moyen + "‚Ç¨\n";
            csvContent += "Loyer m¬≤ moyen," + villeInfo.loyerM2Moyen + "‚Ç¨\n";
            csvContent += "Rendement moyen," + villeInfo.rendementMoyen + "%\n";
            csvContent += "√âvolution prix," + villeInfo.evolutionPrix + "%/an\n";
            csvContent += "Taux vacance," + villeInfo.tauxVacance + "%\n";
            csvContent += "Population," + villeInfo.population + "\n";
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Analyse_${villeInfo.nom.replace(/\s+/g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            afficherNotification('üìä Export Excel/CSV r√©ussi !', 'success');
        }

        function sauvegarderCalcul() {
            const donnees = {
                ville: document.getElementById('ville').value,
                prix: document.getElementById('prix').value,
                surface: document.getElementById('surface').value,
                loyerMensuel: document.getElementById('loyerMensuel').value,
                apport: document.getElementById('apport').value,
                fraisNotaire: document.getElementById('fraisNotaire').value,
                fraisAgence: document.getElementById('fraisAgence').value,
                travaux: document.getElementById('travaux').value,
                mobilier: document.getElementById('mobilier').value,
                tauxInteret: document.getElementById('tauxInteret').value,
                dureeEmprunt: document.getElementById('dureeEmprunt').value,
                charges: document.getElementById('charges').value,
                vacanceLocative: document.getElementById('vacanceLocative').value,
                typeLocation: document.getElementById('typeLocation').value,
                dateCreation: new Date().toLocaleString('fr-FR')
            };
            
            const nomProjet = prompt('Nom du projet:', `${villesData[donnees.ville]?.nom || 'Projet'} - ${donnees.surface}m¬≤`);
            if (!nomProjet) return;
            
            let projets = JSON.parse(localStorage.getItem('projetsImmobilier')) || {};
            projets[nomProjet] = donnees;
            localStorage.setItem('projetsImmobilier', JSON.stringify(projets));
            
            afficherNotification(`üíæ Projet "${nomProjet}" sauvegard√© !`, 'success');
            mettreAJourListeProjets();
        }

        function chargerCalcul() {
            const projets = JSON.parse(localStorage.getItem('projetsImmobilier')) || {};
            const nomsProjets = Object.keys(projets);
            
            if (nomsProjets.length === 0) {
                alert('Aucun projet sauvegard√© trouv√©.');
                return;
            }
            
            let choix = "Projets sauvegard√©s:\n\n";
            nomsProjets.forEach((nom, index) => {
                choix += `${index + 1}. ${nom} (${projets[nom].dateCreation})\n`;
            });
            choix += "\nEntrez le num√©ro du projet √† charger:";
            
            const selection = prompt(choix);
            const index = parseInt(selection) - 1;
            
            if (index >= 0 && index < nomsProjets.length) {
                const nomProjet = nomsProjets[index];
                const donnees = projets[nomProjet];
                
                // Remplir le formulaire
                Object.keys(donnees).forEach(cle => {
                    const element = document.getElementById(cle);
                    if (element && cle !== 'dateCreation') {
                        element.value = donnees[cle];
                    }
                });
                
                afficherRecapVille();
                afficherNotification(`üìÇ Projet "${nomProjet}" charg√© !`, 'success');
            }
        }

        function mettreAJourListeProjets() {
            const projets = JSON.parse(localStorage.getItem('projetsImmobilier')) || {};
            const liste = document.getElementById('listeProjets');
            
            if (!liste) return;
            
            if (Object.keys(projets).length === 0) {
                liste.innerHTML = '<p style="color: #666; font-style: italic;">Aucun projet sauvegard√©</p>';
                return;
            }
            
            let html = '<h4>üìÅ Projets sauvegard√©s:</h4><div class="projets-list">';
            
            Object.entries(projets).forEach(([nom, donnees]) => {
                html += `
                    <div class="projet-item">
                        <div>
                            <strong>${nom}</strong><br>
                            <small>${donnees.dateCreation} - ${donnees.ville}</small>
                        </div>
                        <div>
                            <button onclick="chargerProjet('${nom}')" class="btn btn-sm btn-primary">Charger</button>
                            <button onclick="supprimerProjet('${nom}')" class="btn btn-sm btn-danger">√ó</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            liste.innerHTML = html;
        }

        function chargerProjet(nom) {
            const projets = JSON.parse(localStorage.getItem('projetsImmobilier')) || {};
            const donnees = projets[nom];
            
            if (!donnees) return;
            
            Object.keys(donnees).forEach(cle => {
                const element = document.getElementById(cle);
                if (element && cle !== 'dateCreation') {
                    element.value = donnees[cle];
                }
            });
            
            afficherRecapVille();
            afficherNotification(`üìÇ Projet "${nom}" charg√© !`, 'success');
        }

        function supprimerProjet(nom) {
            if (!confirm(`Supprimer le projet "${nom}" ?`)) return;
            
            const projets = JSON.parse(localStorage.getItem('projetsImmobilier')) || {};
            delete projets[nom];
            localStorage.setItem('projetsImmobilier', JSON.stringify(projets));
            
            mettreAJourListeProjets();
            afficherNotification(`üóëÔ∏è Projet "${nom}" supprim√©`, 'info');
        }

        function afficherNotification(message, type = 'info') {
            const couleurs = {
                success: 'var(--success-color)',
                error: 'var(--danger-color)',
                warning: 'var(--warning-color)',
                info: 'var(--info-color)'
            };
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${couleurs[type]};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Gestion des √©v√©nements
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-calcul des frais de notaire
            document.getElementById('prix').addEventListener('input', calculerFraisNotaireAuto);
            document.getElementById('typeAchat').addEventListener('change', calculerFraisNotaireAuto);
            
            // Auto-suggestion loyer
            document.getElementById('ville').addEventListener('change', afficherRecapVille);
            document.getElementById('surface').addEventListener('input', estimerLoyerAuto);
            document.getElementById('typeLocation').addEventListener('change', estimerLoyerAuto);
            
            // Validation en temps r√©el
            const champsNumeriques = ['prix', 'surface', 'loyerMensuel', 'apport'];
            champsNumeriques.forEach(champ => {
                const element = document.getElementById(champ);
                element.addEventListener('input', function() {
                    const valeur = parseFloat(this.value);
                    if (valeur > 0) {
                        this.classList.remove('error');
                    }
                });
            });
            
            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            sauvegarderCalcul();
                            break;
                        case 'o':
                            e.preventDefault();
                            chargerCalcul();
                            break;
                        case 'Enter':
                            e.preventDefault();
                            calculer();
                            break;
                        case 'e':
                            e.preventDefault();
                            exporterPDF();
                            break;
                    }
                }
            });
            
            // Initialisation
            mettreAJourListeProjets();
            
            // Auto-focus sur le premier champ
            document.getElementById('ville').focus();
        });

        // Styles CSS additionnels
        const stylesSupplementaires = `
            <style>
            .error {
                border: 2px solid var(--danger-color) !important;
                animation: shake 0.5s;
            }
                        @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }

            .ville-stats {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: var(--border-radius);
                margin: 20px 0;
                box-shadow: var(--shadow);
            }

            .ville-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .ville-item {
                text-align: center;
                padding: 15px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                backdrop-filter: blur(10px);
            }

            .ville-item strong {
                display: block;
                font-size: 1.8rem;
                font-weight: bold;
                margin-bottom: 5px;
            }

            .ville-item span {
                font-size: 0.9rem;
                opacity: 0.9;
            }

            .projets-list {
                margin-top: 15px;
            }

            .projet-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
                margin-bottom: 8px;
                border-left: 4px solid var(--primary-color);
            }

            .recommendation-item {
                padding: 12px;
                margin: 8px 0;
                border-radius: 8px;
                border-left: 4px solid;
                font-size: 0.95rem;
                line-height: 1.5;
            }

            .recommendation-item.excellent {
                background: #d4edda;
                border-color: var(--success-color);
                color: #155724;
            }

            .recommendation-item.bon {
                background: #cce5ff;
                border-color: var(--info-color);
                color: #004085;
            }

            .recommendation-item.attention {
                background: #fff3cd;
                border-color: var(--warning-color);
                color: #856404;
            }

            .recommendation-item.alerte {
                background: #f8d7da;
                border-color: var(--danger-color);
                color: #721c24;
            }

            .scenario-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin: 20px 0;
            }

            .scenario-card {
                background: white;
                border-radius: var(--border-radius);
                padding: 20px;
                box-shadow: var(--shadow);
                border-top: 4px solid;
                transition: transform 0.3s ease;
            }

            .scenario-card:hover {
                transform: translateY(-5px);
            }

            .scenario-optimiste {
                border-top-color: var(--success-color);
            }

            .scenario-realiste {
                border-top-color: var(--info-color);
            }

            .scenario-pessimiste {
                border-top-color: var(--warning-color);
            }

            .charts-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 25px;
                margin: 30px 0;
            }

            .chart-card {
                background: white;
                border-radius: var(--border-radius);
                padding: 20px;
                box-shadow: var(--shadow);
                overflow: hidden;
            }

            .chart-card canvas {
                max-height: 300px;
            }

            .floating-buttons {
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 1000;
            }

            .floating-btn {
                display: block;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: var(--primary-color);
                color: white;
                border: none;
                font-size: 1.2rem;
                margin-bottom: 10px;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .floating-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            }

            .tooltip {
                position: relative;
            }

            .tooltip::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                right: 0;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.8rem;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                z-index: 1001;
            }

            .tooltip:hover::after {
                opacity: 1;
                visibility: visible;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: #e9ecef;
                border-radius: 10px;
                overflow: hidden;
                margin: 10px 0;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
                border-radius: 10px;
                transition: width 1s ease;
            }

            .metric-card {
                position: relative;
                overflow: hidden;
            }

            .metric-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 2px;
                background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.6), transparent);
                animation: shimmer 2s infinite;
            }

            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 100%; }
            }

            .advanced-metrics {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }

            .mini-metric {
                text-align: center;
                padding: 15px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                border: 1px solid #e9ecef;
            }

            .mini-metric .value {
                font-size: 1.5rem;
                font-weight: bold;
                color: var(--primary-color);
                margin-bottom: 5px;
            }

            .mini-metric .label {
                font-size: 0.85rem;
                color: #666;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 10px;
                }
                
                .header h1 {
                    font-size: 2rem;
                }
                
                .form-grid {
                    grid-template-columns: 1fr;
                }
                
                .charts-container {
                    grid-template-columns: 1fr;
                }
                
                .chart-card {
                    padding: 15px;
                }
                
                .ville-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
                
                .floating-buttons {
                    bottom: 20px;
                    right: 20px;
                }
                
                .floating-btn {
                    width: 50px;
                    height: 50px;
                    font-size: 1rem;
                }
                
                .scenario-cards {
                    grid-template-columns: 1fr;
                }
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid var(--primary-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .badge {
                display: inline-block;
                padding: 4px 8px;
                font-size: 0.75rem;
                font-weight: 500;
                border-radius: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-left: 8px;
            }

            .badge-excellent {
                background: var(--success-color);
                color: white;
            }

            .badge-bon {
                background: var(--info-color);
                color: white;
            }

            .badge-moyen {
                background: var(--warning-color);
                color: white;
            }

            .badge-faible {
                background: var(--danger-color);
                color: white;
            }

            .comparison-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: var(--border-radius);
                overflow: hidden;
                box-shadow: var(--shadow);
                margin: 20px 0;
            }

            .comparison-table th {
                background: var(--primary-color);
                color: white;
                padding: 15px;
                text-align: left;
                font-weight: 600;
            }

            .comparison-table td {
                padding: 12px 15px;
                border-bottom: 1px solid #e9ecef;
            }

            .comparison-table tr:hover {
                background: #f8f9fa;
            }

            .help-text {
                font-size: 0.85rem;
                color: #666;
                font-style: italic;
                margin-top: 5px;
            }

            .form-section {
                margin-bottom: 30px;
            }

            .form-section h3 {
                color: var(--primary-color);
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--primary-color);
                font-size: 1.3rem;
            }
            </style>
        `;

        // Injection des styles
        document.head.insertAdjacentHTML('beforeend', stylesSupplementaires);

        // Fonctions utilitaires finales
        function calculerFraisNotaireAuto() {
            const prix = parseFloat(document.getElementById('prix').value) || 0;
            const typeAchat = document.getElementById('typeAchat').value;
            
            if (prix > 0) {
                let taux = 0.08; // 8% par d√©faut (ancien)
                if (typeAchat === 'neuf') {
                    taux = 0.03; // 3% pour le neuf
                }
                
                const frais = Math.round(prix * taux);
                document.getElementById('fraisNotaire').value = frais;
                
                // Mise √† jour du placeholder avec explication
                document.getElementById('fraisNotaire').placeholder = `Auto: ${taux * 100}% = ${frais.toLocaleString()}‚Ç¨`;
            }
        }

        function estimerLoyerAuto() {
            const ville = document.getElementById('ville').value;
            const surface = parseFloat(document.getElementById('surface').value) || 0;
            const typeLocation = document.getElementById('typeLocation').value;
            
            if (!ville || !surface || !villesData[ville]) return;
            
            const donnees = villesData[ville];
            let loyerM2 = donnees.loyerM2Moyen;
            
            // Ajustement selon le type de location
            switch(typeLocation) {
                case 'meublee':
                    loyerM2 *= donnees.coeffMeublee;
                    break;
                case 'colocation':
                    loyerM2 *= donnees.coeffColocation;
                    break;
            }
            
            const loyerEstime = Math.round(loyerM2 * surface);
            document.getElementById('loyerMensuel').placeholder = `Estimation: ${loyerEstime}‚Ç¨ (${loyerM2.toFixed(1)}‚Ç¨/m¬≤)`;
        }

        // Message de bienvenue au chargement
        window.addEventListener('load', function() {
            setTimeout(() => {
                afficherNotification('üöÄ Simulateur Pro+ charg√© ! Utilisez Ctrl+S pour sauvegarder, Ctrl+E pour exporter.', 'success');
            }, 1000);
        });

        console.log('üéØ Simulateur Immobilier Pro+ v2.1 - Charg√© avec succ√®s!');
        console.log('üìä Donn√©es int√©gr√©es: 14 villes du Calvados');
        console.log('‚ö° Fonctionnalit√©s: Calculs avanc√©s, Graphiques, Export PDF/Excel, Comparaison');
        console.log('üî• Raccourcis: Ctrl+S (Sauver), Ctrl+O (Ouvrir), Ctrl+E (Export), Ctrl+Enter (Calculer)');

    </script>
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div class="header">
            <h1><i class="fas fa-calculator"></i> Simulateur Immobilier Pro+</h1>
            <p class="subtitle">üéØ Expert IA 2024 | 14 villes du Calvados | Analyse compl√®te & projections</p>
            <div class="header-badges">
                <span class="badge-header"><i class="fas fa-chart-line"></i> Graphiques avanc√©s</span>
                <span class="badge-header"><i class="fas fa-file-pdf"></i> Export PDF</span>
                <span class="badge-header"><i class="fas fa-save"></i> Sauvegarde</span>
            </div>
        </div>

        <!-- Formulaire principal -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-home"></i> Caract√©ristiques du bien</h2>
                <p>Renseignez les informations de votre projet immobilier</p>
            </div>
            
            <form class="form-grid" onsubmit="event.preventDefault(); calculer();">
                <!-- Section localisation -->
                <div class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Localisation</h3>
                    
                    <div class="form-group">
                        <label for="ville"><i class="fas fa-city"></i> Ville</label>
                        <select id="ville" required>
                            <option value="">S√©lectionnez une ville...</option>
                            <option value="caen">Caen (Pr√©fecture)</option>
                            <option value="lisieux">Lisieux</option>
                            <option value="honfleur">Honfleur</option>
                            <option value="deauville">Deauville</option>
                            <option value="trouville">Trouville-sur-Mer</option>
                            <option value="cabourg">Cabourg</option>
                            <option value="ouistreham">Ouistreham</option>
                            <option value="vire">Vire-Normandie</option>
                            <option value="bayeux">Bayeux</option>
                            <option value="coutances">Coutances</option>
                            <option value="granville">Granville</option>
                        </select>
                    </div>

                    <div id="villeRecap" class="hidden">
                        <!-- R√©capitulatif ville g√©n√©r√© dynamiquement -->
                    </div>
                </div>

                <!-- Section bien -->
                <div class="form-section">
                    <h3><i class="fas fa-building"></i> Caract√©ristiques du bien</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="prix"><i class="fas fa-tag"></i> Prix d'achat (‚Ç¨)</label>
                            <input type="number" id="prix" placeholder="Ex: 180 000" min="1" step="1000" required>
                            <div class="help-text">Prix affich√© par le vendeur</div>
                        </div>

                        <div class="form-group">
                            <label for="surface"><i class="fas fa-expand-arrows-alt"></i> Surface (m¬≤)</label>
                            <input type="number" id="surface" placeholder="Ex: 65" min="1" step="0.1" required>
                            <div class="help-text">Surface habitable (loi Carrez)</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="typeLocation"><i class="fas fa-bed"></i> Type de location</label>
                            <select id="typeLocation">
                                <option value="vide">Location vide</option>
                                <option value="meublee">Location meubl√©e</option>
                                <option value="colocation">Colocation</option>
                            </select>
                            <div class="help-text">Impact sur le prix au m¬≤ des loyers</div>
                        </div>

                        <div class="form-group">
                            <label for="loyerMensuel"><i class="fas fa-euro-sign"></i> Loyer mensuel (‚Ç¨)</label>
                            <input type="number" id="loyerMensuel" placeholder="Estimation automatique..." min="1" step="10" required>
                            <div class="help-text">Loyer hors charges attendu</div>
                        </div>
                    </div>
                </div>

                <!-- Section financement -->
                <div class="form-section">
                    <h3><i class="fas fa-university"></i> Financement</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="apport"><i class="fas fa-piggy-bank"></i> Apport personnel (‚Ç¨)</label>
                            <input type="number" id="apport" placeholder="Ex: 20 000" min="0" step="1000" required>
                            <div class="help-text">Cash disponible pour l'achat</div>
                        </div>

                        <div class="form-group">
                            <label for="tauxInteret"><i class="fas fa-percentage"></i> Taux d'int√©r√™t (%)</label>
                            <input type="number" id="tauxInteret" value="4.2" min="0" max="10" step="0.1">
                            <div class="help-text">Taux nominal du cr√©dit immobilier</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dureeEmprunt"><i class="fas fa-calendar-alt"></i> Dur√©e d'emprunt (ann√©es)</label>
                            <input type="number" id="dureeEmprunt" value="20" min="5" max="30" step="1">
                            <div class="help-text">Dur√©e de remboursement du cr√©dit</div>
                        </div>

                        <div class="form-group">
                            <label for="typeAchat"><i class="fas fa-hammer"></i> Type d'achat</label>
                            <select id="typeAchat">
                                <option value="ancien">Ancien (8% frais notaire)</option>
                                <option value="neuf">Neuf (3% frais notaire)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section frais -->
                <div class="form-section">
                    <h3><i class="fas fa-receipt"></i> Frais et travaux</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fraisNotaire"><i class="fas fa-stamp"></i> Frais de notaire (‚Ç¨)</label>
                            <input type="number" id="fraisNotaire" placeholder="Calcul automatique..." min="0" step="100">
                            <div class="help-text">Calcul√©s automatiquement selon le type</div>
                        </div>

                        <div class="form-group">
                            <label for="fraisAgence"><i class="fas fa-handshake"></i> Frais d'agence (‚Ç¨)</label>
                            <input type="number" id="fraisAgence" value="0" min="0" step="100">
                            <div class="help-text">Si achat via agence (5-7% du prix)</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="travaux"><i class="fas fa-tools"></i> Travaux (‚Ç¨)</label>
                            <input type="number" id="travaux" value="0" min="0" step="500">
                            <div class="help-text">R√©novation, mise aux normes...</div>
                        </div>

                        <div class="form-group">
                            <label for="mobilier"><i class="fas fa-couch"></i> Mobilier (‚Ç¨)</label>
                            <input type="number" id="mobilier" value="0" min="0" step="100">
                            <div class="help-text">Si location meubl√©e</div>
                        </div>
                    </div>
                </div>

                <!-- Section charges -->
                <div class="form-section">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Charges locatives</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="charges"><i class="fas fa-wrench"></i> Charges mensuelles (‚Ç¨)</label>
                            <input type="number" id="charges" value="50" min="0" step="5">
                            <div class="help-text">Syndic, entretien, assurances...</div>
                        </div>

                        <div class="form-group">
                            <label for="vacanceLocative"><i class="fas fa-calendar-times"></i> Vacance locative (%)</label>
                            <input type="number" id="vacanceLocative" value="5" min="0" max="50" step="0.5">
                            <div class="help-text">P√©riode sans locataire (par an)</div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-calculator"></i> Calculer la rentabilit√©
                    </button>
                    
                    <div class="secondary-actions">
                        <button type="button" onclick="sauvegarderCalcul()" class="btn btn-outline tooltip" data-tooltip="Ctrl+S">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                        <button type="button" onclick="chargerCalcul()" class="btn btn-outline tooltip" data-tooltip="Ctrl+O">
                            <i class="fas fa-folder-open"></i> Charger
                        </button>
                        <button type="button" onclick="document.querySelector('form').reset(); afficherRecapVille();" class="btn btn-outline">
                            <i class="fas fa-trash-alt"></i> Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Zone des r√©sultats -->
        <div id="resultats" class="hidden">
            <!-- M√©triques principales -->
            <div class="metrics-grid" id="metriques">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- Recommandations -->
            <div id="recommandations" class="card">
                <!-- G√©n√©r√© dynamiquement -->
            </div>

            <!-- Sc√©narios de projection -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-crystal-ball"></i> Projections sur 10 ans</h2>
                    <p>√âvolution selon diff√©rents sc√©narios de march√©</p>
                </div>
                
                <div class="scenario-cards">
                    <div class="scenario-card scenario-optimiste">
                        <h4><i class="fas fa-trending-up"></i> Sc√©nario optimiste</h4>
                        <div id="scenarioOptimiste"></div>
                    </div>
                    
                    <div class="scenario-card scenario-realiste">
                        <h4><i class="fas fa-chart-line"></i> Sc√©nario r√©aliste</h4>
                        <div id="scenarioRealiste"></div>
                    </div>
                    
                    <div class="scenario-card scenario-pessimiste">
                        <h4><i class="fas fa-trending-down"></i> Sc√©nario prudent</h4>
                        <div id="scenarioPessimiste"></div>
                    </div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Analyses graphiques</h2>
                </div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <canvas id="chartRentabilite"></canvas>
                    </div>
                    <div class="chart-card">
                        <canvas id="chartEvolution"></canvas>
                    </div>
                    <div class="chart-card">
                        <canvas id="chartCashflow"></canvas>
                    </div>
                    <div class="chart-card">
                        <canvas id="chartRepartition"></canvas>
                    </div>
                </div>
            </div>

            <!-- Actions export -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-download"></i> Export et partage</h2>
                </div>
                
                <div class="export-actions">
                    <button onclick="exporterPDF()" class="btn btn-success tooltip" data-tooltip="Ctrl+E">
                        <i class="fas fa-file-pdf"></i> G√©n√©rer rapport PDF
                    </button>
                    <button onclick="exporterExcel()" class="btn btn-info">
                        <i class="fas fa-file-excel"></i> Export Excel/CSV
                    </button>
                    <button onclick="window.print()" class="btn btn-outline">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button onclick="navigator.share({title: 'Mon projet immobilier', text: document.title, url: window.location.href}).catch(() => alert('Partage non support√©'))" class="btn btn-outline">
                        <i class="fas fa-share-alt"></i> Partager
                    </button>
                </div>
            </div>
        </div>

        <!-- Projets sauvegard√©s -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-folder"></i> Mes projets</h2>
            </div>
            <div id="listeProjets">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Boutons flottants -->
    <div class="floating-buttons">
        <button onclick="calculer()" class="floating-btn tooltip" data-tooltip="Calculer (Ctrl+Enter)">
            <i class="fas fa-calculator"></i>
        </button>
        <button onclick="exporterPDF()" class="floating-btn tooltip" data-tooltip="Export PDF (Ctrl+E)">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button onclick="sauvegarderCalcul()" class="floating-btn tooltip" data-tooltip="Sauvegarder (Ctrl+S)">
            <i class="fas fa-save"></i>
        </button>
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="floating-btn tooltip" data-tooltip="Retour en haut">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>
</body>
</html>
