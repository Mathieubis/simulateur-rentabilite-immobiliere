<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Immobilier Pro - Normandie</title>
    
    <!-- CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8rem;
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .results {
            display: none;
            grid-column: span 2;
            margin-top: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .metric-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .metric-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            height: 300px;
        }

        .score-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            margin: 0 auto;
            border: 5px solid white;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .projections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .projection-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .projection-item h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .actions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .results {
                grid-column: span 1;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Simulateur Immobilier Pro</h1>
            <p>Analysez la rentabilit√© de votre investissement en Normandie avec l'IA</p>
        </div>

        <div class="main-content">
            <!-- Formulaire de saisie -->
            <div class="card">
                <h2><i class="fas fa-home"></i> Caract√©ristiques du bien</h2>
                
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Ville</label>
                    <select id="ville" onchange="afficherRecapVille(); estimerLoyer();">
                        <option value="">S√©lectionnez une ville...</option>
                        <option value="cherbourg">Cherbourg-en-Cotentin</option>
                        <option value="herouville">H√©rouville-Saint-Clair</option>
                        <option value="lisieux">Lisieux</option>
                        <option value="falaise">Falaise</option>
                        <option value="carentan">Carentan-les-Marais</option>
                        <option value="vire">Vire-Normandie</option>
                    </select>
                </div>

                <!-- R√©cap ville (sera affich√© dynamiquement) -->
                <div id="villeRecap" style="display: none;"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-euro-sign"></i> Prix d'achat (‚Ç¨)</label>
                        <input type="number" id="prix" placeholder="180000" oninput="calculerEstimationPrix();">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-ruler-combined"></i> Surface (m¬≤)</label>
                        <input type="number" id="surface" placeholder="60" oninput="estimerLoyer();">
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-bed"></i> Type de location</label>
                    <select id="typeLocation" onchange="estimerLoyer(); afficherChampColocation();">
                        <option value="classique">Location classique</option>
                        <option value="meublee">Location meubl√©e</option>
                        <option value="colocation">Colocation</option>
                        <option value="saisonniere">Saisonnier/Airbnb</option>
                    </select>
                </div>

                <!-- Champ nombre de chambres pour colocation -->
                <div class="form-group" id="colocationChambres" style="display: none;">
                    <label><i class="fas fa-door-open"></i> Nombre de chambres √† louer</label>
                    <input type="number" id="nombreChambres" placeholder="3" min="1" max="10" oninput="estimerLoyer();">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-coins"></i> Loyer mensuel estim√© (‚Ç¨)</label>
                    <input type="number" id="loyerMensuel" placeholder="750" readonly>
                    <small style="color: #6c757d; font-size: 0.85rem;">üí° Estimation automatique bas√©e sur les donn√©es march√©</small>
                </div>
            </div>

            <!-- Financement -->
            <div class="card">
                <h2><i class="fas fa-calculator"></i> Financement & Frais</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-piggy-bank"></i> Apport personnel (‚Ç¨)</label>
                        <input type="number" id="apport" placeholder="50000">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-percent"></i> Taux d'emprunt (%)</label>
                        <input type="number" id="tauxEmprunt" placeholder="4.5" step="0.1">
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Dur√©e d'emprunt (ann√©es)</label>
                    <select id="dureeEmprunt">
                        <option value="15">15 ans</option>
                        <option value="20" selected>20 ans</option>
                        <option value="25">25 ans</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-file-contract"></i> Frais notaire (‚Ç¨)</label>
                        <input type="number" id="fraisNotaire" placeholder="15000">
                        <small style="color: #6c757d; font-size: 0.85rem;">üí° ~8% du prix pour l'ancien, ~3% pour le neuf</small>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-handshake"></i> Frais d'agence (‚Ç¨)</label>
                        <input type="number" id="fraisAgence" placeholder="9000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> Travaux (‚Ç¨)</label>
                        <input type="number" id="travaux" placeholder="15000">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-couch"></i> Mobilier (‚Ç¨)</label>
                        <input type="number" id="mobilier" placeholder="5000">
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-wrench"></i> Charges annuelles (‚Ç¨)</label>
                    <input type="number" id="chargesAnnuelles" placeholder="3000">
                    <small style="color: #6c757d; font-size: 0.85rem;">Copropri√©t√©, taxes, assurance, entretien...</small>
                </div>

                <button class="btn" onclick="calculerRentabilite()">
                    <i class="fas fa-rocket"></i> Analyser l'investissement
                </button>
            </div>
        </div>

        <!-- R√©sultats -->
        <div class="results card" id="results">
            <h2><i class="fas fa-chart-bar"></i> Analyse de Rentabilit√©</h2>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3 id="rentaBrute">-</h3>
                    <p>Rentabilit√© Brute</p>
                </div>
                <div class="metric-card">
                    <h3 id="rentaNette">-</h3>
                    <p>Rentabilit√© Nette</p>
                </div>
                <div class="metric-card">
                    <h3 id="rentaReelle">-</h3>
                    <p>Rentabilit√© R√©elle</p>
                </div>
                <div class="metric-card">
                    <h3 id="cashFlow">-</h3>
                    <p>Cash-flow Mensuel</p>
                </div>
            </div>

            <!-- Score IA -->
            <div class="analysis-grid">
                <div class="card">
                    <h3><i class="fas fa-brain"></i> Score IA d'Investissement</h3>
                    <div class="score-container">
                        <div>
                            <div class="score-circle" id="scoreCircle">-</div>
                            <p id="scoreText" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
                        </div>
                    </div>
                </div>

                <!-- Explication des calculs -->
                <div class="calculation-explanation">
                    <h5><i class="fas fa-calculator"></i> Comment nous calculons :</h5>
                    <ul id="calculExplication">
                        <!-- Sera rempli dynamiquement -->
                    </ul>
                </div>
            </div>

            <!-- Recommandations IA -->
            <div class="card">
                <h3><i class="fas fa-lightbulb"></i> Recommandations Personnalis√©es</h3>
                <div id="recommandations">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>

            <!-- Sc√©narios -->
            <div class="analysis-grid">
                <div class="projection-item">
                    <h4><i class="fas fa-chart-line"></i> Sc√©nario Optimiste</h4>
                    <div id="scenarioOptimiste"><!-- Rempli dynamiquement --></div>
                </div>
                <div class="projection-item">
                    <h4><i class="fas fa-balance-scale"></i> Sc√©nario R√©aliste</h4>
                    <div id="scenarioRealiste"><!-- Rempli dynamiquement --></div>
                </div>
                <div class="projection-item">
                    <h4><i class="fas fa-chart-line-down"></i> Sc√©nario Pessimiste</h4>
                    <div id="scenarioPessimiste"><!-- Rempli dynamiquement --></div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="analysis-grid">
                <div class="chart-container">
                    <canvas id="projectionChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="rentabiliteChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="cashflowChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="longTermChart"></canvas>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions-container">
                <button class="btn" onclick="exporterPDF()">
                    <i class="fas fa-file-pdf"></i> Exporter en PDF
                </button>
                <button class="btn btn-secondary" onclick="sauvegarderLocalement()">
                    <i class="fas fa-save"></i> Sauvegarder
                </button>
            </div>
        </div>
    </div>

    <script>
        let projectionChart, rentabiliteChart, cashflowChart, longTermChart;

        // üî• DONN√âES R√âELLES 2024 avec colocations
        const villesData = {
            'cherbourg': {
                nom: 'Cherbourg-en-Cotentin',
                prixM2Moyen: 2394,
                prixM2Min: 1646,
                prixM2Max: 3924,
                loyerM2Moyen: 15.9,
                loyerM2Min: 12.8,
                loyerM2Max: 19.1,
                evolutionPrix: '+7%',
                evolutionPrixValeur: 7,
                croissancePrix: 2.5,
                coeffMeublee: 1.25,
                coeffColocation: 1.40,
                coeffSaisonniere: 1.60,
                tension: 'Forte',
                population: 79000,
                taux_vacance: 4,
                dateMAJ: 'Janvier 2024',
                // Donn√©es colocation
                loyerColocationParChambre: 320,
                loyerColocationMin: 280,
                loyerColocationMax: 380,
                tauxOccupationColocation: 65,
                surfaceMoyenneChambre: '12-15 m¬≤'
            },
            'herouville': {
                nom: 'H√©rouville-Saint-Clair',
                prixM2Moyen: 2399,
                prixM2Min: 1543,
                prixM2Max: 3327,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                evolutionPrix: '+10%',
                evolutionPrixValeur: 10,
                croissancePrix: 2.8,
                coeffMeublee: 1.30,
                coeffColocation: 1.45,
                coeffSaisonniere: 1.70,
                tension: 'Forte',
                population: 21000,
                taux_vacance: 3,
                dateMAJ: 'Janvier 2024',
                loyerColocationParChambre: 340,
                loyerColocationMin: 300,
                loyerColocationMax: 380,
                tauxOccupationColocation: 75,
                surfaceMoyenneChambre: '14-18 m¬≤'
            },
            'lisieux': {
                nom: 'Lisieux',
                prixM2Moyen: 1906,
                prixM2Min: 1310,
                prixM2Max: 2803,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                evolutionPrix: '+2%',
                evolutionPrixValeur: 2,
                croissancePrix: 2.1,
                coeffMeublee: 1.28,
                coeffColocation: 1.40,
                coeffSaisonniere: 1.50,
                tension: 'Mod√©r√©e',
                population: 20800,
                taux_vacance: 5,
                dateMAJ: 'Janvier 2024',
                loyerColocationParChambre: 290,
                loyerColocationMin: 250,
                loyerColocationMax: 330,
                tauxOccupationColocation: 60,
                surfaceMoyenneChambre: '12-14 m¬≤'
            },
            'falaise': {
                nom: 'Falaise',
                prixM2Moyen: 1790,
                prixM2Min: 1155,
                prixM2Max: 2406,
                loyerM2Moyen: 11.0,
                loyerM2Min: 8.8,
                loyerM2Max: 13.2,
                evolutionPrix: '-12%',
                evolutionPrixValeur: -12,
                croissancePrix: 1.5,
                coeffMeublee: 1.22,
                coeffColocation: 1.35,
                coeffSaisonniere: 1.40,
                tension: 'Mod√©r√©e',
                population: 8500,
                taux_vacance: 6,
                dateMAJ: 'Janvier 2024',
                loyerColocationParChambre: 270,
                loyerColocationMin: 230,
                loyerColocationMax: 310,
                tauxOccupationColocation: 50,
                surfaceMoyenneChambre: '11-13 m¬≤'
            },
            'carentan': {
                nom: 'Carentan-les-Marais',
                prixM2Moyen: 1629,
                prixM2Min: 1069,
                prixM2Max: 2329,
                loyerM2Moyen: 11.7,
                loyerM2Min: 9.3,
                loyerM2Max: 14.0,
                evolutionPrix: '+5%',
                evolutionPrixValeure: 5,
                croissancePrix: 1.8,
                coeffMeublee: 1.20,
                coeffColocation: 1.32,
                coeffSaisonniere: 1.35,
                tension: 'Faible',
                population: 6100,
                taux_vacance: 7,
                dateMAJ: 'Janvier 2024',
                loyerColocationParChambre: 260,
                loyerColocationMin: 220,
                loyerColocationMax: 300,
                tauxOccupationColocation: 40,
                surfaceMoyenneChambre: '10-14 m¬≤'
            },
            'vire': {
                nom: 'Vire-Normandie',
                prixM2Moyen: 1464,
                prixM2Min: 977,
                prixM2Max: 1948,
                loyerM2Moyen: 10.5,
                loyerM2Min: 8.4,
                loyerM2Max: 12.6,
                evolutionPrix: '-5%',
                evolutionPrixValeur: -5,
                croissancePrix: 1.2,
                coeffMeublee: 1.18,
                coeffColocation: 1.28,
                coeffSaisonniere: 1.30,
                tension: 'Faible',
                population: 17500,
                taux_vacance: 8,
                dateMAJ: 'Janvier 2024',
                loyerColocationParChambre: 240,
                loyerColocationMin: 200,
                loyerColocationMax: 280,
                tauxOccupationColocation: 35,
                surfaceMoyenneChambre: '12-16 m¬≤'
            }
        };

        function afficherRecapVille() {
            const ville = document.getElementById('ville').value;
            const recapDiv = document.getElementById('villeRecap');
            
            if (!ville || !villesData[ville]) {
                recapDiv.style.display = 'none';
                return;
            }
            
            const donnees = villesData[ville];
            const evolutionClass = donnees.evolutionPrixValeur >= 0 ? 'evolution-positive' : 'evolution-negative';
            
            recapDiv.innerHTML = `
                <div class="ville-recap">
                    <h4><i class="fas fa-info-circle"></i> ${donnees.nom} - Donn√©es march√© 2024</h4>
                    
                    <div class="ville-stats">
                        <div class="ville-stat">
                            <div class="value">${donnees.prixM2Moyen.toLocaleString()}‚Ç¨</div>
                            <div class="label">Prix moyen/m¬≤</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.loyerM2Moyen}‚Ç¨</div>
                            <div class="label">Loyer moyen/m¬≤</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value ${evolutionClass}">${donnees.evolutionPrix}</div>
                            <div class="label">√âvolution 1 an</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.loyerColocationParChambre}‚Ç¨</div>
                            <div class="label">Colocation/chambre</div>
                        </div>
                    </div>
                    
                    <div class="ville-fourchettes">
                        <h5>Fourchettes de prix :</h5>
                        <div class="fourchette-row">
                            <div><strong>Achat :</strong> ${donnees.prixM2Min.toLocaleString()}‚Ç¨ - ${donnees.prixM2Max.toLocaleString()}‚Ç¨/m¬≤</div>
                            <div><strong>Location :</strong> ${donnees.loyerM2Min}‚Ç¨ - ${donnees.loyerM2Max}‚Ç¨/m¬≤</div>
                        </div>
                        <div class="fourchette-row">
                            <div><strong>Colocation :</strong> ${donnees.loyerColocationMin}‚Ç¨ - ${donnees.loyerColocationMax}‚Ç¨/chambre</div>
                            <div><strong>Taux occupation :</strong> ${donnees.tauxOccupationColocation}% ‚Ä¢ Surface : ${donnees.surfaceMoyenneChambre}</div>
                        </div>
                    </div>
                    
                    <div class="data-source">
                        <i class="fas fa-database"></i> Donn√©es ${donnees.dateMAJ} ‚Ä¢ Population: ${donnees.population.toLocaleString()} hab. ‚Ä¢ Tension: ${donnees.tension}
                    </div>
                </div>
            `;
            
            recapDiv.style.display = 'block';
        }

        function afficherChampColocation() {
            const typeLocation = document.getElementById('typeLocation').value;
            const champColocation = document.getElementById('colocationChambres');
            
            if (typeLocation === 'colocation') {
                champColocation.style.display = 'block';
                // Valeur par d√©faut
                if (!document.getElementById('nombreChambres').value) {
                    document.getElementById('nombreChambres').value = 3;
                }
            } else {
                champColocation.style.display = 'none';
            }
        }

        function calculerEstimationPrix() {
            const prix = parseFloat(document.getElementById('prix').value);
            if (prix > 0) {
                // Estimation frais de notaire : 8% pour ancien, 3% pour neuf
                const fraisNotaire = Math.round(prix * 0.08); // Par d√©faut ancien
                document.getElementById('fraisNotaire').value = fraisNotaire;
            }
        }

        function estimerLoyer() {
            const ville = document.getElementById('ville').value;
            const surface = parseFloat(document.getElementById('surface').value);
            const typeLocation = document.getElementById('typeLocation').value;
            const nombreChambres = parseInt(document.getElementById('nombreChambres').value) || 0;
            
            if (!ville || !villesData[ville] || !surface) return;
            
            const donnees = villesData[ville];
            let loyerEstime = 0;
            
            switch(typeLocation) {
                case 'classique':
                    loyerEstime = surface * donnees.loyerM2Moyen;
                    break;
                case 'meublee':
                    loyerEstime = surface * donnees.loyerM2Moyen * donnees.coeffMeublee;
                    break;
                case 'colocation':
                    if (nombreChambres > 0) {
                        loyerEstime = nombreChambres * donnees.loyerColocationParChambre;
                    } else {
                        loyerEstime = surface * donnees.loyerM2Moyen * donnees.coeffColocation;
                    }
                    break;
                case 'saisonniere':
                    loyerEstime = surface * donnees.loyerM2Moyen * donnees.coeffSaisonniere;
                    break;
            }
            
            document.getElementById('loyerMensuel').
                value = Math.round(loyerEstime);
        }

        function calculerRentabilite() {
            // R√©cup√©ration des donn√©es
            const ville = document.getElementById('ville').value;
            const prix = parseFloat(document.getElementById('prix').value);
            const surface = parseFloat(document.getElementById('surface').value);
            const loyerMensuel = parseFloat(document.getElementById('loyerMensuel').value);
            const apport = parseFloat(document.getElementById('apport').value);
            const tauxEmprunt = parseFloat(document.getElementById('tauxEmprunt').value) / 100;
            const dureeEmprunt = parseInt(document.getElementById('dureeEmprunt').value);
            const fraisNotaire = parseFloat(document.getElementById('fraisNotaire').value) || 0;
            const fraisAgence = parseFloat(document.getElementById('fraisAgence').value) || 0;
            const travaux = parseFloat(document.getElementById('travaux').value) || 0;
            const mobilier = parseFloat(document.getElementById('mobilier').value) || 0;
            const chargesAnnuelles = parseFloat(document.getElementById('chargesAnnuelles').value) || 0;

            // Validation
            if (!ville || !prix || !surface || !loyerMensuel || !apport) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            // Calculs
            const montantTotal = prix + fraisNotaire + fraisAgence + travaux + mobilier;
            const montantEmprunte = montantTotal - apport;
            const loyersAnnuels = loyerMensuel * 12;
            
            // Mensualit√© d'emprunt
            let mensualite = 0;
            if (montantEmprunte > 0 && tauxEmprunt > 0) {
                const tauxMensuel = tauxEmprunt / 12;
                const nbMensualites = dureeEmprunt * 12;
                mensualite = montantEmprunte * (tauxMensuel * Math.pow(1 + tauxMensuel, nbMensualites)) / (Math.pow(1 + tauxMensuel, nbMensualites) - 1);
            }

            // Rentabilit√©s
            const rentaBrute = (loyersAnnuels / montantTotal) * 100;
            const rentaNette = ((loyersAnnuels - chargesAnnuelles) / montantTotal) * 100;
            const cashFlowMensuel = loyerMensuel - (chargesAnnuelles / 12) - mensualite;
            const rentaReelle = ((loyersAnnuels - chargesAnnuelles - (mensualite * 12)) / apport) * 100;

            // Affichage des r√©sultats
            document.getElementById('rentaBrute').textContent = rentaBrute.toFixed(1) + '%';
            document.getElementById('rentaNette').textContent = rentaNette.toFixed(1) + '%';
            document.getElementById('rentaReelle').textContent = rentaReelle.toFixed(1) + '%';
            document.getElementById('cashFlow').textContent = (cashFlowMensuel >= 0 ? '+' : '') + Math.round(cashFlowMensuel) + '‚Ç¨';

            // Score IA
            const score = calculerScoreIA(ville, rentaBrute, rentaNette, cashFlowMensuel, prix, surface);
            afficherScore(score);

            // Explications
            afficherExplicationCalculs(montantTotal, loyersAnnuels, chargesAnnuelles, mensualite, apport);

            // Recommandations IA
            genererRecommandations(ville, rentaBrute, rentaNette, cashFlowMensuel, prix, surface, loyerMensuel);

            // Sc√©narios
            const data = {
                prixTotal: montantTotal,
                loyersAnnuels: loyersAnnuels,
                chargesAnnuelles: chargesAnnuelles,
                mensualite: mensualite,
                apport: apport
            };
            genererScenarios(data, ville);

            // Graphiques
            genererGraphiques(data);

            // Afficher les r√©sultats
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function calculerScoreIA(ville, rentaBrute, rentaNette, cashFlow, prix, surface) {
            let score = 50; // Base
            const donnees = villesData[ville];

            // Rentabilit√© brute
            if (rentaBrute >= 8) score += 25;
            else if (rentaBrute >= 6) score += 15;
            else if (rentaBrute >= 4) score += 5;
            else score -= 10;

            // Cash-flow
            if (cashFlow >= 200) score += 20;
            else if (cashFlow >= 0) score += 10;
            else if (cashFlow >= -100) score -= 5;
            else score -= 15;

            // Prix par rapport au march√©
            const prixM2 = prix / surface;
            const ecartPrix = ((prixM2 - donnees.prixM2Moyen) / donnees.prixM2Moyen) * 100;
            
            if (ecartPrix <= -10) score += 15; // Bon prix
            else if (ecartPrix <= 0) score += 5;
            else if (ecartPrix <= 10) score -= 5;
            else score -= 15; // Trop cher

            // √âvolution du march√©
            if (donnees.evolutionPrixValeur >= 5) score += 10;
            else if (donnees.evolutionPrixValeur >= 0) score += 5;
            else score -= 10;

            // Tension locative
            if (donnees.tension === 'Forte') score += 10;
            else if (donnees.tension === 'Mod√©r√©e') score += 5;

            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function afficherScore(score) {
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            
            scoreCircle.textContent = score + '/100';
            
            let couleur, texte;
            if (score >= 80) {
                couleur = '#28a745';
                texte = 'Excellent investissement';
            } else if (score >= 65) {
                couleur = '#17a2b8';
                texte = 'Bon investissement';
            } else if (score >= 50) {
                couleur = '#ffc107';
                texte = 'Investissement moyen';
            } else if (score >= 35) {
                couleur = '#fd7e14';
                texte = 'Investissement risqu√©';
            } else {
                couleur = '#dc3545';
                texte = 'Investissement d√©conseill√©';
            }
            
            scoreCircle.style.background = couleur;
            scoreText.textContent = texte;
            scoreText.style.color = couleur;
        }

        function afficherExplicationCalculs(montantTotal, loyersAnnuels, chargesAnnuelles, mensualite, apport) {
            const explications = document.getElementById('calculExplication');
            explications.innerHTML = `
                <li><strong>Rentabilit√© Brute :</strong> ${loyersAnnuels.toLocaleString()}‚Ç¨ √∑ ${montantTotal.toLocaleString()}‚Ç¨ √ó 100</li>
                <li><strong>Rentabilit√© Nette :</strong> (${loyersAnnuels.toLocaleString()}‚Ç¨ - ${chargesAnnuelles.toLocaleString()}‚Ç¨) √∑ ${montantTotal.toLocaleString()}‚Ç¨ √ó 100</li>
                <li><strong>Cash-flow :</strong> ${Math.round(loyersAnnuels/12)}‚Ç¨ - ${Math.round(chargesAnnuelles/12)}‚Ç¨ - ${Math.round(mensualite)}‚Ç¨</li>
                <li><strong>Rentabilit√© R√©elle :</strong> Gain net annuel √∑ ${apport.toLocaleString()}‚Ç¨ (votre apport)</li>
                <li><strong>Investissement Total :</strong> ${montantTotal.toLocaleString()}‚Ç¨ (prix + frais + travaux)</li>
            `;
        }

        function genererRecommandations(ville, rentaBrute, rentaNette, cashFlow, prix, surface, loyer) {
            const recommandationsDiv = document.getElementById('recommandations');
            const donnees = villesData[ville];
            const prixM2 = prix / surface;
            const ecartPrix = ((prixM2 - donnees.prixM2Moyen) / donnees.prixM2Moyen) * 100;
            
            let recommandations = [];

            // Analyse du prix
            if (ecartPrix > 15) {
                recommandations.push({
                    type: 'error',
                    titre: 'üö® Prix trop √©lev√©',
                    texte: `Le prix au m¬≤ (${Math.round(prixM2)}‚Ç¨) d√©passe de ${Math.round(ecartPrix)}% la moyenne du march√© (${donnees.prixM2Moyen}‚Ç¨). N√©gociez fortement !`
                });
            } else if (ecartPrix < -5) {
                recommandations.push({
                    type: 'success',
                    titre: '‚úÖ Excellent prix',
                    texte: `Vous achetez ${Math.abs(Math.round(ecartPrix))}% en-dessous du march√©. Tr√®s bonne affaire !`
                });
            }

            // Analyse rentabilit√©
            if (rentaBrute < 4) {
                recommandations.push({
                    type: 'warning',
                    titre: '‚ö†Ô∏è Rentabilit√© faible',
                    texte: `Rentabilit√© brute de ${rentaBrute.toFixed(1)}% insuffisante. Ciblez au minimum 5-6% en province.`
                });
            } else if (rentaBrute > 8) {
                recommandations.push({
                    type: 'success',
                    titre: 'üéØ Excellente rentabilit√©',
                    texte: `${rentaBrute.toFixed(1)}% de rentabilit√© brute, tr√®s au-dessus des moyennes !`
                });
            }

            // Analyse cash-flow
            if (cashFlow < -200) {
                recommandations.push({
                    type: 'error',
                    titre: 'üí∏ Cash-flow tr√®s n√©gatif',
                    texte: `${Math.round(cashFlow)}‚Ç¨/mois √† sortir de votre poche. R√©duisez le prix ou augmentez l'apport.`
                });
            } else if (cashFlow > 100) {
                recommandations.push({
                    type: 'success',
                    titre: 'üí∞ Cash-flow positif',
                    texte: `+${Math.round(cashFlow)}‚Ç¨/mois dans votre poche d√®s le premier jour !`
                });
            }

            // Recommandations par ville
            if (donnees.evolutionPrixValeur < 0) {
                recommandations.push({
                    type: 'warning',
                    titre: 'üìâ March√© en baisse',
                    texte: `Les prix ont baiss√© de ${Math.abs(donnees.evolutionPrixValeur)}% √† ${donnees.nom}. Attendez-vous √† une stagnation.`
                });
            }

            // Type de location
            const typeLocation = document.getElementById('typeLocation').value;
            if (typeLocation === 'colocation' && donnees.tauxOccupationColocation < 50) {
                recommandations.push({
                    type: 'info',
                    titre: 'üè† March√© colocation limit√©',
                    texte: `Seulement ${donnees.tauxOccupationColocation}% d'occupation en colocation √† ${donnees.nom}. Privil√©giez la location classique.`
                });
            }

            // Affichage
            if (recommandations.length === 0) {
                recommandationsDiv.innerHTML = '<div class="recommendation-item info">‚úÖ Investissement √©quilibr√© sans point d\'alerte majeur.</div>';
            } else {
                recommandationsDiv.innerHTML = recommandations.map(r => 
                    `<div class="recommendation-item ${r.type}">
                        <strong>${r.titre}</strong><br>${r.texte}
                    </div>`
                ).join('');
            }
        }

        function genererScenarios(data, ville) {
            const donnees = villesData[ville];
            const croissanceBase = donnees.croissancePrix;

            // Sc√©nario optimiste (+1.5% vs base)
            const optimiste = calculerScenario(data, croissanceBase + 1.5, 3, 2);
            
            // Sc√©nario r√©aliste (croissance normale)
            const realiste = calculerScenario(data, croissanceBase, 2, 5);
            
            // Sc√©nario pessimiste (-1% vs base)
            const pessimiste = calculerScenario(data, croissanceBase - 1, 1, 10);

            document.getElementById('scenarioOptimiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">+${optimiste.gainTotal.toLocaleString()}‚Ç¨</div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                    ‚Ä¢ Croissance prix : +${(croissanceBase + 1.5).toFixed(1)}%/an<br>
                    ‚Ä¢ √âvolution loyers : +3%/an<br>
                    ‚Ä¢ Vacance locative : 2%<br>
                    ‚Ä¢ Patrimoine 10 ans : <strong>${optimiste.patrimoine10ans.toLocaleString()}‚Ç¨</strong>
                </div>
            `;

            document.getElementById('scenarioRealiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">+${realiste.gainTotal.toLocaleString()}‚Ç¨</div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                    ‚Ä¢ Croissance prix : +${croissanceBase.toFixed(1)}%/an<br>
                    ‚Ä¢ √âvolution loyers : +2%/an<br>
                    ‚Ä¢ Vacance locative : 5%<br>
                    ‚Ä¢ Patrimoine 10 ans : <strong>${realiste.patrimoine10ans.toLocaleString()}‚Ç¨</strong>
                </div>
            `;

            document.getElementById('scenarioPessimiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">${pessimiste.gainTotal >= 0 ? '+' : ''}${pessimiste.gainTotal.toLocaleString()}‚Ç¨</div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                    ‚Ä¢ Croissance prix : +${(croissanceBase - 1).toFixed(1)}%/an<br>
                    ‚Ä¢ √âvolution loyers : +1%/an<br>
                    ‚Ä¢ Vacance locative : 10%<br>
                    ‚Ä¢ Patrimoine 10 ans : <strong>${pessimiste.patrimoine10ans.toLocaleString()}‚Ç¨</strong>
                </div>
            `;
        }

        function calculerScenario(data, croissancePrix, croissanceLoyers, tauxVacance) {
            const annees = 10;
            let cashflowCumule = 0;
            
            // Calcul ann√©e par ann√©e
            for (let i = 1; i <= annees; i++) {
                const loyersAnnee = data.loyersAnnuels * Math.pow(1 + croissanceLoyers/100, i);
                const loyersReels = loyersAnnee * (1 - tauxVacance/100); // Impact vacance
                const chargesAnnee = data.chargesAnnuelles * Math.pow(1.025, i); // +2.5%/an
                
                let mensualitesAnnee = data.mensualite * 12;
                // Fin du cr√©dit
                if (i > parseInt(document.getElementById('dureeEmprunt').value)) {
                    mensualitesAnnee = 0;
                }
                
                cashflowCumule += loyersReels - chargesAnnee - mensualitesAnnee;
            }
            
            const valeurBien10ans = data.prixTotal * Math.pow(1 + croissancePrix/100, annees);
            const patrimoine10ans = valeurBien10ans + cashflowCumule;
            const gainTotal = patrimoine10ans - data.apport;
            
            return {
                gainTotal: Math.round(gainTotal),
                patrimoine10ans: Math.round(patrimoine10ans),
                cashflowCumule: Math.round(cashflowCumule)
            };
        }

        function genererGraphiques(data) {
            // Graphique 1: √âvolution patrimoniale
            genererGraphiquePatrimoine(data);
            
            // Graphique 2: Cash-flow mensuel  
            genererGraphiqueCashflow(data);
            
            // Graphique 3: R√©partition rentabilit√©
            genererGraphiqueRentabilite(data);
            
            // Graphique 4: Projection long terme
            genererGraphiqueLongTerme(data);
        }

        function genererGraphiquePatrimoine(data) {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            
            if (projectionChart) {
                projectionChart.destroy();
            }

            const annees = [];
            const valeurs = [];
            const cashflows = [];

            for (let i = 0; i <= 10; i++) {
                annees.push(i);
                // Simulation simple
                const valeurBien = data.prixTotal * Math.pow(1.02, i);
                const cashflowCumule = i * (data.loyersAnnuels - data.chargesAnnuelles - data.mensualite * 12);
                valeurs.push(Math.round(valeurBien));
                cashflows.push(Math.round(cashflowCumule));
            }

            projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: annees,
                    datasets: [{
                        label: 'Valeur du bien',
                        data: valeurs,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Cash-flow cumul√©',
                        data: cashflows,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '√âvolution Patrimoniale'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function genererGraphiqueCashflow(data) {
            const ctx = document.getElementById('cashflowChart').getContext('2d');
            
            if (cashflowChart) {
                cashflowChart.destroy();
            }

            const mois = [];
            const cashflows = [];

            for (let i = 1; i <= 60; i++) { // 5 ans
                mois.push('Mois ' + i);
                const cashflowMensuel = data.loyersAnnuels/12 - data.chargesAnnuelles/12 - data.mensualite;
                cashflows.push(Math.round(cashflowMensuel));
            }

            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mois.filter((_, i) => i % 6 === 0), // On affiche 1 mois sur 6
                    datasets: [{
                        label: 'Cash-flow mensuel',
                        data: cashflows.filter((_, i) => i % 6 === 0),
                        backgroundColor: cashflows[0] >= 0 ? '#28a745' : '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cash-flow sur 5 ans'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function genererGraphiqueRentabilite(data) {
            const ctx = document.getElementById('rentabiliteChart').getContext('2d');
            
            if (rentabiliteChart) {
                rentabiliteChart.destroy();
            }

            const loyersAnnuels = data.loyersAnnuels;
            const chargesAnnuelles = data.chargesAnnuelles;
            const mensualitesAnnuelles = data.mensualite * 12;
            const beneficeNet = loyersAnnuels - chargesAnnuelles - mensualitesAnnuelles;

            rentabiliteChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Loyers', 'Charges', 'Cr√©dit', 'B√©n√©fice'],
                    datasets: [{
                        data: [
                            loyersAnnuels,
                            chargesAnnuelles,
                            mensualitesAnnuelles,
                            Math.max(0, beneficeNet)
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545',
                            '#ffc107',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'R√©partition Financi√®re Annuelle'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function genererGraphiqueLongTerme(data) {
            const ctx = document.getElementById('longTermChart').getContext('2d');
            
            if (longTermChart) {
                longTermChart.destroy();
            }

            const scenarios = ['Pessimiste', 'R√©aliste', 'Optimiste'];
            const gains = [];
            
            // Calcul simplified des gains sur 10 ans
            const ville = document.getElementById('ville').value;
            const donnees = villesData[ville];
            
            gains.push(Math.round(data.prixTotal * Math.pow(1.01, 10) - data.apport)); // Pessimiste
            gains.push(Math.round(data.prixTotal * Math.pow(1.02, 10) - data.apport)); // R√©aliste  
            gains.push(Math.round(data.prixTotal * Math.pow(1.035, 10) - data.apport)); // Optimiste

            longTermChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scenarios,
                    datasets: [{
                        label: 'Gain total sur 10 ans',
                        data: gains,
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Projections √† 10 ans'
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function exporterPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Titre
            doc.setFontSize(20);
            doc.text('Analyse Investissement Immobilier', 20, 30);

            // Informations g√©n√©rales
            const ville = document.getElementById('ville').value;
            const prix = document.getElementById('prix').value;
            const surface = document.getElementById('surface').value;
            const loyer = document.getElementById('loyerMensuel').value;

            doc.setFontSize(12);
            doc.text(`Ville: ${villesData[ville]?.nom || ''}`, 20, 50);
            doc.text(`Prix: ${parseInt(prix).toLocaleString()}‚Ç¨`, 20, 60);
            doc.text(`Surface: ${surface}m¬≤`, 20, 70);
            doc.text(`Loyer: ${loyer}‚Ç¨/mois`, 20, 80);

            // R√©sultats
            doc.text('R√âSULTATS:', 20, 100);
            doc.text(`Rentabilit√© brute: ${document.getElementById('rentaBrute').textContent}`, 20, 110);
            doc.text(`Rentabilit√© nette: ${document.getElementById('rentaNette').textContent}`, 20, 120);
            doc.text(`Cash-flow: ${document.getElementById('cashFlow').textContent}`, 20, 130);
            doc.text(`Score IA: ${document.getElementById('scoreCircle').textContent}`, 20, 140);

            doc.save('analyse-investissement.pdf');
        }

        function sauvegarderLocalement() {
            const data = {
                ville: document.getElementById('ville').value,
                prix: document.getElementById('prix').value,
                surface: document.getElementById('surface').value,
                loyerMensuel: document.getElementById('loyerMensuel').value,
                apport: document.getElementById('apport').value,
                tauxEmprunt: document.getElementById('tauxEmprunt').value,
                dureeEmprunt: document.getElementById('dureeEmprunt').value,
                fraisNotaire: document.getElementById('fraisNotaire').value,
                fraisAgence: document.getElementById('fraisAgence').value,
                travaux: document.getElementById('travaux').value,
                mobilier: document.getElementById('mobilier').value,
                chargesAnnuelles: document.getElementById('chargesAnnuelles').value,
                typeLocation: document.getElementById('typeLocation').value,
                nombreChambres: document.getElementById('nombreChambres').value,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('simulateur-immobilier-' + Date.now(), JSON.stringify(data));
            alert('‚úÖ Analyse sauvegard√©e localement !');
        }

        // Styles suppl√©mentaires pour l'affichage des villes
        const additionalStyles = `
            <style>
                .ville-recap {
                    background: #f8f9fa;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 15px 0;
                    border-left: 4px solid #667eea;
                }

                .ville-recap h4 {
                    color: #667eea;
                    margin-bottom: 15px;
                    font-size: 1.1rem;
                }

                .ville-stats {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                    margin-bottom: 15px;
                }

                .ville-stat {
                    text-align: center;
                    background: white;
                    padding: 10px;
                    border-radius: 8px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }

                .ville-stat .value {
                    font-size: 1.2rem;
                    font-weight: bold;
                    color: #333;
                }

                .ville-stat .label {
                    font-size: 0.8rem;
                    color: #666;
                    margin-top: 5px;
                }

                .evolution-positive {
                    color: #28a745;
                }

                .evolution-negative {
                    color: #dc3545;
                }

                .ville-fourchettes {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                }

                .ville-fourchettes h5 {
                    color: #667eea;
                    margin-bottom: 10px;
                    font-size: 0.95rem;
                }

                .fourchette-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    margin-bottom: 8px;
                    font-size: 0.85rem;
                }

                .data-source {
                    font-size: 0.8rem;
                    color: #6c757d;
                    text-align: center;
                    border-top: 1px solid #dee2e6;
                    padding-top: 10px;
                }

                .calculation-explanation {
                    background: white;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                }

                .calculation-explanation h5 {
                    color: #667eea;
                    margin-bottom: 15px;
                }

                .calculation-explanation ul {
                    list-style: none;
                    padding: 0;
                }

                .calculation-explanation
li {
                    margin-bottom: 8px;
                    padding: 8px;
                    background: #f8f9fa;
                    border-radius: 5px;
                    border-left: 3px solid #667eea;
                }

                .recommendation-item {
                    margin-bottom: 12px;
                    padding: 12px;
                    border-radius: 8px;
                }

                .recommendation-item.success {
                    background: #d4edda;
                    border-left: 4px solid #28a745;
                    color: #155724;
                }

                .recommendation-item.warning {
                    background: #fff3cd;
                    border-left: 4px solid #ffc107;
                    color: #856404;
                }

                .recommendation-item.error {
                    background: #f8d7da;
                    border-left: 4px solid #dc3545;
                    color: #721c24;
                }

                .recommendation-item.info {
                    background: #d1ecf1;
                    border-left: 4px solid #17a2b8;
                    color: #0c5460;
                }

                #colocationChambres {
                    display: none;
                    margin-top: 10px;
                    padding: 15px;
                    background: #e7f3ff;
                    border-radius: 8px;
                    border-left: 4px solid #007bff;
                }

                #colocationChambres label {
                    color: #007bff;
                    font-weight: 600;
                }

                .colocation-info {
                    font-size: 0.85rem;
                    color: #666;
                    margin-top: 5px;
                    font-style: italic;
                }

                @media (max-width: 768px) {
                    .ville-stats {
                        grid-template-columns: repeat(2, 1fr);
                    }
                    
                    .estimation-grille {
                        grid-template-columns: 1fr;
                    }
                    
                    .fourchette-row {
                        grid-template-columns: 1fr;
                    }
                }
            </style>
        `;

        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // Variables globales pour les graphiques
        let projectionChart = null;
        let cashflowChart = null;
        let rentabiliteChart = null;
        let longTermChart = null;

        // Donn√©es des villes avec informations colocations
        const villesData = {
            'cherbourg': {
                nom: 'Cherbourg-Octeville',
                prixM2Moyen: 2500,
                prixM2Min: 1800,
                prixM2Max: 3200,
                loyerM2Moyen: 12.5,
                loyerM2Min: 10,
                loyerM2Max: 15,
                loyerColocationParChambre: 320,
                loyerColocationMin: 280,
                loyerColocationMax: 380,
                tauxOccupationColocation: 65,
                evolutionPrix: '+7%',
                evolutionPrixValeur: 7,
                croissancePrix: 3.5,
                coeffMeublee: 1.25,
                coeffColocation: 1.35,
                coeffSaisonniere: 2.2,
                tension: 'Forte',
                population: 37500,
                taux_vacance: 4,
                dateMAJ: 'Janvier 2024'
            },
            'carentan': {
                nom: 'Carentan-les-Marais',
                prixM2Moyen: 1850,
                prixM2Min: 1400,
                prixM2Max: 2400,
                loyerM2Moyen: 11.2,
                loyerM2Min: 9,
                loyerM2Max: 13.5,
                loyerColocationParChambre: 260,
                loyerColocationMin: 220,
                loyerColocationMax: 300,
                tauxOccupationColocation: 40,
                evolutionPrix: '+3%',
                evolutionPrixValeur: 3,
                croissancePrix: 2.2,
                coeffMeublee: 1.22,
                coeffColocation: 1.30,
                coeffSaisonniere: 1.8,
                tension: 'Mod√©r√©e',
                population: 15800,
                taux_vacance: 6,
                dateMAJ: 'Janvier 2024'
            },
            'vire': {
                nom: 'Vire Normandie',
                prixM2Moyen: 1650,
                prixM2Min: 1200,
                prixM2Max: 2200,
                loyerM2Moyen: 10.8,
                loyerM2Min: 8.5,
                loyerM2Max: 13,
                loyerColocationParChambre: 240,
                loyerColocationMin: 200,
                loyerColocationMax: 280,
                tauxOccupationColocation: 35,
                evolutionPrix: '+1%',
                evolutionPrixValeur: 1,
                croissancePrix: 1.8,
                coeffMeublee: 1.20,
                coeffColocation: 1.25,
                coeffSaisonniere: 1.5,
                tension: 'Faible',
                population: 17500,
                taux_vacance: 8,
                dateMAJ: 'Janvier 2024'
            },
            'h√©rouville': {
                nom: 'H√©rouville-Saint-Clair',
                prixM2Moyen: 2803,
                prixM2Min: 2200,
                prixM2Max: 3500,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                loyerColocationParChambre: 340,
                loyerColocationMin: 300,
                loyerColocationMax: 380,
                tauxOccupationColocation: 75,
                evolutionPrix: '+2%',
                evolutionPrixValeur: 2,
                croissancePrix: 2.1,
                coeffMeublee: 1.28,
                coeffColocation: 1.40,
                coeffSaisonniere: 1.6,
                tension: 'Mod√©r√©e',
                population: 20800,
                taux_vacance: 5,
                dateMAJ: 'Janvier 2024'
            },
            'falaise': {
                nom: 'Falaise',
                prixM2Moyen: 1790,
                prixM2Min: 1300,
                prixM2Max: 2400,
                loyerM2Moyen: 9.5,
                loyerM2Min: 7.5,
                loyerM2Max: 12,
                loyerColocationParChambre: 270,
                loyerColocationMin: 230,
                loyerColocationMax: 310,
                tauxOccupationColocation: 50,
                evolutionPrix: '-12%',
                evolutionPrixValeur: -12,
                croissancePrix: 0.5,
                coeffMeublee: 1.18,
                coeffColocation: 1.28,
                coeffSaisonniere: 1.3,
                tension: 'Faible',
                population: 8200,
                taux_vacance: 9,
                dateMAJ: 'Janvier 2024'
            },
            'lisieux': {
                nom: 'Lisieux',
                prixM2Moyen: 2150,
                prixM2Min: 1600,
                prixM2Max: 2800,
                loyerM2Moyen: 10.5,
                loyerM2Min: 8,
                loyerM2Max: 13,
                loyerColocationParChambre: 290,
                loyerColocationMin: 250,
                loyerColocationMax: 330,
                tauxOccupationColocation: 60,
                evolutionPrix: '+4%',
                evolutionPrixValeur: 4,
                croissancePrix: 2.5,
                coeffMeublee: 1.24,
                coeffColocation: 1.32,
                coeffSaisonniere: 1.7,
                tension: 'Mod√©r√©e',
                population: 19500,
                taux_vacance: 6,
                dateMAJ: 'Janvier 2024'
            }
        };

        // Auto-calculs et int√©grations
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-calcul frais de notaire
            document.getElementById('prix').addEventListener('input', calculerEstimationPrix);
            
            // Auto-estimation loyer
            document.getElementById('ville').addEventListener('change', function() {
                estimerLoyer();
                afficherRecapVille();
            });
            document.getElementById('surface').addEventListener('input', estimerLoyer);
            document.getElementById('typeLocation').addEventListener('change', function() {
                afficherChampColocation();
                estimerLoyer();
            });
            document.getElementById('nombreChambres').addEventListener('input', estimerLoyer);
            
            // Initialisation
            afficherChampColocation();
            afficherRecapVille();
        });

    </script>
</body>
</html>
