<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Immobilier Pro - Normandie</title>
    
    <!-- CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .results {
            display: none;
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .results h3 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-card.green {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2d5016;
        }

        .metric-card.blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .metric-card.orange {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #8b4513;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }

        .recommendations {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .export-buttons {
            text-align: center;
            margin-top: 20px;
        }

        .export-btn {
            background: #28a745;
            margin: 0 10px;
            width: auto;
            padding: 10px 20px;
        }

        .ville-recap {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        #colocationChambres {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .colocation-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-home"></i> Simulateur Immobilier Pro</h1>
            <p>Calcul de rentabilit√© pr√©cis pour la Normandie</p>
        </div>

        <div class="main-content">
            <!-- Formulaire de saisie -->
            <div class="card">
                <h3><i class="fas fa-calculator"></i> Param√®tres du Bien</h3>
                
                <div class="form-group">
                    <label for="ville">Ville :</label>
                    <select id="ville" onchange="afficherRecapVille(); estimerLoyer();">
                        <option value="">S√©lectionnez une ville</option>
                        <option value="cherbourg">Cherbourg-Octeville</option>
                        <option value="carentan">Carentan-les-Marais</option>
                        <option value="vire">Vire Normandie</option>
                        <option value="h√©rouville">H√©rouville-Saint-Clair</option>
                        <option value="falaise">Falaise</option>
                        <option value="lisieux">Lisieux</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="prix">Prix d'achat (‚Ç¨) :</label>
                    <input type="number" id="prix" placeholder="ex: 150000" oninput="calculerFraisNotaire()">
                </div>

                <div class="form-group">
                    <label for="fraisNotaire">Frais de notaire (‚Ç¨) :</label>
                    <input type="number" id="fraisNotaire" placeholder="Calcul√© automatiquement">
                    <small style="color: #666; font-size: 0.8rem;">Auto-calcul√© : 8% ancien, 3% neuf</small>
                </div>

                <div class="form-group">
                    <label for="surface">Surface (m¬≤) :</label>
                    <input type="number" id="surface" placeholder="ex: 65" oninput="estimerLoyer()">
                </div>

                <div class="form-group">
                    <label for="typeLocation">Type de location :</label>
                    <select id="typeLocation" onchange="afficherChampColocation(); estimerLoyer();">
                        <option value="classique">Location classique</option>
                        <option value="meublee">Location meubl√©e</option>
                        <option value="colocation">Colocation</option>
                        <option value="saisonniere">Location saisonni√®re</option>
                    </select>
                </div>

                <div id="colocationChambres">
                    <label for="nombreChambres">Nombre de chambres √† louer :</label>
                    <input type="number" id="nombreChambres" min="1" max="10" placeholder="ex: 3" oninput="estimerLoyer()">
                    <div class="colocation-info">
                        Le loyer total sera calcul√© automatiquement selon les prix du march√© local
                    </div>
                </div>

                <div class="form-group">
                    <label for="loyerMensuel">Loyer mensuel estim√© (‚Ç¨) :</label>
                    <input type="number" id="loyerMensuel" placeholder="Calcul√© automatiquement">
                </div>
            </div>

            <!-- Financement -->
            <div class="card">
                <h3><i class="fas fa-piggy-bank"></i> Financement</h3>
                
                <div class="form-group">
                    <label for="apport">Apport personnel (‚Ç¨) :</label>
                    <input type="number" id="apport" placeholder="ex: 30000">
                </div>

                <div class="form-group">
                    <label for="tauxEmprunt">Taux d'emprunt (%) :</label>
                    <input type="number" id="tauxEmprunt" step="0.1" placeholder="ex: 3.5">
                </div>

                <div class="form-group">
                    <label for="dureeEmprunt">Dur√©e (ann√©es) :</label>
                    <input type="number" id="dureeEmprunt" placeholder="ex: 20">
                </div>

                <div class="form-group">
                    <label for="fraisAgence">Frais d'agence (‚Ç¨) :</label>
                    <input type="number" id="fraisAgence" placeholder="ex: 5000">
                </div>

                <div class="form-group">
                    <label for="travaux">Travaux (‚Ç¨) :</label>
                    <input type="number" id="travaux" placeholder="ex: 10000">
                </div>

                <div class="form-group">
                    <label for="mobilier">Mobilier/√âquipement (‚Ç¨) :</label>
                    <input type="number" id="mobilier" placeholder="ex: 5000">
                </div>

                <div class="form-group">
                    <label for="chargesAnnuelles">Charges annuelles (‚Ç¨) :</label>
                    <input type="number" id="chargesAnnuelles" placeholder="ex: 2400">
                </div>

                <button class="btn" onclick="calculerRentabilite()">
                    <i class="fas fa-chart-line"></i> Calculer la Rentabilit√©
                </button>
            </div>
        </div>

        <!-- R√©cap ville -->
        <div id="recapVille" class="ville-recap"></div>

        <!-- R√©sultats -->
        <div id="results" class="results">
            <h3><i class="fas fa-chart-bar"></i> Analyse de Rentabilit√©</h3>
            
            <div class="metrics-grid">
                <div class="metric-card blue">
                    <div class="metric-value" id="rentaBrute">-</div>
                    <div class="metric-label">Rentabilit√© Brute</div>
                </div>
                <div class="metric-card green">
                    <div class="metric-value" id="rentaNette">-</div>
                    <div class="metric-label">Rentabilit√© Nette</div>
                </div>
                <div class="metric-card orange">
                    <div class="metric-value" id="cashFlow">-</div>
                    <div class="metric-label">Cash-Flow Mensuel</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rentaReelle">-</div>
                    <div class="metric-label">Rentabilit√© sur Apport</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="projectionChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="cashflowChart"></canvas>
                </div>
                <div class="chart-container full-width-chart">
                    <canvas id="longTermChart"></canvas>
                </div>
            </div>

            <div class="recommendations">
                <h4><i class="fas fa-lightbulb"></i> Recommandations IA</h4>
                <div id="recommendations-content"></div>
            </div>

            <div class="export-buttons">
                <button class="btn export-btn" onclick="exporterPDF()">
                    <i class="fas fa-file-pdf"></i> Exporter PDF
                </button>
                <button class="btn export-btn" onclick="exporterExcel()">
                    <i class="fas fa-file-excel"></i> Exporter Excel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales pour les graphiques
        let projectionChart = null;
        let cashflowChart = null;
        let longTermChart = null;

        // Donn√©es des villes avec informations colocations
        const villesData = {
            'cherbourg': {
                nom: 'Cherbourg-Octeville',
                prixM2Moyen: 2500,
                prixM2Min: 1800,
                prixM2Max: 3200,
                loyerM2Moyen: 12.5,
                loyerM2Min: 10,
                loyerM2Max: 15,
                loyerColocationParChambre: 320,
                loyerColocationMin: 280,
                loyerColocationMax: 380,
                surfaceChambreMoyenne: '12-15 m¬≤',
                tauxOccupationColocation: 65,
                evolutionPrix: '+7%',
                evolutionPrixValeur: 7,
                croissancePrix: 3.5,
                coeffMeublee: 1.25,
                coeffColocation: 1.35,
                coeffSaisonniere: 2.2,
                tension: 'Forte',
                population: 37500,
                taux_vacance: 4,
                dateMAJ: 'Janvier 2024'
            },
            'carentan': {
                nom: 'Carentan-les-Marais',
                prixM2Moyen: 1850,
                prixM2Min: 1400,
                prixM2Max: 2400,
                loyerM2Moyen: 11.2,
                loyerM2Min: 9,
                loyerM2Max: 13.5,
                loyerColocationParChambre: 260,
                loyerColocationMin: 220,
                loyerColocationMax: 300,
                surfaceChambreMoyenne: '10-14 m¬≤',
                tauxOccupationColocation: 40,
                evolutionPrix: '+3%',
                evolutionPrixValeur: 3,
                croissancePrix: 2.2,
                coeffMeublee: 1.22,
                coeffColocation: 1.30,
                coeffSaisonniere: 1.8,
                tension: 'Mod√©r√©e',
                population: 15800,
                taux_vacance: 6,
                dateMAJ: 'Janvier 2024'
            },
            'vire': {
                nom: 'Vire Normandie',
                prixM2Moyen: 1650,
                prixM2Min: 1200,
                prixM2Max: 2200,
                loyerM2Moyen: 10.8,
                loyerM2Min: 8.5,
                loyerM2Max: 13,
                loyerColocationParChambre: 240,
                loyerColocationMin: 200,
                loyerColocationMax: 280,
                surfaceChambreMoyenne: '12-16 m¬≤',
                tauxOccupationColocation: 35,
                evolutionPrix: '+1%',
                evolutionPrixValeur: 1,
                croissancePrix: 1.8,
                coeffMeublee: 1.20,
                coeffColocation: 1.25,
                coeffSaisonniere: 1.5,
                tension: 'Faible',
                population: 17500,
                taux_vacance: 8,
                dateMAJ: 'Janvier 2024'
            },
            'h√©rouville': {
                nom: 'H√©rouville-Saint-Clair',
                prixM2Moyen: 2803,
                prixM2Min: 2200,
                prixM2Max: 3500,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                loyerColocationParChambre: 340,
                loyerColocationMin: 300,
                loyerColocationMax: 380,
                surfaceChambreMoyenne: '14-18 m¬≤',
                tauxOccupationColocation: 75,
                evolutionPrix: '+2%',
                evolutionPrixValeur: 2,
                croissancePrix: 2.1,
                coeffMeublee: 1.28,
                coeffColocation: 1.40,
                coeffSaisonniere: 1.6,
                tension: 'Mod√©r√©e',
                population: 20800,
                taux_vacance: 5,
                dateMAJ: 'Janvier 2024'
            },
            'falaise': {
                nom: 'Falaise',
                prixM2Moyen: 1790,
                prixM2Min: 1300,
                prixM2Max: 2400,
                loyerM2Moyen: 9.5,
                loyerM2Min: 7.5,
                loyerM2Max: 12,
                loyerColocationParChambre: 270,
                loyerColocationMin: 230,
                loyerColocationMax: 310,
                surfaceChambreMoyenne: '11-13 m¬≤',
                tauxOccupationColocation: 50,
                evolutionPrix: '-12%',
                evolutionPrixValeur: -12,
                croissancePrix: 0.5,
                coeffMeublee: 1.18,
                coeffColocation: 1.28,
                coeffSaisonniere: 1.3,
                tension: 'Faible',
                population: 8200,
                taux_vacance: 9,
                dateMAJ: 'Janvier 2024'
            },
            'lisieux': {
                nom: 'Lisieux',
                prixM2Moyen: 2150,
                prixM2Min: 1600,
                prixM2Max: 2800,
                loyerM2Moyen: 10.5,
                loyerM2Min: 8,
                loyerM2Max: 13,
                loyerColocationParChambre: 290,
                loyerColocationMin: 250,
                loyerColocationMax: 330,
                surfaceChambreMoyenne: '12-14 m¬≤',
                tauxOccupationColocation: 60,
                evolutionPrix: '+4%',
                evolutionPrixValeur: 4,
                croissancePrix: 2.5,
                coeffMeublee: 1.24,
                coeffColocation: 1.32,
                coeffSaisonniere: 1.7,
                tension: 'Mod√©r√©e',
                population: 19500,
                taux_vacance: 6,
                dateMAJ: 'Janvier 2024'
            }
        };

        function calculerFraisNotaire() {
            const prix = parseFloat(document.getElementById('prix').value);
            if (prix > 0) {
                // Estimation frais de notaire : 8% pour ancien (par d√©faut)
                const fraisNotaire = Math.round(prix * 0.08);
                document.getElementById('fraisNotaire').value = fraisNotaire;
            }
        }

        function afficherChampColocation() {
            const typeLocation = document.getElementById('typeLocation').value;
            const champColocation = document.getElementById('colocationChambres');
            
            if (typeLocation === 'colocation') {
                champColocation.style.display = 'block';
            } else {
                champColocation.style.display = 'none';
                document.getElementById('nombreChambres').value = '';
            }
        }

        function estimerLoyer() {
            const ville = document.getElementById('ville').value;
            const surface = parseFloat(document.getElementById('surface').value);
            const typeLocation = document.getElementById('typeLocation').value;
            const nombreChambres = parseInt(document.getElementById('nombreChambres').value) || 0;
            
            if (!ville || !villesData[ville] || !surface) return;
            
            const donnees = villesData[ville];
            let loyerEstime = 0;
            
            switch(typeLocation) {
                case 'classique':
                    loyerEstime = surface * donnees.loyerM2Moyen;
                    break;
                case 'meublee':
                    loyerEstime = surface * donnees.loyerM2Moyen * donnees.coeffMeublee;
                    break;
                case 'colocation':
                    if (nombreChambres > 0) {
                        // Calcul pr√©cis : nombre de chambres √ó loyer par chambre
                        loyerEstime = nombreChambres * donnees.loyerColocationParChambre;
                    } else {
                        loyerEstime = surface * donnees.loyerM2Moyen * donnees.coeffColocation;
                    }
                    break;
                case 'saisonniere':
                    loyerEstime = surface * donnees.loyerM2Moyen * donnees.coeffSaisonniere;
                    break;
            }
            
            document.getElementById('loyerMensuel').value = Math.round(loyerEstime);
        }

        function afficherRecapVille() {
            const ville = document.getElementById('ville').value;
            const recapDiv = document.getElementById('recapVille');
            
            if (!ville || !villesData[ville]) {
                recapDiv.style.display = 'none';
                return;
            }

            const donnees = villesData[ville];
            recapDiv.style.display = 'block';
            recapDiv.innerHTML = `
                <h4><i class="fas fa-map-marker-alt"></i> ${donnees.nom}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${donnees.prixM2Moyen}‚Ç¨/m¬≤</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Prix moyen</div>
                        <div style="font-size: 0.8rem;">de ${donnees.prixM2Min}‚Ç¨ √† ${donnees.prixM2Max}‚Ç¨</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${donnees.loyerM2Moyen}‚Ç¨/m¬≤</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Loyer moyen</div>
                        <div style="font-size: 0.8rem;">de ${donnees.loyerM2Min}‚Ç¨ √† ${donnees.loyerM2Max}‚Ç¨</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${donnees.loyerColocationParChambre}‚Ç¨</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Colocation/chambre</div>
                        <div style="font-size: 0.8rem;">de ${donnees.loyerColocationMin}‚Ç¨ √† ${donnees.loyerColocationMax}‚Ç¨</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${donnees.evolutionPrixValeur >= 0 ? '#28a745' : '#dc3545'};">
                            ${donnees.evolutionPrix}
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">√âvolution prix</div>
                        <div style="font-size: 0.8rem;">Taux occupation: ${donnees.tauxOccupationColocation}%</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                    <strong>Colocation :</strong> Surface moyenne des chambres ${donnees.surfaceChambreMoyenne} ‚Ä¢ 
                    Tension locative : ${donnees.tension} ‚Ä¢ 
                    Population : ${donnees.population.toLocaleString()} hab.
                </div>
            `;
        }

        function calculerRentabilite() {
            // R√©cup√©ration des donn√©es
            const ville = document.getElementById('ville').value;
            const prix = parseFloat(document.getElementById('prix').value);
            const fraisNotaire = parseFloat(document.getElementById('fraisNotaire').value) || 0;
            const surface = parseFloat(document.getElementById('surface').value);
            const loyerMensuel = parseFloat(document.getElementById('loyerMensuel').value);
            const apport = parseFloat(document.getElementById('apport').value);
            const tauxEmprunt = parseFloat(document.getElementById('tauxEmprunt').value) / 100;
            const dureeEmprunt = parseInt(document.getElementById('dureeEmprunt').value);
            const fraisAgence = parseFloat(document.getElementById('fraisAgence').value) || 0;
            const travaux = parseFloat(document.getElementById('travaux').value) || 0;
            const mobilier = parseFloat(document.getElementById('mobilier').value) || 0;
            const chargesAnnuelles = parseFloat(document.getElementById('chargesAnnuelles').value) || 0;
            const nombreChambres = parseInt(document.getElementById('nombreChambres').value) || 0;

            // Validation
            if (!ville || !prix || !surface || !loyerMensuel || !apport) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            // Calculs avec frais de notaire int√©gr√©s
            const montantTotal = prix + fraisNotaire + fraisAgence + travaux + mobilier;
            const montantEmprunte = montantTotal - apport;
            const loyersAnnuels = loyerMensuel * 12;
            
            // Mensualit√© d'emprunt
            let mensualite = 0;
            if (montantEmprunte > 0 && tauxEmprunt > 0) {
                const tauxMensuel = tauxEmprunt / 12;
                const nbMensualites = dureeEmprunt * 12;
                mensualite = montantEmprunte * (tauxMensuel * Math.pow(1 + tauxMensuel, nbMensualites)) / (Math.pow(1 + tauxMensuel, nbMensualites) - 1);
            }

            // Rentabilit√©s
            const rentaBrute = (loyersAnnuels / montantTotal) * 100;
            const rentaNette = ((loyersAnnuels - chargesAnnuelles) / montantTotal) * 100;
            const cashFlowMensuel = loyerMens
            uel - mensualite - (chargesAnnuelles / 12);
            const rentaSurApport = ((loyersAnnuels - chargesAnnuelles - (mensualite * 12)) / apport) * 100;

            // Affichage des r√©sultats
            document.getElementById('rentaBrute').textContent = rentaBrute.toFixed(1) + '%';
            document.getElementById('rentaNette').textContent = rentaNette.toFixed(1) + '%';
            document.getElementById('cashFlow').textContent = cashFlowMensuel.toFixed(0) + '‚Ç¨';
            document.getElementById('rentaReelle').textContent = rentaSurApport.toFixed(1) + '%';

            // Affichage du bloc r√©sultats
            document.getElementById('results').style.display = 'block';

            // G√©n√©ration des graphiques
            genererGraphiques(ville, prix, loyerMensuel, mensualite, chargesAnnuelles, apport, montantTotal);

            // G√©n√©ration des recommandations
            genererRecommandations(ville, rentaBrute, rentaNette, cashFlowMensuel, nombreChambres);

            // Scroll vers les r√©sultats
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function genererGraphiques(ville, prix, loyerMensuel, mensualite, chargesAnnuelles, apport, montantTotal) {
            const donnees = villesData[ville];
            
            // D√©truire les graphiques existants
            if (projectionChart) projectionChart.destroy();
            if (cashflowChart) cashflowChart.destroy();
            if (longTermChart) longTermChart.destroy();

            // Graphique 1: √âvolution patrimoine sur 10 ans
            const ctx1 = document.getElementById('projectionChart').getContext('2d');
            const years = [];
            const prixBien = [];
            const capitalRembourse = [];
            
            for (let i = 0; i <= 10; i++) {
                years.push(i);
                prixBien.push(prix * Math.pow(1 + donnees.croissancePrix/100, i));
                capitalRembourse.push(apport + (mensualite * 12 * i * 0.6)); // Approximation
            }

            projectionChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Valeur du bien',
                        data: prixBien,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Capital d√©tenu',
                        data: capitalRembourse,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: '√âvolution Patrimoine (10 ans)' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });

            // Graphique 2: Cash-flow mensuel
            const ctx2 = document.getElementById('cashflowChart').getContext('2d');
            const mois = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
            const cashflowData = Array(12).fill(loyerMensuel - mensualite - (chargesAnnuelles/12));

            cashflowChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: mois,
                    datasets: [{
                        label: 'Cash-flow mensuel',
                        data: cashflowData,
                        backgroundColor: cashflowData[0] >= 0 ? 
                            'rgba(40, 167, 69, 0.7)' : 
                            'rgba(220, 53, 69, 0.7)',
                        borderColor: cashflowData[0] >= 0 ? 
                            '#28a745' : 
                            '#dc3545',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Cash-Flow Mensuel' }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });

            // Graphique 3: Simulation long terme (25 ans)
            const ctx3 = document.getElementById('longTermChart').getContext('2d');
            const anneesLongue = [];
            const gainsCumules = [];
            const valeurBien = [];
            
            let cumul = 0;
            for (let i = 0; i <= 25; i++) {
                anneesLongue.push(2024 + i);
                cumul += (loyerMensuel * 12) - (mensualite * 12) - chargesAnnuelles;
                gainsCumules.push(cumul);
                valeurBien.push(prix * Math.pow(1 + donnees.croissancePrix/100, i));
            }

            longTermChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: anneesLongue,
                    datasets: [{
                        label: 'Gains cumul√©s',
                        data: gainsCumules,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Valeur bien',
                        data: valeurBien,
                        borderColor: '#17a2b8',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Projection Long Terme (25 ans)' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function genererRecommandations(ville, rentaBrute, rentaNette, cashFlowMensuel, nombreChambres) {
            const donnees = villesData[ville];
            const typeLocation = document.getElementById('typeLocation').value;
            let recommendations = [];

            // Analyse rentabilit√©
            if (rentaNette >= 8) {
                recommendations.push({
                    type: 'success',
                    title: 'üéØ Excellent investissement !',
                    content: `Rentabilit√© nette de ${rentaNette.toFixed(1)}% tr√®s attractive. Ce projet pr√©sente un potentiel de gains √©lev√©.`
                });
            } else if (rentaNette >= 5) {
                recommendations.push({
                    type: 'info',
                    title: '‚úÖ Investissement correct',
                    content: `Rentabilit√© nette de ${rentaNette.toFixed(1)}% dans la moyenne du march√© normand.`
                });
            } else {
                recommendations.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Rentabilit√© faible',
                    content: `Rentabilit√© nette de ${rentaNette.toFixed(1)}% en dessous des standards. Consid√©rez ren√©gocier le prix ou optimiser les loyers.`
                });
            }

            // Cash-flow
            if (cashFlowMensuel < -200) {
                recommendations.push({
                    type: 'error',
                    title: 'üö® Cash-flow tr√®s n√©gatif',
                    content: `Effort mensuel de ${Math.abs(cashFlowMensuel).toFixed(0)}‚Ç¨. Augmentez l'apport ou ren√©gociez les conditions.`
                });
            } else if (cashFlowMensuel < 0) {
                recommendations.push({
                    type: 'warning',
                    title: 'üí° Cash-flow n√©gatif',
                    content: `Effort mensuel de ${Math.abs(cashFlowMensuel).toFixed(0)}‚Ç¨. Acceptable si vous visez la plus-value long terme.`
                });
            } else {
                recommendations.push({
                    type: 'success',
                    title: 'üí∞ Cash-flow positif',
                    content: `Gain mensuel de ${cashFlowMensuel.toFixed(0)}‚Ç¨. Votre investissement se finance seul !`
                });
            }

            // Recommandations sp√©cifiques colocations
            if (typeLocation === 'colocation') {
                if (donnees.tauxOccupationColocation >= 70) {
                    recommendations.push({
                        type: 'success',
                        title: 'üè† March√© colocation favorable',
                        content: `Taux d'occupation de ${donnees.tauxOccupationColocation}% √† ${donnees.nom}. ${nombreChambres} chambres √† ${donnees.loyerColocationParChambre}‚Ç¨/mois chacune.`
                    });
                } else if (donnees.tauxOccupationColocation >= 50) {
                    recommendations.push({
                        type: 'info',
                        title: 'üè† March√© colocation mod√©r√©',
                        content: `Taux d'occupation de ${donnees.tauxOccupationColocation}% √† ${donnees.nom}. Pr√©voyez 1-2 mois de vacance locative par an.`
                    });
                } else {
                    recommendations.push({
                        type: 'warning',
                        title: '‚ö†Ô∏è March√© colocation difficile',
                        content: `Seulement ${donnees.tauxOccupationColocation}% d'occupation √† ${donnees.nom}. Consid√©rez la location classique ou meubl√©e.`
                    });
                }

                if (nombreChambres >= 4) {
                    recommendations.push({
                        type: 'info',
                        title: 'üõèÔ∏è Gestion complexe',
                        content: `${nombreChambres} chambres n√©cessitent une gestion active. Consid√©rez une agence sp√©cialis√©e ou un gestionnaire.`
                    });
                }
            }

            // Recommandations sp√©cifiques par ville
            switch(ville) {
                case 'cherbourg':
                    recommendations.push({
                        type: 'info',
                        title: '‚öì Sp√©cificit√© Cherbourg',
                        content: 'Fort potentiel √©tudiant et maritime. Zone Cite de la Mer tr√®s demand√©e. Pr√©voyez isolation phonique.'
                    });
                    break;
                case 'h√©rouville':
                    recommendations.push({
                        type: 'success',
                        title: 'üéì Sp√©cificit√© H√©rouville',
                        content: 'Leader r√©gional colocation (40% des annonces). Proximit√© Caen = forte demande √©tudiante garantie.'
                    });
                    break;
                case 'vire':
                    recommendations.push({
                        type: 'warning',
                        title: 'üåæ Sp√©cificit√© Vire',
                        content: 'March√© rural moins tendu. Privil√©giez maisons avec jardin. Colocation difficile (35% occupation).'
                    });
                    break;
            }

            // Evolution du march√©
            if (donnees.evolutionPrixValeur >= 5) {
                recommendations.push({
                    type: 'success',
                    title: 'üìà March√© dynamique',
                    content: `Prix en hausse de ${donnees.evolutionPrix} sur 12 mois. Plus-value potentielle int√©ressante.`
                });
            } else if (donnees.evolutionPrixValeur < 0) {
                recommendations.push({
                    type: 'warning',
                    title: 'üìâ March√© en baisse',
                    content: `Prix en baisse de ${Math.abs(donnees.evolutionPrixValeur)}%. Opportunit√© d'achat mais plus-value incertaine.`
                });
            }

            // Affichage des recommandations
            const container = document.getElementById('recommendations-content');
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item ${rec.type}">
                    <strong>${rec.title}</strong><br>
                    ${rec.content}
                </div>
            `).join('');
        }

        function exporterPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Configuration
            const ville = document.getElementById('ville').value;
            const donnees = villesData[ville];
            const prix = parseFloat(document.getElementById('prix').value);
            const surface = parseFloat(document.getElementById('surface').value);
            const loyerMensuel = parseFloat(document.getElementById('loyerMensuel').value);
            const typeLocation = document.getElementById('typeLocation').value;

            // En-t√™te
            pdf.setFontSize(20);
            pdf.setTextColor(102, 126, 234);
            pdf.text('ANALYSE DE RENTABILIT√â IMMOBILI√àRE', 20, 30);
            
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Ville: ${donnees.nom}`, 20, 50);
            pdf.text(`Date d'analyse: ${new Date().toLocaleDateString('fr-FR')}`, 20, 60);

            // Caract√©ristiques du bien
            pdf.setFontSize(14);
            pdf.setTextColor(102, 126, 234);
            pdf.text('CARACT√âRISTIQUES DU BIEN', 20, 80);
            
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            let yPos = 95;
            pdf.text(`‚Ä¢ Prix d'achat: ${prix.toLocaleString()} ‚Ç¨`, 25, yPos);
            pdf.text(`‚Ä¢ Surface: ${surface} m¬≤`, 25, yPos + 10);
            pdf.text(`‚Ä¢ Type: ${typeLocation}`, 25, yPos + 20);
            pdf.text(`‚Ä¢ Loyer mensuel: ${loyerMensuel.toLocaleString()} ‚Ç¨`, 25, yPos + 30);

            // R√©sultats
            yPos += 50;
            pdf.setFontSize(14);
            pdf.setTextColor(102, 126, 234);
            pdf.text('R√âSULTATS FINANCIERS', 20, yPos);
            
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            yPos += 15;
            pdf.text(`‚Ä¢ Rentabilit√© brute: ${document.getElementById('rentaBrute').textContent}`, 25, yPos);
            pdf.text(`‚Ä¢ Rentabilit√© nette: ${document.getElementById('rentaNette').textContent}`, 25, yPos + 10);
            pdf.text(`‚Ä¢ Cash-flow mensuel: ${document.getElementById('cashFlow').textContent}`, 25, yPos + 20);
            pdf.text(`‚Ä¢ Rentabilit√© sur apport: ${document.getElementById('rentaReelle').textContent}`, 25, yPos + 30);

            // Donn√©es march√©
            yPos += 50;
            pdf.setFontSize(14);
            pdf.setTextColor(102, 126, 234);
            pdf.text('DONN√âES DE MARCH√â', 20, yPos);
            
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            yPos += 15;
            pdf.text(`‚Ä¢ Prix moyen: ${donnees.prixM2Moyen} ‚Ç¨/m¬≤ (${donnees.prixM2Min}-${donnees.prixM2Max} ‚Ç¨/m¬≤)`, 25, yPos);
            pdf.text(`‚Ä¢ Loyer moyen: ${donnees.loyerM2Moyen} ‚Ç¨/m¬≤ (${donnees.loyerM2Min}-${donnees.loyerM2Max} ‚Ç¨/m¬≤)`, 25, yPos + 10);
            
            if (typeLocation === 'colocation') {
                pdf.text(`‚Ä¢ Colocation: ${donnees.loyerColocationParChambre} ‚Ç¨/chambre (${donnees.loyerColocationMin}-${donnees.loyerColocationMax} ‚Ç¨)`, 25, yPos + 20);
                pdf.text(`‚Ä¢ Taux d'occupation: ${donnees.tauxOccupationColocation}%`, 25, yPos + 30);
            }

            // Pied de page
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Simulateur Immobilier Pro - Donn√©es Normandie 2024', 20, 280);

            pdf.save(`Analyse-Rentabilite-${donnees.nom}-${new Date().toISOString().slice(0,10)}.pdf`);
        }

        function exporterExcel() {
            // Pr√©paration des donn√©es
            const ville = document.getElementById('ville').value;
            const donnees = villesData[ville];
            
            const data = {
                'Param√®tres': {
                    'Ville': donnees.nom,
                    'Prix d\'achat': parseFloat(document.getElementById('prix').value),
                    'Frais de notaire': parseFloat(document.getElementById('fraisNotaire').value),
                    'Surface': parseFloat(document.getElementById('surface').value),
                    'Type de location': document.getElementById('typeLocation').value,
                    'Loyer mensuel': parseFloat(document.getElementById('loyerMensuel').value),
                    'Apport': parseFloat(document.getElementById('apport').value)
                },
                'R√©sultats': {
                    'Rentabilit√© brute': document.getElementById('rentaBrute').textContent,
                    'Rentabilit√© nette': document.getElementById('rentaNette').textContent,
                    'Cash-flow mensuel': document.getElementById('cashFlow').textContent,
                    'Rentabilit√© sur apport': document.getElementById('rentaReelle').textContent
                },
                'March√©': {
                    'Prix m¬≤ moyen': donnees.prixM2Moyen,
                    'Loyer m¬≤ moyen': donnees.loyerM2Moyen,
                    '√âvolution prix': donnees.evolutionPrix,
                    'Tension locative': donnees.tension,
                    'Population': donnees.population
                }
            };

            // Cr√©ation CSV simple
            let csvContent = "data:text/csv;charset=utf-8,";
            
            Object.keys(data).forEach(section => {
                csvContent += section + "\n";
                Object.keys(data[section]).forEach(key => {
                    csvContent += key + ";" + data[section][key] + "\n";
                });
                csvContent += "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `analyse-rentabilite-${donnees.nom}-${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Styles CSS additionnels pour les recommandations
        const additionalStyles = `
            <style>
                .recommendation-item {
                    margin-bottom: 12px;
                    padding: 12px;
                    border-radius: 8px;
                }
                
                .recommendation-item.success {
                    background: #d4edda;
                    border-left: 4px solid #28a745;
                    color: #155724;
                }
                
                .recommendation-item.warning {
                    background: #fff3cd;
                    border-left: 4px solid #ffc107;
                    color: #856404;
                }
                
                .recommendation-item.error {
                    background: #f8d7da;
                    border-left: 4px solid #dc3545;
                    color: #721c24;
                }
                
                .recommendation-item.info {
                    background: #d1ecf1;
                    border-left: 4px solid #17a2b8;
                    color: #0c5460;
                }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            afficherChampColocation();
            
            // Auto-calcul frais de notaire
            document.getElementById('prix').addEventListener('input', calculerFraisNotaire);
        });
    </script>
</body>
</html>
