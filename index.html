# simulateur-rentabilite-immobiliere
Description: Simulateur de rentabilit√© pour investissement immobilier
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Immobilier Pro - Normandie</title>
    
    <!-- CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .result-item {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-5px);
        }

        .result-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .result-label {
            color: #666;
            font-size: 0.9rem;
        }

        .score-container {
            text-align: center;
            margin: 30px 0;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .scenarios-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .scenario-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .scenario-title {
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .scenario-optimiste .scenario-title { background: #d4edda; color: #155724; }
        .scenario-realiste .scenario-title { background: #fff3cd; color: #856404; }
        .scenario-pessimiste .scenario-title { background: #f8d7da; color: #721c24; }

        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
        }

        .recommendations {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .recommendation-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .city-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .scenarios-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .footer {
            background: rgba(255,255,255,0.1);
            color: white;
            text-align: center;
            padding: 40px 20px;
            margin-top: 50px;
            border-radius: 20px 20px 0 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-home"></i> Simulateur Immobilier Pro Normandie</h1>
            <p>Analyse avanc√©e avec IA pr√©dictive et projections multi-sc√©narios</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2><i class="fas fa-calculator"></i> Param√®tres du Bien</h2>
                
                <div class="form-group">
                    <label for="ville">
                        Ville en Normandie 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">S√©lectionnez votre ville pour obtenir des donn√©es de march√© pr√©cises</span>
                        </span>
                    </label>
                    <select id="ville" onchange="calculerEtAnalyser()">
                        <option value="">Choisir une ville...</option>
                        <option value="falaise">Falaise</option>
                        <option value="vire">Vire en Normandie</option>
                        <option value="lisieux">Lisieux</option>
                        <option value="herouville">H√©rouville Saint-Clair</option>
                        <option value="cherbourg">Cherbourg-en-Cotentin</option>
                        <option value="carentan">Carentan-les-Marais</option>
                    </select>
                </div>

                <div class="city-info" id="cityInfo" style="display: none;"></div>

                <div class="form-group">
                    <label for="prix">
                        Prix d'achat (‚Ç¨) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Prix total d'acquisition du bien immobilier</span>
                        </span>
                    </label>
                    <input type="number" id="prix" placeholder="ex: 200000" oninput="calculerEtAnalyser()">
                </div>

                <div class="form-group">
                    <label for="surface">
                        Surface (m¬≤) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Surface habitable pour calcul du prix/m¬≤ et analyse march√©</span>
                        </span>
                    </label>
                    <input type="number" id="surface" placeholder="ex: 80" oninput="calculerEtAnalyser()">
                </div>

                <div class="form-group">
                    <label for="apport">
                        Apport personnel (‚Ç¨) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Montant de votre investissement personnel initial</span>
                        </span>
                    </label>
                    <input type="number" id="apport" placeholder="ex: 40000" oninput="calculerEtAnalyser()">
                </div>

                <div class="form-group">
                    <label for="loyerMensuel">
                        Loyer mensuel (‚Ç¨) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Loyer mensuel hors charges que vous percevrez</span>
                        </span>
                    </label>
                    <input type="number" id="loyerMensuel" placeholder="ex: 800" oninput="calculerEtAnalyser()">
                </div>

                <div class="form-group">
                    <label for="chargesAnnuelles">
                        Charges annuelles (‚Ç¨) 
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Taxes, assurances, syndic, entretien...</span>
                        </span>
                    </label>
                    <input type="number" id="chargesAnnuelles" placeholder="ex: 2000" oninput="calculerEtAnalyser()">
                </div>

                <div class="form-group">
                    <label for="tauxEmprunt">Taux d'emprunt (%) <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Taux d'int√©r√™t annuel de votre cr√©dit immobilier</span>
                        </span>
                    </label>
                    <input type="number" step="0.01" id="tauxEmprunt" placeholder="ex: 3.5" oninput="calculerEtAnalyser()">
                </div>

                <div class="form-group">
                    <label for="dureeEmprunt">Dur√©e d'emprunt (ann√©es)</label>
                    <input type="number" id="dureeEmprunt" placeholder="ex: 20" oninput="calculerEtAnalyser()">
                </div>

                <button class="btn" onclick="calculerEtAnalyser()">
                    <i class="fas fa-chart-line"></i> Analyser l'investissement
                </button>
                
                <button class="btn" onclick="exporterExcel()">
                    <i class="fas fa-file-excel"></i> Exporter Excel
                </button>
            </div>

            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> R√©sultats Instantan√©s</h2>
                
                <div class="results">
                    <div class="result-item">
                        <div class="result-value" id="rentabiliteBrute">-</div>
                        <div class="result-label">Rentabilit√© Brute</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="rentabiliteNette">-</div>
                        <div class="result-label">Rentabilit√© Nette</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="cashFlowMensuel">-</div>
                        <div class="result-label">Cash-Flow Mensuel</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="tempsRetour">-</div>
                        <div class="result-label">Retour sur Apport</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="prixM2">-</div>
                        <div class="result-label">Prix au m¬≤</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="loyerM2">-</div>
                        <div class="result-label">Loyer au m¬≤</div>
                    </div>
                </div>

                <div class="score-container">
                    <div class="score-circle" id="scoreCircle">
                        <span id="scoreValue">-</span>
                    </div>
                    <h3 id="scoreDescription">Analysez votre projet</h3>
                    <p id="scoreExplication"></p>
                </div>
            </div>
        </div>

        <!-- Projections Multi-Sc√©narios -->
        <div class="card full-width">
            <h2><i class="fas fa-crystal-ball"></i> Projections sur 10 ans</h2>
            <div class="scenarios-container">
                <div class="scenario-card scenario-optimiste">
                    <div class="scenario-title">üöÄ Optimiste</div>
                    <div id="scenarioOptimiste"></div>
                </div>
                <div class="scenario-card scenario-realiste">
                    <div class="scenario-title">üìä R√©aliste</div>
                    <div id="scenarioRealiste"></div>
                </div>
                <div class="scenario-card scenario-pessimiste">
                    <div class="scenario-title">‚ö†Ô∏è Pessimiste</div>
                    <div id="scenarioPessimiste"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="projectionChart"></canvas>
            </div>
        </div>

        <!-- Analyse IA Avanc√©e -->
        <div class="recommendations">
            <h2><i class="fas fa-robot"></i> Analyse IA Avanc√©e</h2>
            <div id="analysesIA"></div>
        </div>

        <!-- Graphiques Avanc√©s -->
        <div class="card full-width">
            <h2><i class="fas fa-chart-area"></i> Visualisations Avanc√©es</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="chart-container">
                    <canvas id="rentabiliteChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="cashflowChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><i class="fas fa-chart-line"></i> Simulateur Immobilier Pro Normandie - Analyse avanc√©e avec IA</p>
        <p>D√©velopp√© pour les investisseurs exigeants - Version 2.0</p>
    </div>

    <script>
        // Donn√©es des villes normandes
        const villesData = {
            falaise: {
                nom: "Falaise",
                prixM2Moyen: 1200,
                loyerM2Moyen: 8.5,
                croissancePrix: 2.1,
                tension: "mod√©r√©e",
                attractivite: 7,
                risque: "faible"
            },
            vire: {
                nom: "Vire en Normandie", 
                prixM2Moyen: 1100,
                loyerM2Moyen: 7.8,
                croissancePrix: 1.8,
                tension: "faible",
                attractivite: 6,
                risque: "faible"
            },
            lisieux: {
                nom: "Lisieux",
                prixM2Moyen: 1400,
                loyerM2Moyen: 9.2,
                croissancePrix: 2.5,
                tension: "mod√©r√©e",
                attractivite: 7.5,
                risque: "mod√©r√©"
            },
            herouville: {
                nom: "H√©rouville Saint-Clair",
                prixM2Moyen: 1800,
                loyerM2Moyen: 11.5,
                croissancePrix: 3.2,
                tension: "forte",
                attractivite: 8.5,
                risque: "mod√©r√©"
            },
            cherbourg: {
                nom: "Cherbourg-en-Cotentin",
                prixM2Moyen: 1500,
                loyerM2Moyen: 9.8,
                croissancePrix: 2.3,
                tension: "mod√©r√©e",
                attractivite: 8,
                risque: "faible"
            },
            carentan: {
                nom: "Carentan-les-Marais",
                prixM2Moyen: 1000,
                loyerM2Moyen: 7.2,
                croissancePrix: 1.5,
                tension: "faible",
                attractivite: 5.5,
                risque: "faible"
            }
        };

        let projectionChart, rentabiliteChart, cashflowChart;

        function calculerEtAnalyser() {
            const ville = document.getElementById('ville').value;
            const prix = parseFloat(document.getElementById('prix').value) || 0;
            const surface = parseFloat(document.getElementById('surface').value) || 0;
            const apport = parseFloat(document.getElementById('apport').value) || 0;
            const loyerMensuel = parseFloat(document.getElementById('loyerMensuel').value) || 0;
            const chargesAnnuelles = parseFloat(document.getElementById('chargesAnnuelles').value) || 0;
            const tauxEmprunt = parseFloat(document.getElementById('tauxEmprunt').value) || 0;
            const dureeEmprunt = parseFloat(document.getElementById('dureeEmprunt').value) || 0;

            if (ville) {
                afficherInfoVille(ville);
            }

            if (prix && surface && loyerMensuel) {
                calculerResultats(prix, surface, apport, loyerMensuel, chargesAnnuelles, tauxEmprunt, dureeEmprunt, ville);
                genererScenarios(prix, loyerMensuel, chargesAnnuelles, ville);
                analyseIA(prix, surface, loyerMensuel, ville);
                creerGraphiques(prix, loyerMensuel, chargesAnnuelles, ville);
            }
        }

        function afficherInfoVille(villeKey) {
            const ville = villesData[villeKey];
            if (ville) {
                const infoDiv = document.getElementById('cityInfo');
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                    <h4><i class="fas fa-map-marker-alt"></i> ${ville.nom}</h4>
                    <p><strong>Prix moyen :</strong> ${ville.prixM2Moyen}‚Ç¨/m¬≤ | <strong>Loyer moyen :</strong> ${ville.loyerM2Moyen}‚Ç¨/m¬≤</p>
                    <p><strong>Croissance :</strong> +${ville.croissancePrix}%/an | <strong>Tension locative :</strong> ${ville.tension}</p>
                    <p><strong>Attractivit√© :</strong> ${ville.attractivite}/10 | <strong>Risque :</strong> ${ville.risque}</p>
                `;
            }
        }

        function calculerResultats(prix, surface, apport, loyerMensuel, chargesAnnuelles, tauxEmprunt, dureeEmprunt, ville) {
            // Calculs de base
            const loyerAnnuel = loyerMensuel * 12;
            const rentabiliteBrute = ((loyerAnnuel / prix) * 100);
            const rentabiliteNette = (((loyerAnnuel - chargesAnnuelles) / prix) * 100);
            
            // Calcul mensualit√© emprunt
            const montantEmprunte = prix - apport;
            const tauxMensuel = tauxEmprunt / 100 / 12;
            const nbMensualites = dureeEmprunt * 12;
            const mensualite = montantEmprunte > 0 && tauxMensuel > 0 ? 
                montantEmprunte * (tauxMensuel * Math.pow(1 + tauxMensuel, nbMensualites)) / 
                (Math.pow(1 + tauxMensuel, nbMensualites) - 1) : 0;
            
            const cashFlowMensuel = loyerMensuel - (chargesAnnuelles / 12) - mensualite;
            const tempsRetour = apport > 0 ? (apport / (loyerAnnuel - chargesAnnuelles)) : 0;
            
            // Prix et loyer au m¬≤
            const prixM2 = prix / surface;
            const loyerM2 = loyerMensuel / surface;

            // Affichage des r√©sultats
            document.getElementById('rentabiliteBrute').textContent = rentabiliteBrute.toFixed(2) + '%';
            document.getElementById('rentabiliteNette').textContent = rentabiliteNette.toFixed(2) + '%';
            document.getElementById('cashFlowMensuel').textContent = cashFlowMensuel.toFixed(0) + '‚Ç¨';
            document.getElementById('tempsRetour').textContent = tempsRetour.toFixed(1) + ' ans';
            document.getElementById('prixM2').textContent = prixM2.toFixed(0) + '‚Ç¨';
            document.getElementById('loyerM2').textContent = loyerM2.toFixed(1) + '‚Ç¨';

            // Score IA
            calculerScore(rentabiliteNette, cashFlowMensuel, prixM2, loyerM2, ville);
        }

        function calculerScore(rentabiliteNette, cashFlowMensuel, prixM2, loyerM2, ville) {
            let score = 0;
            let evaluation = "";
            let explication = "";

            // Rentabilit√© (40 points max)
            if (rentabiliteNette >= 8) score += 40;
            else if (rentabiliteNette >= 6) score += 30;
            else if (rentabiliteNette >= 4) score += 20;
            else score += 10;

            // Cash-flow (30 points max)
            if (cashFlowMensuel >= 200) score += 30;
            else if (cashFlowMensuel >= 0) score += 20;
            else if (cashFlowMensuel >= -100) score += 10;
            else score += 0;

            // Analyse march√© ville (20 points max)
            if (ville && villesData[ville]) {
                const donneesVille = villesData[ville];
                const ecartPrix = ((prixM2 - donneesVille.prixM2Moyen) / donneesVille.prixM2Moyen) * 100;
                
                if (ecartPrix <= 0) score += 15; // Prix en dessous du march√©
                else if (ecartPrix <= 10) score += 10;
                else score += 5;

                score += donneesVille.attractivite <= 8 ? donneesVille.attractivite : 5;
            }

            // Surface analyse (10 points max)
            const surface = parseFloat(document.getElementById('surface').value) || 0;
            if (surface >= 30 && surface <= 80) score += 10;
            else if (surface >= 20 && surface <= 100) score += 7;
            else score += 3;

            // D√©termination de l'√©valuation
            if (score >= 80) {
                evaluation = "Excellent investissement";
                explication = "Projet tr√®s profitable avec de faibles risques";
            } else if (score >= 60) {
                evaluation = "Bon investissement";
                explication = "Projet int√©ressant avec potentiel de rentabilit√©";
            } else if (score >= 40) {
                evaluation = "Investissement moyen";
                explication = "Projet √† optimiser ou ren√©gocier";
            } else {
                evaluation = "Investissement risqu√©";
                explication = "Projet √† √©viter en l'√©tat actuel";
            }

            // Affichage du score
            const scoreCircle = document.getElementById('scoreCircle');
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('scoreDescription').textContent = evaluation;
            document.getElementById('scoreExplication').textContent = explication;

            // Couleur du score
            if (score >= 80) scoreCircle.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            else if (score >= 60) scoreCircle.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
            else if (score >= 40) scoreCircle.style.background = 'linear-gradient(45deg, #fd7e14, #dc3545)';
            else scoreCircle.style.background = 'linear-gradient(45deg, #dc3545, #6f42c1)';
        }

        function genererScenarios(prix, loyerMensuel, chargesAnnuelles, ville) {
            const villeData = ville ? villesData[ville] : null;
            const croissanceBase = villeData ? villeData.croissancePrix : 2;

            // Sc√©nario Optimiste
            const optimiste = calculerProjection(prix, loyerMensuel, chargesAnnuelles, croissanceBase + 1, 0.03);
            document.getElementById('scenarioOptimiste').innerHTML = `
                <p><strong>Ann√©e 5:</strong> ${optimiste.annee5.patrimoine}</p>
                <p><strong>Ann√©e 10:</strong> ${optimiste.annee10.patrimoine}</p>
                <p><strong>Cash-flow cumul√©:</strong> ${optimiste.cashflowCumule}</p>
                <small>+COVID recovery, inflation contr√¥l√©e</small>
            `;

            // Sc√©nario R√©aliste  
            const realiste = calculerProjection(prix, loyerMensuel, chargesAnnuelles, croissanceBase, 0.025);
            document.getElementById('scenarioRealiste').innerHTML = `
                <p><strong>Ann√©e 5:</strong> ${realiste.annee5.patrimoine}</p>
                <p><strong>Ann√©e 10:</strong> ${realiste.annee10.patrimoine}</p>
                <p><strong>Cash-flow cumul√©:</strong> ${realiste.cashflowCumule}</p>
                <small>Tendances actuelles maintenues</small>
            `;

            // Sc√©nario Pessimiste
            const pessimiste = calculerProjection(prix, loyerMensuel, chargesAnnuelles, Math.max(0, croissanceBase - 1), 0.015);
            document.getElementById('scenarioPessimiste').innerHTML = `
                <p><strong>Ann√©e 5:</strong> ${pessimiste.annee5.patrimoine}</p>
                <p><strong>Ann√©e 10:</strong> ${pessimiste.annee10.patrimoine}</p>
                <p><strong>Cash-flow cumul√©:</strong> ${pessimiste.cashflowCumule}</p>
                <small>Crise √©conomique, vacance locative</small>
            `;
        }

        function calculerProjection(prix, loyerMensuel, chargesAnnuelles, croissancePrix, croissanceLoyer) {
            let valeurBien = prix;
            let loyer = loyerMensuel;
            let cashflowCumule = 0;

            const projection = {
                annee5: {},
                annee10: {},
                cashflowCumule: 0
            };

            for (let i = 1; i <= 10; i++) {
                valeurBien = valeurBien * (1 + croissancePrix / 100);
                loyer = loyer * (1 + croissanceLoyer);
                
                const cashflowAnnuel = (loyer * 12) - chargesAnnuelles - (chargesAnnuelles * 0.1); // travaux occasionnels
                cashflowCumule += Math.max(cashflowAnnuel, 0);

                if (i === 5) {
                    projection.annee5 = {
                        patrimoine: Math.round(valeurBien).toLocaleString() + '‚Ç¨',
                        loyer: Math.round(loyer) + '‚Ç¨/mois'
                    };
                }
                
                if (i === 10) {
                    projection.annee10 = {
                        patrimoine: Math.round(valeurBien).toLocaleString() + '‚Ç¨',
                        loyer: Math.round(loyer) + '‚Ç¨/mois'
                    };
                }
            }

            projection.cashflowCumule = Math.round(cashflowCumule).toLocaleString() + '‚Ç¨';
            return projection;
        }

        function analyseIA(prix, surface, loyerMensuel, ville) {
            const analyses = [];
            const prixM2 = prix / surface;
            const loyerM2 = loyerMensuel / surface;
            
            // Analyse du prix au m¬≤
            if (ville && villesData[ville]) {
                const donneesVille = villesData[ville];
                const ecartPrix = ((prixM2 - donneesVille.prixM2Moyen) / donneesVille.prixM2Moyen) * 100;
                
                if (ecartPrix < -10) {
                    analyses.push({
                        type: 'success',
                        icon: 'üéØ',
                        titre: 'Prix tr√®s attractif',
                        contenu: `Prix ${Math.abs(ecartPrix).toFixed(1)}% sous le march√© (${donneesVille.prixM2Moyen}‚Ç¨/m¬≤). Excellente opportunit√© d'achat !`
                    });
                } else if (ecartPrix > 15) {
                    analyses.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        titre: 'Prix sur√©valu√©',
                        contenu: `Prix ${ecartPrix.toFixed(1)}% au-dessus du march√©. N√©gociation recommand√©e pour atteindre ${donneesVille.prixM2Moyen}‚Ç¨/m¬≤.`
                    });
                }

                // Analyse du loyer
                const ecartLoyer = ((loyerM2 - donneesVille.loyerM2Moyen) / donneesVille.loyerM2Moyen) * 100;
                if (ecartLoyer > 10) {
                    analyses.push({
                        type: 'warning',
                        icon: 'üìà',
                        titre: 'Loyer optimiste',
                        contenu: `Loyer ${ecartLoyer.toFixed(1)}% au-dessus du march√©. V√©rifiez la faisabilit√© (${donneesVille.loyerM2Moyen}‚Ç¨/m¬≤ en moyenne).`
                    });
                } else if (ecartLoyer < -5) {
                    analyses.push({
                        type: 'info',
                        icon: 'üí°',
                        titre: 'Potentiel de revalorisation',
                        contenu: `Loyer sous le march√©. Possibilit√© d'augmentation jusqu'√† ${donneesVille.loyerM2Moyen}‚Ç¨/m¬≤.`
                    });
                }

                // Analyse de la ville
                if (donneesVille.attractivite >= 8) {
                    analyses.push({
                        type: 'success',
                        icon: 'üåü',
                        titre: 'Ville tr√®s attractive',
                        contenu: `${donneesVille.nom} pr√©sente une forte attractivit√© (${donneesVille.attractivite}/10). Demande locative soutenue.`
                    });
                }

                // Pr√©dictions IA
                const tendance = donneesVille.croissancePrix;
                if (tendance >= 2.5) {
                    analyses.push({
                        type: 'success',
                        icon: 'üöÄ',
                        titre: 'March√© dynamique',
                        contenu: `Croissance pr√©vue de +${tendance}%/an. Potentiel de plus-value int√©ressant √† moyen terme.`
                    });
                }
            }

            // Analyse de la surface
            if (surface < 25) {
                analyses.push({
                    type: 'info',
                    icon: 'üè†',
                    titre: 'Petit logement',
                    contenu: 'Surface adapt√©e aux √©tudiants/jeunes actifs. Liquidit√© potentielle mais rotation locative plus √©lev√©e.'
                });
            } else if (surface > 90) {
                analyses.push({
                    type: 'warning',
                    icon: 'üè°',
                    titre: 'Grand logement',
                    contenu: 'Surface importante = march√© plus restreint. V√©rifiez la demande locale pour les familles.'
                });
            }

            // Calcul rentabilit√© et analyse
            const loyerAnnuel = loyerMensuel * 12;
            const rentabilite = (loyerAnnuel / prix) * 100;
            
            if (rentabilite >= 8) {
                analyses.push({
                    type: 'success',
                    icon: 'üí∞',
                    titre: 'Rentabilit√© exceptionnelle',
                    contenu: `${rentabilite.toFixed(1)}% de rentabilit√© brute ! V√©rifiez l'√©tat du bien et les travaux n√©cessaires.`
                });
            } else if (rentabilite < 4) {
                analyses.push({
                    type: 'error',
                    icon: 'üìâ',
                    titre: 'Rentabilit√© faible',
                    contenu: `Seulement ${rentabilite.toFixed(1)}% de rentabilit√©. Envisagez une ren√©gociation du prix ou du loyer.`
                });
            }

            // Conseils IA personnalis√©s
            analyses.push({
                type: 'info',
                icon: 'ü§ñ',
                titre: 'Recommandation IA',
                contenu: genererConseilIA(prix, surface, loyerMensuel, ville)
            });

            // Affichage des analyses
            const container = document.getElementById('analysesIA');
            container.innerHTML = analyses.map(analyse => `
                <div class="recommendation-item ${analyse.type}">
                    <h4>${analyse.icon} ${analyse.titre}</h4>
                    <p>${analyse.contenu}</p>
                </div>
            `).join('');
        }

        function genererConseilIA(prix, surface, loyerMensuel, ville) {
            const prixM2 = prix / surface;
            const rentabilite = (loyerMensuel * 12 / prix) * 100;
            
            let conseil = "";
            
            if (rentabilite > 6 && prixM2 < 1600) {
                conseil = "Profil investissement parfait ! Prix abordable et rentabilit√© solide. V√©rifiez l'√©tat du bien et foncez.";
            } else if (rentabilite < 4) {
                conseil = "Rentabilit√© insuffisante. N√©gociez -10% sur le prix ou trouvez un locataire √† loyer plus √©lev√©.";
            } else if (prixM2 > 2000) {
                conseil = "Prix √©lev√© pour la Normandie. Attendez-vous √† une appr√©ciation plus lente mais un locataire plus stable.";
            } else {
                conseil = "Projet √©quilibr√©. Pr√©voyez 5-8% du prix d'achat en travaux de remise en √©tat.";
            }

            if (ville && villesData[ville]) {
                const villeData = villesData[ville];
                if (villeData.tension === "forte") {
                    conseil += " March√© tendu = loyers stables et peu de vacance.";
                } else if (villeData.tension === "faible") {
                    conseil += " March√© d√©tendu = soyez comp√©titif sur le loyer et l'√©tat du bien.";
                }
            }

            return conseil;
        }

        function creerGraphiques(prix, loyerMensuel, chargesAnnuelles, ville) {
            // Graphique des projections
            creerGraphiqueProjections(prix, loyerMensuel, chargesAnnuelles, ville);
            
            // Graphique de rentabilit√©
            creerGraphiqueRentabilite(prix, loyerMensuel, chargesAnnuelles);
            
            // Graphique de cash-flow
            creerGraphiqueCashFlow(loyerMensuel, chargesAnnuelles);
        }

        function creerGraphiqueProjections(prix, loyerMensuel, chargesAnnuelles, ville) {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            
            if (projectionChart) {
                projectionChart.destroy();
            }

            const villeData = ville ? villesData[ville] : null;
            const croissanceBase = villeData ? villeData.croissancePrix : 2;

            // Donn√©es pour les 3 sc√©narios
            const labels = [];
            const dataOptimiste = [];
            const dataRealiste = [];
            const dataPessimiste = [];

            for (let annee = 0; annee <= 10; annee++) {
                labels.push('Ann√©e ' + annee);
                
                // Calcul valeur du bien selon sc√©narios
                const valeurOptimiste = prix * Math.pow(1 + (croissanceBase + 1) / 100, annee);
                const valeurRealiste = prix * Math.pow(1 + croissanceBase / 100, annee);
                const valeurPessimiste = prix * Math.pow(1 + Math.max(0, croissanceBase - 1) / 100, annee);
                
                dataOptimiste.push(Math.round(valeurOptimiste));
                dataRealiste.push(Math.round(valeurRealiste));
                dataPessimiste.push(Math.round(valeurPessimiste));
            }

            projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Optimiste',
                        data: dataOptimiste,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'R√©aliste',
                        data: dataRealiste,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Pessimiste',
                        data: dataPessimiste,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '√âvolution de la valeur du bien (‚Ç¨)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function creerGraphiqueRentabilite(prix, loyerMensuel, chargesAnnuelles) {
            const ctx = document.getElementById('rentabiliteChart').getContext('2d');
            
            if (rentabiliteChart) {
                rentabiliteChart.destroy();
            }

            const loyerAnnuel = loyerMensuel * 12;
            const rentabiliteBrute = (loyerAnnuel / prix) * 100;
            const rentabiliteNette = ((loyerAnnuel - chargesAnnuelles) / prix) * 100;

            rentabiliteChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Rentabilit√© Nette', 'Charges', 'Reste'],
                    datasets: [{
                        data: [
                            rentabiliteNette,
                            (chargesAnnuelles / prix) * 100,
                            Math.max(0, 12 - rentabiliteBrute)
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545', 
                            '#e9ecef'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'R√©partition Rentabilit√© (%)'
                        }
                    }
                }
            });
        }

        function creerGraphiqueCashFlow(loyerMensuel, chargesAnnuelles) {
            const ctx = document.getElementById('cashflowChart').getContext('2d');
            
            if (cashflowChart) {
                cashflowChart.destroy();
            }

            const chargesMensuelles = chargesAnnuelles / 12;
            const apport = parseFloat(document.getElementById('apport').value) || 0;
            const prix = parseFloat(document.getElementById('prix').value) || 0;
            const tauxEmprunt = parseFloat(document.getElementById('tauxEmprunt').value) || 0;
            const dureeEmprunt = parseFloat(document.getElementById('dureeEmprunt').value) || 0;
            
            // Calcul mensualit√©
            const montantEmprunte = prix - apport;
            const tauxMensuel = tauxEmprunt / 100 / 12;
            const nbMensualites = dureeEmprunt * 12;
            const mensualite = montantEmprunte > 0 && tauxMensuel > 0 ? 
                montantEmprunte * (tauxMensuel * Math.pow(1 + tauxMensuel, nbMensualites)) / 
                (Math.pow(1 + tauxMensuel, nbMensualites) - 1) : 0;

            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Entr√©es', 'Sorties', 'Cash-Flow Net'],
                    datasets: [{
                        label: 'Euros',
                        data: [
                            loyerMensuel,
                            chargesMensuelles + mensualite,
                            loyerMensuel - chargesMensuelles - mensualite
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545',
                            loyerMensuel - chargesMensuelles - mensualite > 0 ? '#28a745' : '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cash-Flow Mensuel (‚Ç¨)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function exporterExcel() {
            const ville = document.getElementById('ville').value;
            const prix = parseFloat(document.getElementById('prix').value) || 0;
            const surface = parseFloat(document.getElementById('surface').value) || 0;
            const apport = parseFloat(document.getElementById('apport').value) || 0;
            const loyerMensuel = parseFloat(document.getElementById('loyerMensuel').value) || 0;
            const chargesAnnuelles = parseFloat(document.getElementById('chargesAnnuelles').value) || 0;

            if (!prix || !loyerMensuel) {
                alert('Veuillez remplir au minimum le prix et le loyer pour exporter.');
                return;
            }

            // Pr√©paration des donn√©es pour Excel
            const donnees = [];
            
            // En-t√™tes et donn√©es de base
            donnees.push(['SIMULATEUR IMMOBILIER PRO - NORMANDIE', '', '', '']);
            donnees.push(['Date d\'analyse', new Date().toLocaleDateString('fr-FR'), '', '']);
            donnees.push(['', '', '', '']);
            
            // Param√®tres du bien
            donnees.push(['PARAM√àTRES DU BIEN', '', '', '']);
            donnees.push(['Ville', ville ? villesData[ville]?.nom || ville : 'Non d√©finie', '', '']);
            donnees.push(['Prix d\'achat', prix.toLocaleString() + ' ‚Ç¨', '', '']);
            donnees.push(['Surface', surface + ' m¬≤', '', '']);
            donnees.push(['Apport personnel', apport.toLocaleString() + ' ‚Ç¨', '', '']);
            donnees.push(['Loyer mensuel', loyerMensuel.toLocaleString() + ' ‚Ç¨', '', '']);
            donnees.push(['Charges annuelles', chargesAnnuelles.toLocaleString() + ' ‚Ç¨', '', '']);
            donnees.push(['', '', '', '']);

            // R√©sultats
            const loyerAnnuel = loyerMensuel * 12;
            const rentabiliteBrute = ((loyerAnnuel / prix) * 100);
            const rentabiliteNette = (((loyerAnnuel - chargesAnnuelles) / prix) * 100);
            const prixM2 = surface > 0 ? prix / surface : 0;
            const loyerM2 = surface > 0 ? loyerMensuel / surface : 0;

            donnees.push(['R√âSULTATS DE L\'ANALYSE', '', '', '']);
            donnees.push(['Rentabilit√© brute', rentabiliteBrute.toFixed(2) + ' %', '', '']);
            donnees.push(['Rentabilit√© nette', rentabiliteNette.toFixed(2) + ' %', '', '']);
            donnees.push(['Prix au m¬≤', prixM2.toFixed(0) + ' ‚Ç¨', '', '']);
            donnees.push(['Loyer au m¬≤', loyerM2.toFixed(1) + ' ‚Ç¨', '', '']);
            donnees.push(['', '', '', '']);

            // Projections (simplifi√©)
            if (ville && villesData[ville]) {
                const croissance = villesData[ville].croissancePrix;
                const valeur5ans = prix * Math.pow(1 + croissance/100, 5);
                const valeur10ans = prix * Math.pow(1 + croissance/100, 10);
                
                donnees.push(['PROJECTIONS', '', '', '']);
                donnees.push(['Valeur estim√©e dans 5 ans', Math.round(valeur5ans).toLocaleString() + ' ‚Ç¨', '', '']);
                donnees.push(['Valeur estim√©e dans 10 ans', Math.round(valeur10ans).toLocaleString() + ' ‚Ç¨', '', '']);
                donnees.push(['Croissance annuelle pr√©vue', croissance + ' %', '', '']);
            }

            // Cr√©ation du workbook Excel
            const ws = XLSX.utils.aoa_to_sheet(donnees);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Analyse Immobili√®re");

            // Style des colonnes
            ws['!cols'] = [
                {wch: 25}, // Colonne A
                {wch: 20}, // Colonne B  
                {wch: 15}, // Colonne C
                {wch: 15}  // Colonne D
            ];

            // Export du fichier
            const nomVille = ville ? villesData[ville]?.nom.replace(/\s+/g, '_') : 'analyse';
            const nomFichier = `simulateur_immobilier_${nomVille}_${new Date().getTime()}.xlsx`;
            
            XLSX.writeFile(wb, nomFichier);
        }

        // Auto-sauvegarde locale
        function sauvegarderLocalement() {
            const donnees = {
                ville: document.getElementById('ville').value,
                prix: document.getElementById('prix').value,
                surface: document.getElementById('surface').value,
                apport: document.getElementById('apport').value,
                loyerMensuel: document.getElementById('loyerMensuel').value,
                chargesAnnuelles: document.getElementById('chargesAnnuelles').value,
                tauxEmprunt: document.getElementById('tauxEmprunt').value,
                dureeEmprunt: document.getElementById('dureeEmprunt').value
            };
            
            localStorage.setItem('simulateurImmobilier', JSON.stringify(donnees));
        }

        function chargerDonneesSauvegardees() {
            const donneesSauvegardees = localStorage.getItem('simulateurImmobilier');
            if (donneesSauvegardees) {
                const donnees = JSON.parse(donneesSauvegardees);
                
                Object.keys(donnees).forEach(key => {
                    const element = document.getElementById(key);
                    if (element && donnees[key]) {
                        element.value = donnees[key];
                    }
                });
            }
        }

        // √âv√©nements pour auto-sauvegarde
        document.addEventListener('DOMContentLoaded', function() {
            chargerDonneesSauvegardees();
            
            // Auto-sauvegarde sur changement
            const inputs = ['ville', 'prix', 'surface', 'apport', 'loyerMensuel', 'chargesAnnuelles', 'tauxEmprunt', 'dureeEmprunt'];
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('change', sauvegarderLocalement);
                }
            });

            // Calcul initial si des donn√©es sont pr√©sentes
            if (document.getElementById('prix').value && document.getElementById('loyerMensuel').value) {
                calculerEtAnalyser();
            }
        });

        // Responsive des graphiques
        window.addEventListener('resize', function() {
            if (projectionChart) projectionChart.resize();
            if (rentabiliteChart) rentabiliteChart.resize();
            if (cashflowChart) cashflowChart.resize();
        });
    </script>
</body>
</html>
