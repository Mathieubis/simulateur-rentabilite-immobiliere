# simulateur-rentabilite-immobiliere
Description: Simulateur de rentabilit√© pour investissement immobilier
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Immobilier Pro - Normandie</title>
    
    <!-- CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            position: relative;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        /* R√©capitulatif ville */
        .ville-recap {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .ville-recap h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .ville-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .ville-stat {
            background: rgba(255,255,255,0.8);
            padding: 12px 8px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ville-stat .value {
            font-weight: bold;
            font-size: 1rem;
            color: #667eea;
            margin-bottom: 2px;
        }

        .ville-stat .label {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.2;
        }

        .ville-fourchettes {
            background: rgba(255,255,255,0.6);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .ville-fourchettes h5 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .fourchette-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
            color: #555;
        }

        .data-source {
            font-size: 0.75rem;
            color: #888;
            font-style: italic;
        }

        .evolution-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .evolution-positive {
            color: #28a745;
        }

        .evolution-negative {
            color: #dc3545;
        }

        .estimation-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .estimation-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .estimation-header h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .estimation-grille {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .estimation-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .estimation-card .montant {
            font-weight: bold;
            font-size: 1.1rem;
            color: #667eea;
            margin-bottom: 3px;
        }

        .estimation-card .type {
            font-size: 0.8rem;
            color: #666;
        }

        /* M√©triques */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .metric-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .metric-card p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Sections d'analyse */
        .analysis-section {
            display: none;
            grid-column: 1 / -1;
            margin-bottom: 30px;
        }

        .analysis-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        /* Score IA */
        .ai-score {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .score-details h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .score-details p {
            color: #666;
        }

        /* Recommandations */
        .recommendations {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .recommendation-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
        }

        .recommendation-item.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .recommendation-item.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .recommendation-item.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .recommendation-item.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }

        /* Sc√©narios */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .scenario-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-optimiste {
            border-left: 5px solid #28a745;
        }

        .scenario-realiste {
            border-left: 5px solid #17a2b8;
        }

        .scenario-pessimiste {
            border-left: 5px solid #dc3545;
        }

        /* Projections */
        .projections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .projection-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .projection-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .projection-item .annee {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 5px;
        }

        .projection-item .valeur {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
        }

        .projection-item .cashflow {
            font-size: 0.85rem;
            color: #28a745;
            margin-top: 5px;
        }

        /* Graphiques */
        .charts-section {
            display: none;
            grid-column: 1 / -1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            height: 300px;
        }

        .chart-title {
            color: #667eea;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .calculation-explanation {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .calculation-explanation h5 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .calculation-explanation ul {
            margin-left: 20px;
            color: #6c757d;
        }

        .calculation-explanation li {
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .ville-stats {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-home"></i> Simulateur Immobilier Pro</h1>
            <p>Analyse avanc√©e avec IA - Donn√©es r√©elles Normandie 2024</p>
        </div>

        <div class="main-content">
            <!-- Formulaire -->
            <div class="card">
                <h2><i class="fas fa-calculator"></i> Configuration</h2>
                
                <div class="form-group">
                    <label for="ville" class="tooltip" data-tooltip="Choix de la ville pour donn√©es locales pr√©cises">
                        <i class="fas fa-map-marker-alt"></i> Ville *
                    </label>
                    <select id="ville" required onchange="afficherRecapVille()">
                        <option value="">Choisir une ville</option>
                        <option value="cherbourg">Cherbourg-en-Cotentin</option>
                        <option value="herouville">H√©rouville-Saint-Clair</option>
                        <option value="lisieux">Lisieux</option>
                        <option value="falaise">Falaise</option>
                        <option value="carentan">Carentan-les-Marais</option>
                        <option value="vire">Vire-Normandie</option>
                    </select>
                </div>

                <!-- R√©cap ville -->
                <div id="villeRecap" style="display: none;"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="prix" class="tooltip" data-tooltip="Prix de vente hors frais">
                            <i class="fas fa-euro-sign"></i> Prix d'achat (‚Ç¨)
                        </label>
                        <input type="number" id="prix" placeholder="200000" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="fraisAgence" class="tooltip" data-tooltip="Frais d'agence (5-8% du prix)">
                            <i class="fas fa-handshake"></i> Frais d'agence (‚Ç¨)
                        </label>
                        <input type="number" id="fraisAgence" placeholder="12000" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="surface" class="tooltip" data-tooltip="Surface habitable en m¬≤">
                            <i class="fas fa-ruler"></i> Surface (m¬≤)
                        </label>
                        <input type="number" id="surface" placeholder="80" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="travaux" class="tooltip" data-tooltip="Budget travaux de r√©novation">
                            <i class="fas fa-hammer"></i> Travaux (‚Ç¨)
                        </label>
                        <input type="number" id="travaux" placeholder="15000" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="mobilier" class="tooltip" data-tooltip="Co√ªt d'ameublement (meubl√©)">
                            <i class="fas fa-couch"></i> Mobilier (‚Ç¨)
                        </label>
                        <input type="number" id="mobilier" placeholder="8000" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="apport" class="tooltip" data-tooltip="Votre apport personnel">
                            <i class="fas fa-piggy-bank"></i> Apport (‚Ç¨)
                        </label>
                        <input type="number" id="apport" placeholder="50000" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="typeLocation">
                        <i class="fas fa-key"></i> Type de location
                    </label>
                    <select id="typeLocation">
                        <option value="vide">Location vide</option>
                        <option value="meublee">Location meubl√©e</option>
                        <option value="colocation">Colocation</option>
                    </select>
                </div>

                <!-- Estimation loyer -->
                <button type="button" class="btn btn-secondary" onclick="estimerLoyer()">
                    <i class="fas fa-magic"></i> Estimer le loyer
                </button>
                <div id="estimationResults"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="loyerMensuel" class="tooltip" data-tooltip="Loyer hors charges">
                            <i class="fas fa-money-bill"></i> Loyer mensuel (‚Ç¨)
                        </label>
                        <input type="number" id="loyerMensuel" placeholder="800" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="chargesAnnuelles" class="tooltip" data-tooltip="Charges totales annuelles">
                            <i class="fas fa-receipt"></i> Charges/an (‚Ç¨)
                        </label>
                        <input type="number" id="chargesAnnuelles" placeholder="3000" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tauxEmprunt" class="tooltip" data-tooltip="Taux d'int√©r√™t du cr√©dit">
                            <i class="fas fa-percentage"></i> Taux emprunt (%)
                        </label>
                        <input type="number" id="tauxEmprunt" placeholder="3.5" min="0" max="15" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="dureeEmprunt" class="tooltip" data-tooltip="Dur√©e du cr√©dit en ann√©es">
                            <i class="fas fa-calendar"></i> Dur√©e (ann√©es)
                        </label>
                        <input type="number" id="dureeEmprunt" placeholder="20" min="5" max="35">
                    </div>
                </div>

                <button type="button" class="btn" onclick="calculerEtAnalyser()">
                    <i class="fas fa-chart-line"></i> Analyser l'investissement
                </button>
            </div>

            <!-- R√©sultats -->
            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> R√©sultats</h2>
                <div id="results">
                    <p style="text-align: center; color: #666; margin-top: 50px;">
                        <i class="fas fa-arrow-left" style="font-size: 2rem; margin-bottom: 20px;"></i><br>
                        Remplissez les champs et cliquez sur "Analyser" pour voir les r√©sultats d√©taill√©s.
                    </p>
                </div>
            </div>
        </div>

        <!-- Section Analyse IA -->
        <div class="analysis-section card" id="analysisSection">
            <h2><i class="fas fa-brain"></i> Analyse Intelligence Artificielle</h2>
            
            <div class="ai-score">
                <div id="scoreCircle" class="score-circle">-</div>
                <div class="score-details">
                    <h3 id="scoreText">En attente d'analyse...</h3>
                    <p id="scoreDescription">Compl√©tez le formulaire pour obtenir votre score</p>
                </div>
            </div>

            <div id="analysesIA"></div>
        </div>

        <!-- Section Projections -->
        <div class="analysis-section card" id="projectionSection">
            <h2><i class="fas fa-chart-line"></i> Projections Patrimoniales</h2>
            <div id="projectionsEtendues" class="projections-grid"></div>
            
            <div class="calculation-explanation">
                <h5>üí° Explication de vos projections :</h5>
                <ul>
                    <li><strong>Valeur du bien :</strong> Prix total √ó (1 + croissance annuelle √∑ 100)^nombre d'ann√©es</li>
                    <li><strong>Cash-flow annuel :</strong> Loyers annuels - Charges - Mensualit√©s cr√©dit - 5% impr√©vus</li>
                    <li><strong>Cash-flow cumul√© :</strong> Somme de tous les cash-flows depuis l'achat</li>
                    <li><strong>Patrimoine total :</strong> Valeur du bien + Cash-flow cumul√©</li>
                </ul>
            </div>
        </div>

        <!-- Section Sc√©narios -->
        <div class="analysis-section card" id="scenariosSection">
            <h2><i class="fas fa-dice"></i> Sc√©narios d'Investissement</h2>
            
            <div class="scenarios-grid">
                <div class="scenario-card scenario-optimiste">
                    <h3>üöÄ Optimiste</h3>
                    <div id="scenarioOptimiste"></div>
                </div>
                
                <div class="scenario-card scenario-realiste">
                    <h3>üìä R√©aliste</h3>
                    <div id="scenarioRealiste"></div>
                </div>
                
                <div class="scenario-card scenario-pessimiste">
                    <h3>‚ö†Ô∏è Pessimiste</h3>
                    <div id="scenarioPessimiste"></div>
                </div>
            </div>

            <div class="calculation-explanation">
                <h5>üí° Comment sont calcul√©s les sc√©narios :</h5>
                <ul>
                    <li><strong>Optimiste :</strong> Croissance prix locale +1.5%, loyers +3%/an, vacance 2%</li>
                    <li><strong>R√©aliste :</strong> Croissance normale selon ville, loyers +2%/an, vacance 5%</li>
                    <li><strong>Pessimiste :</strong> Croissance prix -1%, loyers +1%/an, vacance 10%</li>
                </ul>
            </div>
        </div>

        <!-- Section Graphiques -->
        <div class="charts-section card" id="chartsSection">
            <h2><i class="fas fa-chart-area"></i> Visualisations Avanc√©es</h2>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">√âvolution Patrimoniale sur 25 ans</div>
                    <canvas id="projectionChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">R√©partition des Revenus Annuels</div>
                    <canvas id="rentabiliteChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-section card" id="chartsSection2">
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Cash-flow Mensuel (Premi√®re Ann√©e)</div>
                    <canvas id="cashflowChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Projections Multi-√âch√©ances</div>
                    <canvas id="longTermChart"></canvas>
                </div>
            </div>

            <div class="calculation-explanation">
                <h5>üí° Lecture des graphiques simplifi√©e :</h5>
                <ul>
                    <li><strong>√âvolution patrimoniale :</strong> Montre comme votre patrimoine grandit chaque ann√©e</li>
                    <li><strong>R√©partition revenus :</strong> Combien vous gardez r√©ellement des loyers apr√®s charges</li>
                    <li><strong>Cash-flow mensuel :</strong> Vos rentr√©es/sorties d'argent mois par mois</li>
                    <li><strong>Multi-√©ch√©ances :</strong> Votre patrimoine √† 5, 10, 15, 20 et 25 ans</li>
                </ul>
            </div>
        </div>

        <!-- Section Export -->
        <div class="analysis-section card" id="exportSection">
            <h2><i class="fas fa-download"></i> Export & Sauvegarde</h2>
            <p style="margin-bottom: 20px;">T√©l√©chargez votre analyse compl√®te ou sauvegardez vos donn√©es.</p>
            
            <button type="button" class="btn" onclick="exporterPDF()">
                <i class="fas fa-file-pdf"></i> Exporter en PDF
            </button>
            
            <button type="button" class="btn btn-secondary" onclick="sauvegarderLocalement()">
                <i class="fas fa-save"></i> Sauvegarder
            </button>
        </div>
    </div>

    <script>
        let projectionChart, rentabiliteChart, cashflowChart, longTermChart;

        // üî• DONN√âES R√âELLES 2024 - Source: Votre analyse de march√©
        const villesData = {
            'cherbourg': {
                nom: 'Cherbourg-en-Cotentin',
                prixM2Moyen: 2394,
                prixM2Min: 1646,
                prixM2Max: 3924,
                loyerM2Moyen: 15.9,
                loyerM2Min: 12.8,
                loyerM2Max: 19.1,
                evolutionPrix: '+7%',
                evolutionPrixValeur: 7,
                croissancePrix: 2.5,
                coeffMeublee: 1.25,
                coeffColocation: 1.40,
                tension: 'Forte',
                population: 79000,
                taux_vacance: 4,
                dateMAJ: 'Janvier 2024'
            },
            'herouville': {
                nom: 'H√©rouville-Saint-Clair',
                prixM2Moyen: 2399,
                prixM2Min: 1543,
                prixM2Max: 3327,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                evolutionPrix: '+10%',
                evolutionPrixValeur: 10,
                croissancePrix: 2.8,
                coeffMeublee: 1.30,
                coeffColocation: 1.45,
                tension: 'Forte',
                population: 21000,
                taux_vacance: 3,
                dateMAJ: 'Janvier 2024'
            },
            'lisieux': {
                nom: 'Lisieux',
                prixM2Moyen: 1906,
                prixM2Min: 1310,
                prixM2Max: 2803,
                loyerM2Moyen: 11.6,
                loyerM2Min: 9.3,
                loyerM2Max: 13.9,
                evolutionPrix: '+2%',
                evolutionPrixValeur: 2,
                croissancePrix: 2.1,
                coeffMeublee: 1.28,
                coeffColocation: 1.40,
                tension: 'Mod√©r√©e',
                population: 20800,
                taux_vacance: 5,
                dateMAJ: 'Janvier 2024'
            },
            'falaise': {
                nom: 'Falaise',
                prixM2Moyen: 1790,
                prixM2Min: 1155,
                prixM2Max: 2406,
                loyerM2Moyen: 11.0,
                loyerM2Min: 8.8,
                loyerM2Max: 13.2,
                evolutionPrix: '-12%',
                evolutionPrixValeur: -12,
                croissancePrix: 1.5,
                coeffMeublee: 1.22,
                coeffColocation: 1.35,
                tension: 'Mod√©r√©e',
                population: 8500,
                taux_vacance: 6,
                dateMAJ: 'Janvier 2024'
            },
            'carentan': {
                nom: 'Carentan-les-Marais',
                prixM2Moyen: 1629,
                prixM2Min: 1069,
                prixM2Max: 2329,
                loyerM2Moyen: 11.7,
                loyerM2Min: 9.3,
                loyerM2Max: 14.0,
                evolutionPrix: '+5%',
                evolutionPrixValeur: 5,
                croissancePrix: 1.8,
                coeffMeublee: 1.20,
                coeffColocation: 1.32,
                tension: 'Faible',
                population: 6100,
                taux_vacance: 7,
                dateMAJ: 'Janvier 2024'
            },
            'vire': {
                nom: 'Vire-Normandie',
                prixM2Moyen: 1464,
                prixM2Min: 977,
                prixM2Max: 1948,
                loyerM2Moyen: 10.5,
                loyerM2Min: 8.4,
                loyerM2Max: 12.6,
                evolutionPrix: '-5%',
                evolutionPrixValeur: -5,
                croissancePrix: 1.2,
                coeffMeublee: 1.18,
                coeffColocation: 1.28,
                tension: 'Faible',
                population: 17500,
                taux_vacance: 8,
                dateMAJ: 'Janvier 2024'
            }
        };

        function afficherRecapVille() {
            const ville = document.getElementById('ville').value;
            const recapDiv = document.getElementById('villeRecap');
            
            if (!ville || !villesData[ville]) {
                recapDiv.style.display = 'none';
                return;
            }
            
            const donnees = villesData[ville];
            const evolutionClass = donnees.evolutionPrixValeur >= 0 ? 'evolution-positive' : 'evolution-negative';
            const evolutionIcon = donnees.evolutionPrixValeur >= 0 ? 'üìà' : 'üìâ';
            
            recapDiv.innerHTML = `
                <div class="ville-recap">
                    <h4><i class="fas fa-info-circle"></i> ${donnees.nom} - Donn√©es du march√©</h4>
                    
                    <div class="ville-stats">
                        <div class="ville-stat">
                            <div class="value">${donnees.prixM2Moyen.toLocaleString()}‚Ç¨</div>
                            <div class="label">Prix/m¬≤</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.loyerM2Moyen}‚Ç¨</div>
                            <div class="label">Loyer/m¬≤</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.croissancePrix}%</div>
                            <div class="label">Croissance/an</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.tension}</div>
                            <div class="label">Tension</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.population.toLocaleString()}</div>
                            <div class="label">Habitants</div>
                        </div>
                        <div class="ville-stat">
                            <div class="value">${donnees.taux_vacance}%</div>
                            <div class="label">Vacance</div>
                        </div>
                    </div>

                    <div class="ville-fourchettes">
                        <h5>üìä Fourchettes de march√©</h5>
                        <div class="fourchette-row">
                            <div>Prix : ${donnees.prixM2Min.toLocaleString()}‚Ç¨ - ${donnees.prixM2Max.toLocaleString()}‚Ç¨/m¬≤</div>
                            <div>Loyer : ${donnees.loyerM2Min}‚Ç¨ - ${donnees.loyerM2Max}‚Ç¨/m¬≤</div>
                        </div>
                        <div style="margin-top: 8px;">
                            ${evolutionIcon} √âvolution annuelle : 
                            <span class="${evolutionClass}">
                                <strong>${donnees.evolutionPrix}</strong>
                            </span>
                        </div>
                    </div>
                    
                    <div class="data-source">
                        üìä Donn√©es ${donnees.dateMAJ} - Sources : DVF, CLAMEUR, observatoires locaux
                    </div>
                </div>
            `;
            
            recapDiv.style.display = 'block';
            
            // Auto-estimation si surface renseign√©e
            const surface = parseFloat(document.getElementById('surface').value);
            if (surface > 0) {
                estimerLoyer();
            }
        }

        function estimerLoyer() {
            const ville = document.getElementById('ville').value;
            const surface = parseFloat(document.getElementById('surface').value);
            const typeLocation = document.getElementById('typeLocation').value;
            
            if (!ville || !surface || !villesData[ville]) {
                alert('Veuillez s√©lectionner une ville et renseigner la surface');
                return;
            }
            
            const donnees = villesData[ville];
            let loyerBaseM2 = donnees.loyerM2Moyen;
            
            // Application des coefficients selon le type
            let coefficientType = 1;
            let suffixeType = '';
            
            if (typeLocation === 'meublee') {
                coefficientType = donnees.coeffMeublee;
                suffixeType = ' (meubl√©)';
            } else if (typeLocation === 'colocation') {
                coefficientType = donnees.coeffColocation;
                suffixeType = ' (colocation)';
            }
            
            // Calculs d'estimation
            const loyerMoyenMensuel = Math.round(loyerBaseM2 * surface * coefficientType);
            const loyerMinMensuel = Math.round(donnees.loyerM2Min * surface * coefficientType);
            const loyerMaxMensuel = Math.round(donnees.loyerM2Max * surface * coefficientType);
            
            document.getElementById('estimationResults').innerHTML = `
                <div class="estimation-results">
                    <div class="estimation-header">
                        <h4>üè† Estimation de loyer${suffixeType}</h4>
                        <p>Bas√©e sur ${surface}m¬≤ √† ${donnees.nom}</p>
                    </div>
                    <div class="estimation-grille">
                        <div class="estimation-card">
                            <div class="montant">${loyerMinMensuel}‚Ç¨</div>
                            <div class="type">Minimum</div>
                        </div>
                        <div class="estimation-card" style="border: 2px solid #667eea;">
                            <div class="montant">${loyerMoyenMensuel}‚Ç¨</div>
                            <div class="type">Moyenne</div>
                        </div>
                        <div class="estimation-card">
                            <div class="montant">${loyerMaxMensuel}‚Ç¨</div>
                            <div class="type">Maximum</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Auto-remplir le loyer moyen
            document.getElementById('loyerMensuel').value = loyerMoyenMensuel;
        }

        function calculerEtAnalyser() {
            // R√©cup√©ration des donn√©es
            const ville = document.getElementById('ville').value;
            const prix = parseFloat(document.getElementById('prix').value) || 0;
            const fraisAgence = parseFloat(document.getElementById('fraisAgence').value) || 0;
            const surface = parseFloat(document.getElementById('surface').value) || 0;
            const travaux = parseFloat(document.getElementById('travaux').value) || 0;
            const mobilier = parseFloat(document.getElementById('mobilier').value) || 0;
            const apport = parseFloat(document.getElementById('apport').value) || 0;
            const loyerMensuel = parseFloat(document.getElementById('loyerMensuel').value) || 0;
            const chargesAnnuelles = parseFloat(document.getElementById('chargesAnnuelles').value) || 0;
            const tauxEmprunt = parseFloat(document.getElementById('tauxEmprunt').value) || 3.5;
            const dureeEmprunt = parseInt(document.getElementById('dureeEmprunt').value) || 20;

            if (!ville || !prix || !surface || !loyerMensuel) {
                alert('Veuillez remplir au minimum : ville, prix, surface et loyer');
                return;
            }

            // üìä CALCULS DE BASE - Explication simple
            const prixTotal = prix + fraisAgence + travaux + mobilier; // Prix d'achat TOTAL
            const montantEmprunte = prixTotal - apport; // Ce qu'on emprunte vraiment
            
            const tauxMensuel = tauxEmprunt / 100 / 12;
            const nombreMensualites = dureeEmprunt * 12;
            
            // Formule classique de mensualit√© de pr√™t
            const mensualite = montantEmprunte * (tauxMensuel * Math.pow(1 + tauxMensuel, nombreMensualites)) / 
                              (Math.pow(1 + tauxMensuel, nombreMensualites) - 1);
            
            const loyersAnnuels = loyerMensuel * 12;
            
            // üí∞ CASH-FLOW = Ce qui rentre - Ce qui sort
            const cashflowMensuel = loyerMensuel - mensualite - (chargesAnnuelles/12);
            const cashflowAnnuel = loyersAnnuels - (mensualite * 12) - chargesAnnuelles;
            
            // üìà RENTABILIT√âS expliqu√©es simplement
            const rentabiliteBrute = (loyersAnnuels / prixTotal) * 100; // Loyers √∑ Prix total
            const rentabiliteNette = ((loyersAnnuels - chargesAnnuelles) / prixTotal) * 100; // Apr√®s charges
            const rentabiliteReelle = (cashflowAnnuel / apport) * 100; // Gain sur votre argent perso

            const prixM2 = prixTotal / surface;
            const loyerM2 = loyerMensuel / surface;

            // Affichage des m√©triques principales
            document.getElementById('results').innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>${rentabiliteBrute.toFixed(1)}%</h3>
                        <p>Rentabilit√© Brute</p>
                        <small>Loyers √∑ Prix total</small>
                    </div>
                    <div class="metric-card">
                        <h3>${rentabiliteNette.toFixed(1)}%</h3>
                        <p>Rentabilit√© Nette</p>
                        <small>Apr√®s toutes charges</small>
                    </div>
                    <div class="metric-card">
                        <h3>${rentabiliteReelle.toFixed(1)}%</h3>
                        <p>Rentabilit√© R√©elle</p>
                        <small>Gain sur votre apport</small>
                    </div>
                    <div class="metric-card">
                        <h3>${cashflowMensuel > 0 ? '+' : ''}${Math.round(cashflowMensuel)}‚Ç¨</h3>
                        <p>Cash-flow Mensuel</p>
                        <small>${cashflowMensuel > 0 ? 'Vous gagnez' : 'Vous payez'} chaque mois</small>
                    </div>
                </div>

                <div class="calculation-explanation">
                    <h5>üí° Explication de vos r√©sultats :</h5>
                    <ul>
                        <li><strong>Prix total :</strong> ${prix.toLocaleString()}‚Ç¨ (achat) + ${fraisAgence.toLocaleString()}‚Ç¨ (agence) + ${travaux.toLocaleString()}‚Ç¨ (travaux) + ${mobilier.toLocaleString()}‚Ç¨ (mobilier) = <strong>${prixTotal.toLocaleString()}‚Ç¨</strong></li>
                        <li><strong>Emprunt :</strong> ${prixTotal.toLocaleString()}‚Ç¨ - ${apport.toLocaleString()}‚Ç¨ (apport) = <strong>${montantEmprunte.toLocaleString()}‚Ç¨</strong></li>
                        <li><strong>Mensualit√© cr√©dit :</strong> <strong>${Math.round(mensualite).toLocaleString()}‚Ç¨/mois</strong> sur ${dureeEmprunt} ans √† ${tauxEmprunt}%</li>
                        <li><strong>Cash-flow :</strong> ${loyerMensuel}‚Ç¨ (loyer) - ${Math.round(mensualite)}‚Ç¨ (cr√©dit) - ${Math.round(chargesAnnuelles/12)}‚Ç¨ (charges) = <strong>${Math.round(cashflowMensuel)}‚Ç¨/mois</strong></li>
                    </ul>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; font-weight: bold; color: #667eea;">${prixM2.toLocaleString()}‚Ç¨/m¬≤</div>
                        <div style="color: #666; font-size: 0.9rem;">Prix d'achat au m¬≤</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; font-weight: bold; color: #667eea;">${loyerM2.toFixed(1)}‚Ç¨/m¬≤</div>
                        <div style="color: #666; font-size: 0.9rem;">Loyer au m¬≤</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; font-weight: bold; color: #667eea;">${(loyersAnnuels/prixTotal*100).toFixed(1)}</div>
                        <div style="color: #666; font-size: 0.9rem;">Multiple de loyer</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; font-weight: bold; color: #667eea;">${Math.round(prixTotal/loyersAnnuels)} ans</div>
                        <div style="color: #666; font-size: 0.9rem;">Temps d'amortissement</div>
                    </div>
                </div>
            `;

            analyseIA({
                ville, prix, prixTotal, surface, loyerMensuel, loyersAnnuels,
                rentabiliteBrute, rentabiliteNette, cashflowMensuel, apport,
                prixM2, loyerM2, montantEmprunte, mensualite
            });
            
            genererProjections({
                prixTotal, loyersAnnuels, chargesAnnuelles, mensualite,
                ville, cashflowAnnuel, apport, dureeEmprunt
            });
            
            genererScenarios({
                prixTotal, loyersAnnuels, chargesAnnuelles, mensualite, ville, apport
            });
            
            genererGraphiques({
                prixTotal, loyersAnnuels, chargesAnnuelles, mensualite,
                cashflowMensuel, ville, dureeEmprunt
            });

            // Afficher les sections d'analyse
            document.getElementById('analysisSection').style.display = 'block';
            document.getElementById('projectionSection').style.display = 'block';
            document.getElementById('scenariosSection').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('chartsSection2').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
        }

        function analyseIA(data) {
            // Calcul du score IA (sur 100)
            let score = 50; // Score de base
            let recommandations = [];
            
            // Analyse rentabilit√©
            if (data.rentabiliteBrute >= 7) score += 15;
            else if (data.rentabiliteBrute >= 5) score += 8;
            else score -= 10;
            
            if (data.rentabiliteNette >= 5) score += 15;
            else if (data.rentabiliteNette >= 3) score += 5;
            else score -= 15;
            
            // Analyse cash-flow
            if (data.cashflowMensuel >= 200) {
                score += 10;
                recommandations.push({
                    type: 'success',
                    text: `üíö Excellent cash-flow de ${Math.round(data.cashflowMensuel)}‚Ç¨/mois. Votre investissement g√©n√®re des revenus imm√©diats.`
                });
            } else if (data.cashflowMensuel >= 0) {
                score += 5;
                recommandations.push({
                    type: 'success',
                    text: `‚úÖ Cash-flow positif de ${Math.round(data.cashflowMensuel)}‚Ç¨/mois. L'investissement s'autofinance.`
                });
            } else if (data.cashflowMensuel >= -100) {
                score -= 5;
                recommandations.push({
                    type: 'warning',
                    text: `‚ö†Ô∏è Cash-flow l√©g√®rement n√©gatif (${Math.round(data.cashflowMensuel)}‚Ç¨/mois). Effort mensuel limit√© mais supportable.`
                });
            } else {
                score -= 20;
                recommandations.push({
                    type: 'error',
                    text: `üö® Cash-flow tr√®s n√©gatif (${Math.round(data.cashflowMensuel)}‚Ç¨/mois). Risque financier important chaque mois.`
                });
            }
            
            // Analyse prix/march√©
            if (villesData[data.ville]) {
                const marche = villesData[data.ville];
                const ecartPrix = ((data.prixM2 - marche.prixM2Moyen) / marche.prixM2Moyen) * 100;
                
                if (ecartPrix <= -10) {
                    score += 15;
                    recommandations.push({
                        type: 'success',
                        text: `üéØ Excellent prix d'achat ! ${ecartPrix.toFixed(1)}% sous le march√© (${marche.prixM2Moyen.toLocaleString()}‚Ç¨/m¬≤). Belle affaire d√©tect√©e.`
                    });
                } else if (ecartPrix <= 5) {
                    score += 5;
                    recommandations.push({
                        type: 'info',
                        text: `üìä Prix coh√©rent avec le march√© local (${ecartPrix.toFixed(1)}% d'√©cart avec ${marche.prixM2Moyen.toLocaleString()}‚Ç¨/m¬≤).`
                    });
                } else {
                    score -= 10;
                    recommandations.push({
                        type: 'warning',
                        text: `üí∏ Prix √©lev√© : +${ecartPrix.toFixed(1)}% au dessus du march√© (${marche.prixM2Moyen.toLocaleString()}‚Ç¨/m¬≤). N√©gociation recommand√©e.`
                    });
                }
                
                // Analyse du loyer
                const loyerMarcheM2 = marche.loyerM2Moyen;
                const ecartLoyer = ((data.loyerM2 - loyerMarcheM2) / loyerMarcheM2) * 100;
                
                if (ecartLoyer >= 0) {
                    score += 10;
                    recommandations.push({
                        type: 'success',
                        text: `üí∞ Loyer optimis√© ! ${ecartLoyer.toFixed(1)}% au dessus du march√© (${loyerMarcheM2}‚Ç¨/m¬≤). Bon potentiel locatif.`
                    });
                } else if (ecartLoyer >= -15) {
                    score += 5;
                    recommandations.push({
                        type: 'info',
                        text: `üìà Loyer dans la moyenne du march√© (${ecartLoyer.toFixed(1)}% d'√©cart avec ${loyerMarcheM2}‚Ç¨/m¬≤). Potentiel de revalorisation.`
                    });
                }
            }
            
            // Analyse endettement
            const tauxEndettement = (data.montantEmprunte / data.prixTotal) * 100;
            if (tauxEndettement <= 70) {
                score += 5;
                recommandations.push({
                    type: 'success',
                    text: `üõ°Ô∏è Endettement ma√Ætris√© (${tauxEndettement.toFixed(1)}%). Structure financi√®re s√©curis√©e.`
                });
            } else if (tauxEndettement >= 90) {
                score -= 5;
                recommandations.push({
                    type: 'warning',
                    text: `‚ö†Ô∏è Fort endettement (${tauxEndettement.toFixed(1)}%). Effet de levier important mais risqu√©.`
                });
            }

            // Limitation du score
            score = Math.max(0, Math.min(100, score));
            
            // D√©terminer couleur et texte du score
            let couleurScore, texteScore, descriptionScore;
            if (score >= 80) {
                couleurScore = '#28a745';
                texteScore = 'Excellent investissement';
                descriptionScore = 'Toutes les m√©triques sont au vert. Foncez !';
            } else if (score >= 60) {
                couleurScore = '#28a745';
                texteScore = 'Bon investissement';
                descriptionScore = 'Investissement solide avec de bonnes perspectives.';
            } else if (score >= 40) {
                couleurScore = '#ffc107';
                texteScore = 'Investissement mod√©r√©';
                descriptionScore = 'Quelques points d\'attention mais viable.';
            } else if (score >= 20) {
                couleurScore = '#fd7e14';
                texteScore = 'Investissement risqu√©';
                descriptionScore = 'Plusieurs alertes d√©tect√©es. Prudence recommand√©e.';
            } else {
                couleurScore = '#dc3545';
                texteScore = 'Investissement d√©conseill√©';
                descriptionScore = 'Trop de risques identifi√©s. √Ä √©viter.';
            }

            // Affichage
            document.getElementById('scoreCircle').style.background = couleurScore;
            document.getElementById('scoreCircle').textContent = score;
            document.getElementById('scoreText').textContent = texteScore;
            document.getElementById('scoreDescription').textContent = descriptionScore;

            const recommandationsHTML = recommandations.map(rec => 
                `<div class="recommendation-item ${rec.type}">${rec.text}</div>`
            ).join('');

            document.getElementById('analysesIA').innerHTML = `
                <div class="recommendations">
                    <h4>üìã Recommandations Personnalis√©es</h4>
                    ${recommandationsHTML}
                </div>
            `;
        }

        function genererProjections(data) {
            const donneesVille = villesData[document.getElementById('ville').value];
            const croissanceAnnuelle = donneesVille ? donneesVille.croissancePrix : 2;
            
            let html = '';
            let valeurActuelle = data.prixTotal;
            let cashflowCumule = 0;
            
            // Calcul du cash-flow annuel r√©el (avec 5% d'impr√©vus)
            const cashflowAnnuelBase = data.cashflowAnnuel * 0.95; // S√©curit√© 5%
            
            [5, 10, 15, 20, 25].forEach(annee => {
                // Valeur du bien avec croissance
                const valeurBien = data.prixTotal * Math.pow(1 + croissanceAnnuelle/100, annee);
                
                // Cash-flow cumul√© avec croissance des loyers (+2%/an)
                let cashflowTotal = 0;
                for (let i = 1; i <= annee; i++) {
                    const loyersAnnee = data.loyersAnnuels * Math.pow(1.02, i-1);
                    const chargesAnnee = data.chargesAnnuelles * Math.pow(1.025, i-1); // Charges +2.5%/an
                    let mensualitesAnnee = data.mensualite * 12;
                    
                    // Plus de mensualit√©s apr√®s la fin du cr√©dit
                    if (i > data.dureeEmprunt) mensualitesAnnee = 0;
                    
                    cashflowTotal += (loyersAnnee - chargesAnnee - mensualitesAnnee) * 0.95;
                }
                
                const patrimoineTotal = valeurBien + cashflowTotal;
                
                html += `
                    <div class="projection-item">
                        <h4>Dans ${annee} ans</h4>
                        <div class="annee">${new Date().getFullYear() + annee}</div>
                        <div class="valeur">${Math.round(valeurBien).toLocaleString()}‚Ç¨</div>
                        <div style="font-size: 0.8rem; color: #666; margin: 5px 0;">Valeur du bien</div>
                        <div class="cashflow">+${Math.round(cashflowTotal).toLocaleString()}‚Ç¨ cumul√©s</div>
                        <div style="font-weight: bold; color: #667eea; margin-top: 5px; padding-top: 5px; border-top: 1px solid #eee;">
                            Total : ${Math.round(patrimoineTotal).toLocaleString()}‚Ç¨
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('projectionsEtendues').innerHTML = html;
        }

        function genererScenarios(data) {
            const donneesVille = villesData[document.getElementById('ville').value];
            const croissanceBase = donneesVille ? donneesVille.croissancePrix : 2;
            
            // Sc√©nario optimiste : +1.5% croissance, +3% loyers/an, 2% vacance
            const optimiste = calculerScenario(data, croissanceBase + 1.5, 3, 2);
            
            // Sc√©nario r√©aliste : croissance normale, +2% loyers/an, 5% vacance  
            const realiste = calculerScenario(data, croissanceBase, 2, 5);
            
            // Sc√©nario pessimiste : -1% croissance, +1% loyers/an, 10% vacance
            const pessimiste = calculerScenario(data, croissanceBase - 1, 1, 10);

            document.getElementById('scenarioOptimiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">+${optimiste.gainTotal.toLocaleString()}‚Ç¨</div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                    ‚Ä¢ Croissance prix : +${(croissanceBase + 1.5).toFixed(1)}%/an<br>
                    ‚Ä¢ √âvolution loyers : +3%/an<br>
                    ‚Ä¢ Vacance locative : 2%<br>
                    ‚Ä¢ Patrimoine 10 ans : <strong>${optimiste.patrimoine10ans.toLocaleString()}‚Ç¨</strong>
                </div>
            `;

            document.getElementById('scenarioRealiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #17a2b8;">+${realiste.gainTotal.toLocaleString()}‚Ç¨</div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                    ‚Ä¢ Croissance prix : +${croissanceBase.toFixed(1)}%/an<br>
                    ‚Ä¢ √âvolution loyers : +2%/an<br>
                    ‚Ä¢ Vacance locative : 5%<br>
                    ‚Ä¢ Patrimoine 10 ans : <strong>${realiste.patrimoine10ans.toLocaleString()}‚Ç¨</strong>
                </div>
            `;

            document.getElementById('scenarioPessimiste').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">${pessimiste.gainTotal >= 0 ? '+' : ''}${
pessimiste.gainTotal.toLocaleString()}‚Ç¨</div>
                    <div style="font-size: 0.9rem; color: #666;">Gain total sur 10 ans</div>
                </div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                    ‚Ä¢ Croissance prix : +${(croissanceBase - 1).toFixed(1)}%/an<br>
                    ‚Ä¢ √âvolution loyers : +1%/an<br>
                    ‚Ä¢ Vacance locative : 10%<br>
                    ‚Ä¢ Patrimoine 10 ans : <strong>${pessimiste.patrimoine10ans.toLocaleString()}‚Ç¨</strong>
                </div>
            `;
        }

        function calculerScenario(data, croissancePrix, croissanceLoyers, tauxVacance) {
            const annees = 10;
            let cashflowCumule = 0;
            
            // Calcul ann√©e par ann√©e
            for (let i = 1; i <= annees; i++) {
                const loyersAnnee = data.loyersAnnuels * Math.pow(1 + croissanceLoyers/100, i);
                const loyersReels = loyersAnnee * (1 - tauxVacance/100); // Impact vacance
                const chargesAnnee = data.chargesAnnuelles * Math.pow(1.025, i); // +2.5%/an
                
                let mensualitesAnnee = data.mensualite * 12;
                // Fin du cr√©dit
                if (i > parseInt(document.getElementById('dureeEmprunt').value)) {
                    mensualitesAnnee = 0;
                }
                
                cashflowCumule += loyersReels - chargesAnnee - mensualitesAnnee;
            }
            
            const valeurBien10ans = data.prixTotal * Math.pow(1 + croissancePrix/100, annees);
            const patrimoine10ans = valeurBien10ans + cashflowCumule;
            const gainTotal = patrimoine10ans - parseFloat(document.getElementById('apport').value);
            
            return {
                gainTotal: Math.round(gainTotal),
                patrimoine10ans: Math.round(patrimoine10ans),
                cashflowCumule: Math.round(cashflowCumule)
            };
        }

        function genererGraphiques(data) {
            // Graphique 1: √âvolution patrimoniale
            genererGraphiquePatrimoine(data);
            
            // Graphique 2: Cash-flow mensuel
            genererGraphiqueCashflow(data);
            
            // Graphique 3: R√©partition rentabilit√©
            genererGraphiqueRentabilite(data);
            
            // Graphique 4: Projection long terme
            genererGraphiqueLongTerme(data);
        }

        function genererGraphiquePatrimoine(data) {
            const ctx = document.getElementById('projectionChart');
            if(projectionChart) projectionChart.destroy();
            
            const labels = [];
            const valeurBien = [];
            const cashflowCumule = [];
            const patrimoineTotal = [];
            
            const donneesVille = villesData[document.getElementById('ville').value];
            const croissance = donneesVille ? donneesVille.croissancePrix : 2;
            
            for (let annee = 0; annee <= 20; annee++) {
                labels.push(annee);
                
                // Valeur du bien
                const valeur = data.prixTotal * Math.pow(1 + croissance/100, annee);
                valeurBien.push(Math.round(valeur));
                
                // Cash-flow cumul√©
                let cashflow = 0;
                for (let i = 1; i <= annee; i++) {
                    const loyersAnnuels = data.loyersAnnuels * Math.pow(1.02, i);
                    const chargesAnnuelles = data.chargesAnnuelles * Math.pow(1.025, i);
                    const mensualites = i <= parseInt(document.getElementById('dureeEmprunt').value) ? 
                                      data.mensualite * 12 : 0;
                    cashflow += (loyersAnnuels - chargesAnnuelles - mensualites) * 0.95;
                }
                cashflowCumule.push(Math.round(cashflow));
                patrimoineTotal.push(Math.round(valeur + cashflow));
            }
            
            projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valeur du bien',
                        data: valeurBien,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true
                    }, {
                        label: 'Cash-flow cumul√©',
                        data: cashflowCumule,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true
                    }, {
                        label: 'Patrimoine total',
                        data: patrimoineTotal,
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '√âvolution Patrimoniale sur 20 ans'
                        }
                    }
                }
            });
        }

        function genererGraphiqueCashflow(data) {
            const ctx = document.getElementById('cashflowChart');
            if(cashflowChart) cashflowChart.destroy();
            
            const labels = [];
            const cashflowData = [];
            const dureeCredit = parseInt(document.getElementById('dureeEmprunt').value);
            
            for (let annee = 1; annee <= 20; annee++) {
                labels.push(`Ann√©e ${annee}`);
                
                const loyersAnnuels = data.loyersAnnuels * Math.pow(1.02, annee);
                const chargesAnnuelles = data.chargesAnnuelles * Math.pow(1.025, annee);
                const mensualites = annee <= dureeCredit ? data.mensualite * 12 : 0;
                
                const cashflowAnnuel = (loyersAnnuels - chargesAnnuelles - mensualites) * 0.95;
                cashflowData.push(Math.round(cashflowAnnuel));
            }
            
            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cash-flow annuel',
                        data: cashflowData,
                        backgroundColor: cashflowData.map(value => 
                            value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                        ),
                        borderColor: cashflowData.map(value => 
                            value >= 0 ? '#28a745' : '#dc3545'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cash-flow Annuel - Impact Fin de Cr√©dit'
                        }
                    }
                }
            });
        }

        function genererGraphiqueRentabilite(data) {
            const ctx = document.getElementById('rentabiliteChart');
            if(rentabiliteChart) rentabiliteChart.destroy();
            
            const loyersAnnuels = data.loyersAnnuels;
            const chargesAnnuelles = data.chargesAnnuelles;
            const interets = (data.mensualite * 12) - (data.montantEmprunte / parseInt(document.getElementById('dureeEmprunt').value));
            const beneficeNet = loyersAnnuels - chargesAnnuelles - interets;
            
            rentabiliteChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Loyers nets', 'Charges annuelles', 'Int√©r√™ts cr√©dit', 'B√©n√©fice net'],
                    datasets: [{
                        data: [loyersAnnuels, chargesAnnuelles, Math.max(0, interets), Math.max(0, beneficeNet)],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545', 
                            '#ffc107',
                            '#667eea'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'R√©partition des Revenus Locatifs'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = ((value / loyersAnnuels) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()}‚Ç¨ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function genererGraphiqueLongTerme(data) {
            const ctx = document.getElementById('longTermChart');
            if(longTermChart) longTermChart.destroy();
            
            const donneesVille = villesData[document.getElementById('ville').value];
            
            // 3 sc√©narios sur 25 ans
            const annees = Array.from({length: 26}, (_, i) => i);
            
            const optimiste = annees.map(annee => {
                const valeur = data.prixTotal * Math.pow(1.035, annee); // +3.5%/an
                return Math.round(valeur);
            });
            
            const realiste = annees.map(annee => {
                const croissance = donneesVille ? donneesVille.croissancePrix : 2;
                const valeur = data.prixTotal * Math.pow(1 + croissance/100, annee);
                return Math.round(valeur);
            });
            
            const pessimiste = annees.map(annee => {
                const valeur = data.prixTotal * Math.pow(1.01, annee); // +1%/an
                return Math.round(valeur);
            });
            
            longTermChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: annees,
                    datasets: [{
                        label: 'Sc√©nario optimiste (+3.5%/an)',
                        data: optimiste,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: false,
                        borderDash: [5, 5]
                    }, {
                        label: 'Sc√©nario r√©aliste',
                        data: realiste,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: false,
                        borderWidth: 3
                    }, {
                        label: 'Sc√©nario pessimiste (+1%/an)',
                        data: pessimiste,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: false,
                        borderDash: [2, 2]
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '‚Ç¨';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Projection Valeur du Bien sur 25 ans'
                        }
                    }
                }
            });
        }

        function exporterPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuration
            const ville = document.getElementById('ville').value;
            const nomVille = villesData[ville] ? villesData[ville].nom : ville;
            const prix = parseFloat(document.getElementById('prix').value).toLocaleString();
            const surface = document.getElementById('surface').value;
            const loyer = parseFloat(document.getElementById('loyerMensuel').value).toLocaleString();
            
            // En-t√™te
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('RAPPORT D\'INVESTISSEMENT IMMOBILIER', 20, 30);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Bien situ√© √† ${nomVille}`, 20, 45);
            doc.text(`Prix: ${prix}‚Ç¨ - Surface: ${surface}m¬≤ - Loyer: ${loyer}‚Ç¨/mois`, 20, 55);
            doc.text(`Rapport g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 20, 65);
            
            // Ligne de s√©paration
            doc.setLineWidth(0.5);
            doc.line(20, 75, 190, 75);
            
            // R√©cup√©ration des r√©sultats
            const scoreElement = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            
            if (scoreElement && scoreText) {
                doc.setFontSize(16);
                doc.setTextColor(102, 126, 234);
                doc.text('SCORE D\'INVESTISSEMENT', 20, 95);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Score IA: ${scoreElement.textContent}/100 - ${scoreText.textContent}`, 20, 110);
            }
            
            // M√©triques principales
            const metricsCards = document.querySelectorAll('.metric-card h3');
            if (metricsCards.length >= 4) {
                doc.setFontSize(14);
                doc.setTextColor(102, 126, 234);
                doc.text('M√âTRIQUES CL√âS', 20, 130);
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                let yPos = 145;
                
                const metriques = [
                    `Rentabilit√© brute: ${metricsCards[0].textContent}`,
                    `Rentabilit√© nette: ${metricsCards[1].textContent}`,
                    `Rentabilit√© r√©elle: ${metricsCards[2].textContent}`,
                    `Cash-flow mensuel: ${metricsCards[3].textContent}`
                ];
                
                metriques.forEach(metrique => {
                    doc.text(`‚Ä¢ ${metrique}`, 25, yPos);
                    yPos += 12;
                });
            }
            
            // Projections
            const projections = document.querySelectorAll('.projection-item');
            if (projections.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(102, 126, 234);
                doc.text('PROJECTIONS PATRIMONIALES', 20, 210);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                let yPos = 225;
                
                projections.forEach((proj, index) => {
                    if (index < 3) { // Limiter √† 3 projections
                        const annee = proj.querySelector('h4').textContent;
                        const valeur = proj.querySelector('.valeur').textContent;
                        const cashflow = proj.querySelector('.cashflow').textContent;
                        
                        doc.text(`${annee}: Valeur ${valeur} - ${cashflow}`, 25, yPos);
                        yPos += 10;
                    }
                });
            }
            
            // Pied de page
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Simulateur Immobilier Pro - Donn√©es indicatives', 20, 280);
            doc.text('√Ä des fins d\'estimation uniquement', 20, 290);
            
            // T√©l√©chargement
            doc.save(`rapport-investissement-${nomVille}-${new Date().toISOString().split('T')[0]}.pdf`);
            
            // Message de confirmation
            alert('üìÑ Rapport PDF g√©n√©r√© avec succ√®s !');
        }

        function sauvegarderLocalement() {
            const donnees = {
                ville: document.getElementById('ville').value,
                prix: document.getElementById('prix').value,
                surface: document.getElementById('surface').value,
                loyerMensuel: document.getElementById('loyerMensuel').value,
                apport: document.getElementById('apport').value,
                tauxEmprunt: document.getElementById('tauxEmprunt').value,
                dureeEmprunt: document.getElementById('dureeEmprunt').value,
                fraisAgence: document.getElementById('fraisAgence').value,
                travaux: document.getElementById('travaux').value,
                mobilier: document.getElementById('mobilier').value,
                chargesAnnuelles: document.getElementById('chargesAnnuelles').value,
                typeLocation: document.getElementById('typeLocation').value,
                dateSauvegarde: new Date().toLocaleString('fr-FR')
            };
            
            localStorage.setItem('simulateur-immobilier-data', JSON.stringify(donnees));
            alert('üíæ Donn√©es sauvegard√©es avec succ√®s !');
        }

        function chargerDonneesSauvegardees() {
            const donnees = localStorage.getItem('simulateur-immobilier-data');
            if (donnees) {
                const data = JSON.parse(donnees);
                
                Object.keys(data).forEach(key => {
                    if (key !== 'dateSauvegarde') {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = data[key];
                        }
                    }
                });
                
                // Afficher le r√©cap de la ville apr√®s chargement
                if (data.ville) {
                    afficherRecapVille();
                }
                
                alert(`üìÇ Donn√©es restaur√©es (sauvegard√© le ${data.dateSauvegarde})`);
            } else {
                alert('‚ùå Aucune sauvegarde trouv√©e');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-affichage du r√©cap ville
            document.getElementById('ville').addEventListener('change', afficherRecapVille);
            
            // Auto-estimation du loyer
            ['surface', 'typeLocation'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (document.getElementById('ville').value && document.getElementById('surface').value) {
                        estimerLoyer();
                    }
                });
            });
            
            // Bouton de chargement
            const btnCharger = document.createElement('button');
            btnCharger.type = 'button';
            btnCharger.className = 'btn btn-secondary';
            btnCharger.innerHTML = '<i class="fas fa-upload"></i> Charger sauvegarde';
            btnCharger.onclick = chargerDonneesSauvegardees;
            btnCharger.style.marginLeft = '10px';
            
            // Ajouter le bouton apr√®s le bouton sauvegarder
            const btnSauvegarder = document.querySelector('button[onclick="sauvegarderLocalement()"]');
            if (btnSauvegarder) {
                btnSauvegarder.parentNode.insertBefore(btnCharger, btnSauvegarder.nextSibling);
            }
        });

        // Styles CSS additionnels pour les nouvelles fonctionnalit√©s
        const additionalStyles = `
            <style>
                .ville-recap {
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                    padding: 20px;
                    border-radius: 15px;
                    margin: 20px 0;
                    border: 1px solid #dee2e6;
                }

                .ville-recap h4 {
                    color: #667eea;
                    margin-bottom: 15px;
                    font-size: 1.1rem;
                }

                .ville-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                    gap: 15px;
                    margin: 15px 0;
                }

                .ville-stat {
                    text-align: center;
                    padding: 10px;
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }

                .ville-stat .value {
                    font-weight: bold;
                    font-size: 1.1rem;
                    color: #667eea;
                }

                .ville-stat .label {
                    font-size: 0.8rem;
                    color: #666;
                    margin-top: 3px;
                }

                .ville-fourchettes {
                    background: white;
                    padding: 15px;
                    border-radius: 10px;
                    margin-top: 15px;
                }

                .ville-fourchettes h5 {
                    margin-bottom: 10px;
                    color: #495057;
                }

                .fourchette-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    font-size: 0.9rem;
                    line-height: 1.6;
                }

                .evolution-positive {
                    color: #28a745 !important;
                }

                .evolution-negative {
                    color: #dc3545 !important;
                }

                .data-source {
                    font-size: 0.75rem;
                    color: #6c757d;
                    text-align: center;
                    margin-top: 15px;
                    padding-top: 10px;
                    border-top: 1px solid #dee2e6;
                }

                .estimation-results {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    margin: 20px 0;
                }

                .estimation-header h4 {
                    color: white;
                    margin-bottom: 5px;
                }

                .estimation-grille {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 15px;
                    margin-top: 15px;
                }

                .estimation-card {
                    background: rgba(255,255,255,0.15);
                    padding: 15px;
                    border-radius: 10px;
                    text-align: center;
                    backdrop-filter: blur(10px);
                }

                .estimation-card .montant {
                    font-size: 1.4rem;
                    font-weight: bold;
                    margin-bottom: 5px;
                }

                .estimation-card .type {
                    font-size: 0.9rem;
                    opacity: 0.9;
                }

                .calculation-explanation {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 15px;
                    margin-top: 20px;
                    border-left: 4px solid #667eea;
                }

                .calculation-explanation h5 {
                    color: #667eea;
                    margin-bottom: 15px;
                }

                .calculation-explanation ul {
                    list-style: none;
                    padding-left: 0;
                }

                .calculation-explanation li {
                    margin-bottom: 10px;
                    padding: 8px 0;
                    border-bottom: 1px solid #e9ecef;
                    font-size: 0.95rem;
                }

                .recommendation-item {
                    padding: 15px;
                    margin: 10px 0;
                    border-radius: 10px;
                    font-size: 0.95rem;
                    line-height: 1.5;
                }

                .recommendation-item.success {
                    background: #d4edda;
                    color: #155724;
                    border: 1px solid #c3e6cb;
                }

                .recommendation-item.warning {
                    background: #fff3cd;
                    color: #856404;
                    border: 1px solid #ffeaa7;
                }

                .recommendation-item.error {
                    background: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                }

                .recommendation-item.info {
                    background: #d1ecf1;
                    color: #0c5460;
                    border: 1px solid #bee5eb;
                }

                @media (max-width: 768px) {
                    .ville-stats {
                        grid-template-columns: repeat(2, 1fr);
                    }
                    
                    .estimation-grille {
                        grid-template-columns: 1fr;
                    }
                    
                    .fourchette-row {
                        grid-template-columns: 1fr;
                    }
                }
            </style>
        `;

        document.head.insertAdjacentHTML('beforeend', additionalStyles);

    </script>
</body>
</html>
